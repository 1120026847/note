<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>极简笔记 · 富文本 + COS（修复保存副本 & 可编辑）</title>

<!-- CloudBase Auth -->
<script src="https://static.cloudbase.net/cloudbase-js-sdk/2.21.6/cloudbase.full.js"></script>
<!-- COS JS SDK -->
<script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>

<!-- Quill -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css"/>
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>

<!-- DOMPurify -->
<script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

<!-- PDF.js -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js";</script>

<!-- JSZip -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
:root{
  --bg:#f8fafc; --card:#ffffff; --border:#e5e7eb; --muted:#6b7280; --text:#0f172a; --accent:#111827;
  --danger:#b91c1c; --radius:14px; --drop:#eef2ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Inter,Roboto,Arial}
.app{display:grid;grid-template-columns:300px 1fr;gap:12px;width:100vw;min-height:100vh;padding:0 0 8px 0}

/* 左侧 */
.sidebar{display:flex;flex-direction:column;gap:12px;border:1px solid var(--border);border-radius:var(--radius);background:#fff;padding:12px;min-height:calc(100vh - 8px)}
.brand{border:2px solid var(--accent);border-radius:12px;padding:14px 10px;font-weight:800;font-size:22px;text-align:center}
.btn{border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.secondary{background:#fff;color:var(--text);border-color:var(--border)}
.btn.ghost{background:transparent;color:#111827;border-color:var(--border)}
.btn.danger{background:var(--danger);border-color:var(--danger)}
.btn.sm{padding:6px 10px;border-radius:8px}
.blockbtns{display:flex;gap:10px}.blockbtns .btn{flex:1}

.sectionTitle{font-weight:700;margin:6px 2px 6px}
.list{list-style:none;margin:0;padding:0;border:1px solid var(--border);border-radius:12px;overflow-y:auto;overflow-x:hidden;max-height:36vh;min-height:120px;background:#fff}
.item{padding:12px 10px;border-top:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center;gap:8px}
.item:first-child{border-top:0}.item .name{font-size:14px}.item.active{background:#f3f4f6}

details.group{border:1px solid var(--border);border-radius:12px;background:#fff}
details.group>summary{cursor:pointer;padding:10px 12px;font-weight:600;border-radius:12px}
details.group>ul{margin:0;border-top:1px solid #f1f5f9}

.dataFoot{margin-top:auto}
.dataBtn{width:100%;text-align:center;border:1px dashed var(--border);border-radius:12px;padding:12px;cursor:pointer;background:#fff}
.dataBtn:hover{background:#f9fafb}
.muted{color:var(--muted);font-size:12px}

/* 顶部（账户 + 单组按钮） */
.contentWrap{display:flex;flex-direction:column;gap:10px}
.topbar{display:grid;grid-template-columns:1fr;grid-template-rows:auto auto;gap:6px;border:1px solid var(--border);border-radius:var(--radius);background:#fff;padding:8px 10px}
.topbarRow{display:flex;justify-content:flex-end;align-items:center}
.account{position:relative}
.accountBtn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer;min-width:180px;text-align:right}
.accountMenu{position:absolute;right:0;top:calc(100% + 6px);background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.08);display:none;min-width:180px;z-index:5}
.accountMenu.open{display:block}.accountMenu .item{padding:10px 12px;cursor:pointer}.accountMenu .item:hover{background:#f3f4f6}
.actions{display:flex;justify-content:flex-end;gap:10px;position:sticky;top:6px;z-index:3;background:#fff;padding-top:4px}

/* 内容 */
.contentCard{flex:1;border:2px dashed var(--border);border-radius:16px;background:#fff;padding:12px;min-height:70vh;position:relative}
.toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
.titleInput{min-width:260px;width:420px}
input{font:inherit;border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff}

/* Quill */
#editorWrap{border:1px dashed var(--border);border-radius:12px;background:#fff;display:flex;flex-direction:column;min-height:480px;height:calc(70vh - 70px);overflow:hidden}
#toolbar{border-bottom:1px solid var(--border)}
#editor{flex:1;overflow:auto}
.ql-container{font-size:16px}
.ql-editor{min-height:100%;line-height:1.6}
.ql-editor img{max-width:100%;border-radius:8px}

/* PDF */
.pdf-toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:10px 0}
.pdf-canvas-wrap{display:flex;justify-content:center;align-items:center;background:#fff;border:1px dashed var(--border);border-radius:12px;padding:8px;min-height:400px;overflow:auto}
.hidden{display:none !important}

/* 拖拽遮罩 */
.drop-mask{position:absolute;inset:0;border-radius:16px;border:2px dashed #818cf8;background:var(--drop);display:none;align-items:center;justify-content:center;color:#4338ca;font-weight:600;font-size:16px}
.contentCard.dragover .drop-mask{display:flex}

/* 底部弹层 */
.sheet{position:fixed;left:50%;transform:translateX(-50%);bottom:-320px;transition:bottom .25s ease;z-index:40;background:#fff;border:1px solid var(--border);border-radius:16px 16px 0 0;box-shadow:0 -10px 30px rgba(0,0,0,.12);padding:14px;min-width:520px}
.sheet.open{bottom:0}.sheet .title{font-weight:700;margin-bottom:8px}.sheet .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.sheet .opt{border:1px solid var(--border);border-radius:12px;padding:12px;cursor:pointer;text-align:center;background:#fff}
.sheet .opt:hover{background:#f9fafb}.sheet .desc{margin-top:8px;color:var(--muted)}
</style>
</head>
<body>

<div class="app">
  <!-- 侧边栏 -->
  <aside class="sidebar">
    <div class="brand">网站名</div>
    <div class="blockbtns">
      <button id="btnNewNote" class="btn">新建文章</button>
      <button id="btnNewFolder" class="btn secondary">新建文件夹</button>
    </div>

    <div class="sectionTitle">未分类文章</div>
    <ul id="uncatList" class="list"></ul>
    <div id="uncatState" class="muted"></div>

    <div class="sectionTitle" style="margin-top:10px">文件夹</div>
    <div id="folderGroups" style="display:flex;flex-direction:column;gap:10px;max-height:32vh;overflow-y:auto;overflow-x:hidden"></div>

    <div class="dataFoot"><div id="btnData" class="dataBtn">数据区</div></div>
  </aside>

  <!-- 内容 -->
  <section class="contentWrap">
    <div class="topbar">
      <div class="topbarRow">
        <div class="account">
          <div id="accountBtn" class="accountBtn">未登录</div>
          <div id="accountMenu" class="accountMenu"><div id="menuLogout" class="item">退出登录</div></div>
        </div>
      </div>
      <div class="actions">
        <button id="btnEdit" class="btn secondary sm">编辑</button>
        <button id="btnSave" class="btn sm">保存</button>
        <button id="btnSync" class="btn secondary sm">同步</button>
      </div>
    </div>

    <div id="contentCard" class="contentCard">
      <div id="noteBox">
        <div class="toolbar">
          <div style="display:flex;align-items:center;gap:8px">
            <input id="noteTitle" class="titleInput" placeholder="请输入标题…"/>
            <span id="fileHint" class="muted"></span>
          </div>
        </div>

        <div id="editorWrap">
          <div id="toolbar">
            <span class="ql-formats">
              <select class="ql-header"><option selected></option><option value="1"></option><option value="2"></option></select>
              <button class="ql-bold"></button><button class="ql-italic"></button><button class="ql-underline"></button><button class="ql-strike"></button>
            </span>
            <span class="ql-formats">
              <button class="ql-list" value="ordered"></button><button class="ql-list" value="bullet"></button>
              <button class="ql-blockquote"></button><button class="ql-code-block"></button>
            </span>
            <span class="ql-formats">
              <button class="ql-link"></button><button class="ql-image"></button><button class="ql-clean"></button>
            </span>
          </div>
          <div id="editor"></div>
        </div>
        <input id="pickImage" type="file" accept="image/*" class="hidden" multiple/>
        <div id="saveState" class="muted" style="margin-top:6px"></div>
      </div>

      <!-- PDF 阅读器 -->
      <div id="pdfBox" class="hidden">
        <div class="pdf-toolbar">
          <div><button id="pdfPrev" class="btn secondary sm">上一页</button><button id="pdfNext" class="btn secondary sm">下一页</button><span id="pdfInfo" class="muted">-/-</span></div>
          <div><button id="pdfZoomOut" class="btn secondary sm">缩小</button><button id="pdfZoomIn" class="btn secondary sm">放大</button><a id="pdfOpenRaw" class="btn sm" target="_blank" href="#">打开原文件</a></div>
        </div>
        <div class="pdf-canvas-wrap"><canvas id="pdfCanvas"></canvas></div>
      </div>

      <div id="dropMask" class="drop-mask">松开即可上传（图片或 PDF）到 COS</div>
    </div>
  </section>
</div>

<!-- 数据区弹层 -->
<div id="dataSheet" class="sheet">
  <div class="title">数据区</div>
  <div class="grid">
    <div id="optImportPdf" class="opt">导入 PDF</div>
    <div id="optImportAll" class="opt">导入所有数据（ZIP）</div>
    <div id="optExportAll" class="opt">导出所有数据（ZIP）</div>
  </div>
  <div class="desc">导入：zip 内含 .md/.txt/.html；导出：把 COS 的笔记打包下载。</div>
</div>

<!-- 隐藏选择器 -->
<input id="pickPdf" type="file" accept="application/pdf" class="hidden"/>
<input id="pickZip" type="file" accept=".zip" class="hidden"/>

<!-- 登录弹层 -->
<div id="authModal" class="sheet" style="min-width:420px">
  <div class="title">登录 / 注册</div>
  <div style="display:flex;gap:8px"><input id="email" placeholder="邮箱" style="flex:1"/><input id="password" type="password" placeholder="密码" style="flex:1"/></div>
  <div style="display:flex;gap:8px;margin-top:8px"><button id="btnSignIn" class="btn" style="flex:1">登录</button><button id="btnSignUp" class="btn secondary" style="flex:1">注册</button><button id="btnCloseAuth" class="btn ghost" style="flex:1">关闭</button></div>
  <div id="authState" class="muted" style="margin-top:6px"></div>
</div>

<script>
/* ====== 环境变量（换成你的） ====== */
const CLOUDBASE_ENV = "molijun-0gtahyghc6271173";  // TODO
const STS_URL       = "https://molijun-0gtahyghc6271173-1317231591.ap-shanghai.app.tcloudbase.com/api/sts"; // TODO
const AUTO_EDIT_ON_OPEN = true;

/* ====== 初始化 ====== */
const app  = cloudbase.init({ env: CLOUDBASE_ENV });
const auth = app.auth();
const $ = id => document.getElementById(id);

const ui = {
  // 左
  uncatList: $("uncatList"), uncatState: $("uncatState"), folderGroups: $("folderGroups"),
  btnNewNote: $("btnNewNote"), btnNewFolder: $("btnNewFolder"), btnData: $("btnData"),
  // 顶部
  accountBtn: $("accountBtn"), accountMenu: $("accountMenu"), menuLogout: $("menuLogout"),
  btnEdit: $("btnEdit"), btnSave: $("btnSave"), btnSync: $("btnSync"),
  // 内容
  contentCard: $("contentCard"), noteBox: $("noteBox"), pdfBox: $("pdfBox"),
  noteTitle: $("noteTitle"), fileHint: $("fileHint"), saveState: $("saveState"),
  editorEl: $("editor"), toolbarEl: $("toolbar"), pickImage: $("pickImage"),
  dropMask: $("dropMask"),
  // PDF
  pdfPrev: $("pdfPrev"), pdfNext: $("pdfNext"), pdfZoomOut: $("pdfZoomOut"), pdfZoomIn: $("pdfZoomIn"),
  pdfInfo: $("pdfInfo"), pdfOpenRaw: $("pdfOpenRaw"), pdfCanvas: $("pdfCanvas"),
  // 数据
  dataSheet: $("dataSheet"), optImportPdf: $("optImportPdf"), optImportAll: $("optImportAll"), optExportAll: $("optExportAll"),
  pickPdf: $("pickPdf"), pickZip: $("pickZip"),
  // 登录
  authModal: $("authModal"), email: $("email"), password: $("password"),
  btnSignIn: $("btnSignIn"), btnSignUp: $("btnSignUp"), btnCloseAuth: $("btnCloseAuth"), authState: $("authState"),
};

/* ====== 全局状态 ====== */
let currentUID = null;
let openedNoteKey = null;

/* ====== Quill（官方 API：enable/disable/insertEmbed 等） ====== */
const quill = new Quill(ui.editorEl, {
  theme: 'snow',
  modules: { toolbar: ui.toolbarEl },
  placeholder: '在此编辑，可粘贴/拖拽图片（自动上传 COS 并插入）…'
});
quill.enable(false); // 打开笔记后再决定
quill.getModule('toolbar').addHandler('image', () => ui.pickImage.click()); // 工具栏「图片」

/* ====== 小工具 ====== */
function pad2(n){return n<10?("0"+n):""+n}
function ts(){ const d=new Date(); return d.getFullYear()+pad2(d.getMonth()+1)+pad2(d.getDate())+"_"+pad2(d.getHours())+pad2(d.getMinutes())+pad2(d.getSeconds());}
function sanitizeFileName(s){ return (s||"未命名").replace(/[\\/:*?"<>|\s]+/g,"_").slice(0,80); }
function getEditorHTML(){ return quill.root.innerHTML || ""; }
function setEditorHTML(html){ quill.setContents([]); quill.clipboard.dangerouslyPasteHTML(DOMPurify.sanitize(html||"")); } // 先清洗再注入
function setEditorText(text){ quill.setText(text || ""); }
function highlightActive(key){ document.querySelectorAll(".item").forEach(li=> li.classList.toggle("active", li.dataset.key===key)); }

/* ====== 登录流程 ====== */
async function ensureLogin(){
  const st = await auth.getLoginState();
  if(!st?.user) throw new Error("尚未登录");
  return st.user;
}
(async ()=>{
  try{
    const st = await auth.getLoginState();
    if(st?.user){ currentUID = st.user.uid; ui.accountBtn.textContent = st.user.email || st.user.uid; refreshLists(); }
    else{ currentUID=null; ui.accountBtn.textContent="未登录"; openAuthSheet(); }
  }catch{}
})();
function openAuthSheet(){ ui.authModal.classList.add("open"); }
ui.btnCloseAuth.onclick = ()=> ui.authModal.classList.remove("open");
ui.btnSignIn.onclick = async ()=>{
  try{
    const st = await auth.signIn({ username: ui.email.value.trim(), password: ui.password.value.trim() });
    currentUID = st.user.uid; ui.accountBtn.textContent = st.user.email || st.user.uid;
    ui.authState.textContent="登录成功"; ui.authModal.classList.remove("open"); refreshLists();
  }catch(e){ ui.authState.textContent="登录失败："+(e?.message||e); }
};
ui.btnSignUp.onclick = async ()=>{
  try{
    const st = await auth.signUp({ username: ui.email.value.trim(), password: ui.password.value.trim() });
    currentUID = st.user.uid; ui.accountBtn.textContent = st.user.email || st.user.uid;
    ui.authState.textContent="注册成功"; ui.authModal.classList.remove("open"); refreshLists();
  }catch(e){ ui.authState.textContent="注册失败："+(e?.message||e); }
};
ui.accountBtn.onclick = ()=> ui.accountMenu.classList.toggle("open");
document.addEventListener("click",(e)=>{
  if(!ui.accountBtn.contains(e.target) && !ui.accountMenu.contains(e.target)) ui.accountMenu.classList.remove("open");
});
ui.menuLogout.onclick = async ()=>{
  try{ await auth.signOut(); currentUID=null; ui.accountBtn.textContent="未登录"; clearUIAll(); }
  catch(e){ alert("退出失败："+(e?.message||e)); }
};

/* ====== STS / COS ====== */
let stsCache=null, cos=null;
async function fetchSTS(uid){
  const r = await fetch(`${STS_URL}?uid=${encodeURIComponent(uid)}`,{ headers:{ "x-user-uid": uid }});
  if(!r.ok) throw new Error("STS 获取失败");
  const j = await r.json();
  if(!j?.credentials?.tmpSecretId) throw new Error("STS 响应不完整");
  return j;
}
async function ensureCOS(){
  const { uid } = await ensureLogin();
  const now = Math.floor(Date.now()/1000);
  if(!stsCache || !stsCache.expiredTime || (now+60)>=Number(stsCache.expiredTime)){
    stsCache = await fetchSTS(uid);
    cos = new COS({ getAuthorization:(_,cb)=> {
      const c = stsCache.credentials;
      cb({ TmpSecretId:c.tmpSecretId, TmpSecretKey:c.tmpSecretKey, SecurityToken:c.sessionToken,
           StartTime:Number(stsCache.startTime), ExpiredTime:Number(stsCache.expiredTime) });
    }});
  }
  return { cos, bucket: stsCache.bucket, region: stsCache.region, uid };
}

/* ====== 列表 ====== */
function clearListsUI(){ ui.uncatList.innerHTML=""; ui.uncatState.textContent=""; ui.folderGroups.innerHTML=""; }
async function refreshLists(){
  clearListsUI();
  ui.uncatState.textContent = "加载中…";
  try{
    const { cos, bucket, region, uid } = await ensureCOS();
    const data = await new Promise((res,rej)=> cos.getBucket({Bucket:bucket,Region:region,Prefix:`${uid}/`,MaxKeys:1000},(e,d)=>e?rej(e):res(d)));
    const all = (data?.Contents||[]).filter(o => /\.(md|txt|html)$/i.test(o.Key));

    const uncat = []; const byFolder = {};
    for(const o of all){
      const rel = o.Key.slice((uid+"/").length);
      const seg = rel.split("/");
      const isSystem = seg[0]==="assets" || seg[0]==="imported";
      if(isSystem) continue;
      if(seg.length===1){ uncat.push(o); }
      else{ (byFolder[seg[0]] ||= []).push(o); }
    }
    uncat.sort((a,b)=> new Date(b.LastModified)-new Date(a.LastModified));
    for(const k in byFolder) byFolder[k].sort((a,b)=> new Date(b.LastModified)-new Date(a.LastModified));

    renderList(ui.uncatList, uncat, openNote);
    ui.uncatState.textContent = `共 ${uncat.length} 篇`;

    const folders = Object.keys(byFolder).sort();
    if(!folders.length){
      const empty = document.createElement("div");
      empty.className="muted"; empty.style.padding="6px 2px"; empty.textContent="暂无文件夹";
      ui.folderGroups.appendChild(empty);
    }else{
      for(const name of folders){
        const det = document.createElement("details"); det.className="group";
        const sum = document.createElement("summary"); sum.textContent = `${name}  (${byFolder[name].length})`;
        const ul = document.createElement("ul"); ul.className="list"; ul.style.maxHeight="24vh";
        renderList(ul, byFolder[name], openNote);
        det.append(sum,ul); ui.folderGroups.appendChild(det);
      }
    }
  }catch(e){ ui.uncatState.textContent = "失败：" + (e?.message||e); }
}
function renderList(target, objs, openFn){
  target.innerHTML="";
  if(!objs.length){ target.innerHTML="<li class='muted' style='padding:10px'>暂无</li>"; return; }
  for(const o of objs){
    const li = document.createElement("li"); li.className="item"; li.dataset.key=o.Key;
    const name = o.Key.split("/").pop();
    li.innerHTML = `<div class="name mono">${name}</div><button class="btn secondary sm open">打开</button>`;
    li.onclick = ()=> openFn(o);
    target.appendChild(li);
  }
}

/* ====== 打开 / 编辑 / 保存 / 同步 ====== */
function clearNoteUI(){ openedNoteKey=null; quill.setContents([]); quill.enable(false); ui.noteTitle.value=""; ui.fileHint.textContent=""; ui.saveState.textContent=""; highlightActive(""); }
function clearPdfUI(){ pdfDoc=null; pdfUrl=null; pdfTotal=0; pdfPage=1; pdfScale=1.15; ui.pdfBox.classList.add("hidden"); }
function clearUIAll(){ clearNoteUI(); clearPdfUI(); clearListsUI(); }

ui.btnEdit.onclick = enterEdit;
ui.btnSave.onclick = saveNote;
ui.btnSync.onclick = syncNow;

async function openNote(obj){
  try{
    showNoteUI();
    const { cos, bucket, region } = await ensureCOS();
    const d = await new Promise((res,rej)=> cos.getObject({Bucket:bucket,Region:region,Key:obj.Key},(e,r)=>e?rej(e):res(r)));
    const text = d.Body instanceof Blob ? await d.Body.text() : (typeof d.Body==="string"?d.Body:new TextDecoder().decode(d.Body));
    openedNoteKey = obj.Key;
    const name = obj.Key.split("/").pop();
    ui.noteTitle.value = name.replace(/\.(md|txt|html)$/i,"");
    ui.fileHint.textContent = name;

    if(/\.html$/i.test(name)){ setEditorHTML(text); } else { setEditorText(text); }
    if (AUTO_EDIT_ON_OPEN) { enterEdit(); } else { quill.enable(false); ui.saveState.textContent = "只读，点「编辑」开始修改"; }
    highlightActive(obj.Key);
  }catch(e){ alert("读取失败："+(e?.message||e)); }
}

/** 进入编辑（官方 API：enable(true)） */
function enterEdit(){
  quill.enable(true);  // quill.enable(true/false) 来控制编辑态（Quill 官方 API）  :contentReference[oaicite:4]{index=4}
  quill.focus();
  ui.saveState.textContent="编辑中…（Ctrl/⌘+S 保存）";
}

/** 保存：覆盖或迁移，不产生副本；保持编辑态 */
document.addEventListener("keydown",(e)=>{
  const k = e.key.toLowerCase();
  if((e.ctrlKey||e.metaKey) && k==="s"){ e.preventDefault(); saveNote(); }
  if((e.ctrlKey||e.metaKey) && k==="e"){ e.preventDefault(); enterEdit(); }
});
ui.editorEl.addEventListener("dblclick", enterEdit);

async function saveNote(){
  const html = getEditorHTML();
  const blob = new Blob([html], { type:"text/html;charset=utf-8" });
  ui.saveState.textContent = "保存中…";

  try{
    const { cos, bucket, region, uid } = await ensureCOS();

    // 计算目标 key：同目录，同名 .html；无打开文件则用时间戳
    let oldKey = openedNoteKey;
    const safeTitle = sanitizeFileName(ui.noteTitle.value || "未命名");
    let dir = `${uid}/`;
    if(oldKey && oldKey.includes("/")) dir = oldKey.slice(0, oldKey.lastIndexOf("/")+1);

    let newKey;
    if(!oldKey){
      newKey = `${dir}${ts()}_${safeTitle}.html`; // 新建
    }else{
      const oldName = oldKey.split("/").pop();
      const oldBase = oldName.replace(/\.(md|txt|html)$/i,"");
      const needHtml = !/\.html$/i.test(oldName);
      const needRename = (oldBase !== safeTitle);
      if(needHtml || needRename){
        newKey = `${dir}${safeTitle}.html`;      // 迁移/重命名为 .html
      }else{
        newKey = oldKey;                         // 覆盖
      }
    }

    // 上传到 newKey
    await new Promise((res,rej)=> cos.putObject({Bucket:bucket,Region:region,Key:newKey,Body:blob},(e,d)=>e?rej(e):res(d)));

    // 若 oldKey 存在且改变了，删除旧文件，指向新文件
    if(oldKey && newKey !== oldKey){
      try{ await new Promise((res,rej)=> cos.deleteObject({Bucket:bucket,Region:region,Key:oldKey},(e,d)=>e?rej(e):res(d))); }catch{}
      openedNoteKey = newKey;
    }else{
      openedNoteKey = newKey;
    }

    ui.fileHint.textContent = newKey.split("/").pop();
    ui.saveState.textContent="已保存（保持编辑）";
    quill.enable(true); // 保持编辑态
    refreshLists(); highlightActive(openedNoteKey);
  }catch(e){
    ui.saveState.textContent = "失败：" + (e?.message||e);
  }
}

async function syncNow(){ await refreshLists(); if(openedNoteKey){ await openNote({Key:openedNoteKey}); } }

/* ====== 图片：粘贴/拖拽/选择 -> COS -> insertEmbed ====== */
["dragenter","dragover"].forEach(ev=> ui.contentCard.addEventListener(ev, e=>{ e.preventDefault(); ui.contentCard.classList.add("dragover"); }));
["dragleave","drop"].forEach(ev=> ui.contentCard.addEventListener(ev, e=>{ e.preventDefault(); if(ev==="drop") onDrop(e); ui.contentCard.classList.remove("dragover"); }));

async function onDrop(e){
  const files = Array.from(e.dataTransfer?.files||[]);
  const imgs = files.filter(f=> f.type.startsWith("image/"));
  const pdfs = files.filter(f=> f.type==="application/pdf");
  if(imgs.length) await handleImageFiles(imgs);
  if(pdfs.length) await handlePdfFiles(pdfs);
}
ui.pickImage.onchange = async e=>{
  const files = Array.from(e.target.files || []);
  if(files.length) await handleImageFiles(files);
  e.target.value="";
};
ui.editorEl.addEventListener("paste", async (e)=>{
  const items = e.clipboardData?.items ? Array.from(e.clipboardData.items) : [];
  const imgItems = items.filter(it=> it.kind==="file" && it.type.startsWith("image/"));
  if(!imgItems.length) return;
  e.preventDefault();
  const files = await Promise.all(imgItems.map(it=> it.getAsFile()));
  await handleImageFiles(files.filter(Boolean));
});

const IMAGE_MAX = 20*1024*1024;
async function handleImageFiles(files){
  const { cos, bucket, region, uid } = await ensureCOS();
  enterEdit();
  for(const f of files){
    if(!f.type.startsWith("image/")) continue;
    if(f.size>IMAGE_MAX){ ui.saveState.textContent=`图片过大：${f.name}`; continue; }
    const ext = (f.name.split(".").pop()||"png").toLowerCase();
    const key = `${uid}/assets/${new Date().getFullYear()}/${pad2(new Date().getMonth()+1)}/${ts()}_${sanitizeFileName(ui.noteTitle.value)}.${ext}`;
    await new Promise((res,rej)=> cos.uploadFile({Bucket:bucket,Region:region,Key:key,Body:f,SliceSize:1024*1024,onProgress:p=>ui.saveState.textContent=`上传中 ${f.name} ${(p.percent*100).toFixed(1)}%`},(e,d)=>e?rej(e):res(d)));
    // 预签名 URL（COS 官方文档：getObjectUrl 可生成访问链接）
    const url = await new Promise((res,rej)=> cos.getObjectUrl({Bucket:bucket,Region:region,Key:key,Sign:true},(e,r)=>e?rej(e):res(r.Url))); // :contentReference[oaicite:5]{index=5}
    // 插到光标处（Quill insertEmbed）
    const range = quill.getSelection(true) || { index: quill.getLength(), length: 0 };
    quill.insertEmbed(range.index, 'image', url, 'user');  // :contentReference[oaicite:6]{index=6}
    quill.setSelection(range.index + 1, 0, 'silent');
    ui.saveState.textContent = `图片已上传并插入：${f.name}`;
  }
}

/* ====== PDF 上传/阅读（PDF.js 标准流程） ====== */
let pdfDoc=null, pdfUrl=null, pdfPage=1, pdfTotal=0, pdfScale=1.15;
async function handlePdfFiles(files){
  for(const f of files){
    if(f.type!=="application/pdf") continue;
    const url = await uploadPdfToCOS(f);
    ui.saveState.textContent = `PDF 上传成功：${f.name}`;
    await openPdfByUrl(url);
  }
}
async function uploadPdfToCOS(file){
  const { cos, bucket, region, uid } = await ensureCOS();
  const key = `${uid}/assets/pdf/${new Date().getFullYear()}/${pad2(new Date().getMonth()+1)}/${ts()}_${sanitizeFileName(file.name.replace(/\.pdf$/i,""))}.pdf`;
  await new Promise((res,rej)=> cos.uploadFile({Bucket:bucket,Region:region,Key:key,Body:file,SliceSize:1024*1024,onProgress:p=>ui.saveState.textContent=`上传 PDF ${(p.percent*100).toFixed(1)}%`},(e,d)=>e?rej(e):res(d)));
  return await new Promise((res,rej)=> cos.getObjectUrl({Bucket:bucket,Region:region,Key:key,Sign:true},(e,r)=>e?rej(e):res(r.Url)));
}
function showNoteUI(){ ui.noteBox.classList.remove("hidden"); ui.pdfBox.classList.add("hidden"); }
function showPdfUI(){ ui.noteBox.classList.add("hidden"); ui.pdfBox.classList.remove("hidden"); }
async function openPdfByUrl(signedUrl){
  try{
    showPdfUI(); pdfUrl = signedUrl; ui.pdfOpenRaw.href = signedUrl;
    const task = pdfjsLib.getDocument({ url:signedUrl }); // PDF.js 示例流程  :contentReference[oaicite:7]{index=7}
    pdfDoc = await task.promise; pdfTotal = pdfDoc.numPages; pdfPage = 1; pdfScale = 1.15;
    await renderPdfPage(); ui.saveState.textContent="";
  }catch(e){ ui.saveState.textContent="PDF 加载失败："+(e?.message||e); }
}
async function renderPdfPage(){
  if(!pdfDoc) return;
  const page = await pdfDoc.getPage(pdfPage);
  const viewport = page.getViewport({ scale: pdfScale });
  const canvas = ui.pdfCanvas, ctx = canvas.getContext("2d");
  canvas.width = viewport.width; canvas.height = viewport.height;
  await page.render({ canvasContext: ctx, viewport }).promise;
  ui.pdfInfo.textContent = `${pdfPage} / ${pdfTotal}`;
}
ui.pdfPrev.onclick = ()=>{ if(pdfPage>1){ pdfPage--; renderPdfPage(); } };
ui.pdfNext.onclick = ()=>{ if(pdfPage<pdfTotal){ pdfPage++; renderPdfPage(); } };
ui.pdfZoomIn.onclick = ()=>{ pdfScale = Math.min(3, pdfScale+0.15); renderPdfPage(); };
ui.pdfZoomOut.onclick = ()=>{ pdfScale = Math.max(0.5, pdfScale-0.15); renderPdfPage(); };

/* ====== 数据区 ====== */
ui.btnData.onclick = ()=> ui.dataSheet.classList.toggle("open");
ui.optImportPdf.onclick = ()=> ui.pickPdf.click();
ui.pickPdf.onchange = async e=>{ const f=e.target.files?.[0]; if(f){ await handlePdfFiles([f]); } e.target.value=""; };

ui.optImportAll.onclick = ()=> ui.pickZip.click();
ui.pickZip.onchange = async e=>{
  const f = e.target.files?.[0]; if(!f) return; ui.saveState.textContent="解析 zip 中…";
  try{
    const zip = await JSZip.loadAsync(f);
    const entries = Object.values(zip.files).filter(z=> !z.dir && (/\.(md|txt|html)$/i).test(z.name));
    const { cos, bucket, region, uid } = await ensureCOS();
    let done=0;
    for(const ent of entries){
      const text = await ent.async("string");
      const key = `${uid}/imported/${sanitizeFileName(ent.name.replace(/^.*\//,""))}`;
      await new Promise((res,rej)=> cos.putObject({Bucket:bucket,Region:region,Key:key,Body:new Blob([text],{type:"text/html;charset=utf-8"})},(e,d)=>e?rej(e):res(d)));
      ui.saveState.textContent = `导入中 ${++done}/${entries.length}`;
    }
    ui.saveState.textContent = `导入完成，共 ${entries.length} 篇`; refreshLists();
  }catch(err){ ui.saveState.textContent="导入失败："+(err?.message||err); }
  e.target.value="";
};

/* ====== 新建文件夹 ====== */
ui.btnNewFolder.onclick = async ()=>{
  const name = prompt("请输入文件夹名称");
  if(!name) return;
  try{
    const { cos, bucket, region, uid } = await ensureCOS();
    const key = `${uid}/${sanitizeFileName(name)}/.keep`;
    await new Promise((res,rej)=> cos.putObject({Bucket:bucket,Region:region,Key:key,Body:new Blob([], {type:"text/plain"})},(e,d)=>e?rej(e):res(d)));
    alert("已创建文件夹：" + name);
    refreshLists();
  }catch(e){ alert("创建失败：" + (e?.message||e)); }
};
</script>
</body>
</html>
