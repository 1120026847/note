<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æç®€ç¬”è®°ï¼ˆCloudBase ç™»å½• + COS å­˜å‚¨ï¼‰</title>
  <!-- CloudBase JS SDK v2 -->
  <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.21.6/cloudbase.full.js"></script>
  <!-- COS JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto;max-width:860px;margin:24px auto;padding:0 12px}
    h1{font-size:22px;margin:0 0 12px}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,textarea,button{font:inherit}
    input,textarea{border:1px solid #d1d5db;border-radius:8px;padding:10px}
    input{width:240px}
    textarea{width:100%;min-height:120px}
    button{border:1px solid #111827;background:#111827;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    button.secondary{background:#fff;color:#111827;border-color:#d1d5db}
    .muted{color:#6b7280;font-size:12px}
    .list{list-style:none;padding:0;margin:0}
    .list li{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:8px 0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .hidden{display:none}
    .danger{background:#b91c1c;border-color:#b91c1c}
    .success{background:#065f46;border-color:#065f46}
  </style>
</head>
<body>
  <h1>ğŸ“ æç®€ç¬”è®°ï¼ˆCloudBase ç™»å½• + COS å­˜å‚¨ï¼‰</h1>

  <!-- è®¤è¯ -->
  <div class="card" id="authCard">
    <div class="row">
      <input id="email" type="email" placeholder="é‚®ç®±" />
      <input id="password" type="password" placeholder="å¯†ç ï¼ˆ8-32ä½ï¼‰" />
      <input id="emailCode" placeholder="é‚®ç®±éªŒè¯ç ï¼ˆæ³¨å†Œå¿…å¡«ï¼‰" />
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnSendCode">å‘é€éªŒè¯ç ï¼ˆæ³¨å†Œç”¨ï¼‰</button>
      <button id="btnSignUp">æ³¨å†Œ</button>
      <button id="btnSignIn" class="secondary">ç™»å½•</button>
      <button id="btnLogout" class="secondary hidden">é€€å‡ºç™»å½•</button>
    </div>
    <p class="muted">æ³¨å†Œï¼šå…ˆå‘é€éªŒè¯ç  â†’ é‚®ç®±å–ç  â†’ å¡«å…¥éªŒè¯ç  â†’ ç‚¹æ³¨å†Œã€‚æ³¨å†ŒæˆåŠŸä¼šè‡ªåŠ¨ç™»å½•ã€‚</p>
    <p class="mono" id="authState"></p>
  </div>

  <!-- æ–°å»º / ç¼–è¾‘ -->
  <div class="card hidden" id="noteCard">
    <h3 style="margin-top:0">
      <span id="editorTitle">æ–°å»º / ä¿å­˜ç¬”è®°</span>
      <span class="muted" id="editingHint" style="margin-left:8px"></span>
    </h3>

    <div class="row" style="margin-bottom:8px">
      <input id="noteTitle" placeholder="æ ‡é¢˜ï¼ˆä½œä¸ºæ–‡ä»¶åï¼‰" />
      <button id="btnSave">ä¿å­˜åˆ° COS</button>
      <button id="btnCancelEdit" class="secondary hidden">å–æ¶ˆç¼–è¾‘</button>
    </div>

    <textarea id="noteContent" placeholder="åœ¨æ­¤è¾“å…¥ç¬”è®°å†…å®¹..."></textarea>
    <p class="muted">å¯¹è±¡é”®å‰ç¼€ä¸º <span class="mono">/&lt;uid&gt;/</span>ï¼ˆç”± STS policy é™å®šï¼‰ã€‚</p>
    <p class="mono" id="saveState"></p>
  </div>

  <!-- åˆ—è¡¨ + æœç´¢ -->
  <div class="card hidden" id="listCard">
    <h3 style="margin-top:0">æˆ‘çš„ç¬”è®°</h3>

    <div class="row" style="margin:6px 0 10px">
      <input id="searchInput" placeholder="è¾“å…¥å…³é”®å­—è¿‡æ»¤ï¼ˆæ–‡ä»¶ååŒ…å«ï¼‰" style="flex:1;min-width:260px" />
      <button id="btnSearch" class="secondary">æœç´¢</button>
      <button id="btnClearSearch" class="secondary">æ¸…ç©º</button>
      <button id="btnRefresh" class="secondary">åˆ·æ–°åˆ—è¡¨</button>
    </div>

    <ul class="list" id="noteList"></ul>
    <p class="mono" id="listState"></p>
  </div>

<script>
/** ===== 0) åŸºæœ¬é…ç½® ===== */
const CLOUDBASE_ENV = "molijun-0gtahyghc6271173";
const STS_URL       = "https://molijun-0gtahyghc6271173-1317231591.ap-shanghai.app.tcloudbase.com/api/sts";

/** ===== 1) CloudBase åˆå§‹åŒ– & è®¤è¯ ===== */
const app = cloudbase.init({ env: CLOUDBASE_ENV });
const auth = app.auth();

const $ = id => document.getElementById(id);
const ui = {
  // auth
  btnSendCode: $("btnSendCode"),
  btnSignUp: $("btnSignUp"),
  btnSignIn: $("btnSignIn"),
  btnLogout: $("btnLogout"),
  email: $("email"),
  password: $("password"),
  emailCode: $("emailCode"),
  authState: $("authState"),
  // editor
  noteCard: $("noteCard"),
  editorTitle: $("editorTitle"),
  editingHint: $("editingHint"),
  noteTitle: $("noteTitle"),
  noteContent: $("noteContent"),
  btnSave: $("btnSave"),
  btnCancelEdit: $("btnCancelEdit"),
  saveState: $("saveState"),
  // list
  listCard: $("listCard"),
  noteList: $("noteList"),
  btnRefresh: $("btnRefresh"),
  listState: $("listState"),
  searchInput: $("searchInput"),
  btnSearch: $("btnSearch"),
  btnClearSearch: $("btnClearSearch"),
};

function setLoggedInUI(uid, email) {
  ui.btnLogout.classList.remove("hidden");
  ui.noteCard.classList.remove("hidden");
  ui.listCard.classList.remove("hidden");
  ui.authState.textContent = `å·²ç™»å½•ï¼š${email || "é‚®ç®±æœªçŸ¥"}ï¼ŒUID=${uid}`;
  refreshList().catch(console.error);
}
function setLoggedOutUI() {
  ui.btnLogout.classList.add("hidden");
  ui.noteCard.classList.add("hidden");
  ui.listCard.classList.add("hidden");
  ui.authState.textContent = "æœªç™»å½•";
  clearEditor();
}

// æ¢å¤ç™»å½•æ€
(async () => {
  try {
    const state = await auth.getLoginState();
    if (state && state.user) setLoggedInUI(state.user.uid, state.user.email);
    else setLoggedOutUI();
  } catch (e) { console.warn("getLoginState error", e); }
})();

// å‘é€é‚®ç®±éªŒè¯ç 
ui.btnSendCode.onclick = async () => {
  const email = ui.email.value.trim();
  if (!email) return alert("è¯·è¾“å…¥é‚®ç®±");
  ui.authState.textContent = "æ­£åœ¨å‘é€éªŒè¯ç ...";
  try {
    const v = await auth.getVerification({ email });
    ui.email.dataset.verification_id = v.verification_id;
    ui.authState.textContent = "éªŒè¯ç å·²å‘é€ï¼Œè¯·åœ¨ 10 åˆ†é’Ÿå†…å®Œæˆæ³¨å†Œã€‚";
  } catch (e) {
    ui.authState.textContent = "å‘é€éªŒè¯ç å¤±è´¥ï¼š" + (e?.message || JSON.stringify(e));
  }
};

// æ³¨å†Œ
ui.btnSignUp.onclick = async () => {
  const email = ui.email.value.trim();
  const password = ui.password.value.trim();
  const code = ui.emailCode.value.trim();
  const verification_id = ui.email.dataset.verification_id;
  if (!email || !password || !code || !verification_id) {
    return alert("è¯·å…ˆå‘é€éªŒè¯ç ï¼Œå¹¶å¡«å†™ é‚®ç®±/å¯†ç /éªŒè¯ç ");
  }
  ui.authState.textContent = "æ­£åœ¨æ³¨å†Œ...";
  try {
    const verified = await auth.verify({ verification_id, verification_code: code });
    const loginState = await auth.signUp({
      email,
      verification_code: code,
      verification_token: verified.verification_token,
      password,
    });
    setLoggedInUI(loginState.user.uid, loginState.user.email);
    ui.authState.textContent = "æ³¨å†Œå¹¶ç™»å½•æˆåŠŸ";
  } catch (e) {
    ui.authState.textContent = "æ³¨å†Œå¤±è´¥ï¼š" + (e?.message || JSON.stringify(e));
  }
};

// ç™»å½•
ui.btnSignIn.onclick = async () => {
  const email = ui.email.value.trim();
  const password = ui.password.value.trim();
  if (!email || !password) return alert("è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ");
  ui.authState.textContent = "æ­£åœ¨ç™»å½•...";
  try {
    const state = await auth.signIn({ username: email, password });
    setLoggedInUI(state.user.uid, state.user.email);
    ui.authState.textContent = "ç™»å½•æˆåŠŸ";
  } catch (e) {
    ui.authState.textContent = "ç™»å½•å¤±è´¥ï¼š" + (e?.message || JSON.stringify(e));
  }
};

// é€€å‡º
ui.btnLogout.onclick = async () => {
  try { await auth.signOut(); setLoggedOutUI(); }
  catch (e) { alert("é€€å‡ºå¤±è´¥ï¼š" + (e?.message || e)); }
};

/** ===== 2) STS & COS ===== */
let stsCache = null;
let cos = null;

async function currentUser() {
  const s = await auth.getLoginState();
  if (!s || !s.user) throw new Error("å°šæœªç™»å½•");
  return { uid: s.user.uid, email: s.user.email };
}
async function fetchSTS(uid) {
  const url = `${STS_URL}?uid=${encodeURIComponent(uid)}`;
  const res = await fetch(url, { headers: { "x-user-uid": uid } });
  if (!res.ok) {
    const t = await res.text().catch(()=>"");
    throw new Error(`STS è·å–å¤±è´¥ï¼ˆ${res.status}ï¼‰ï¼š${t}`);
  }
  const data = await res.json();
  if (!data?.credentials?.tmpSecretId || !data?.credentials?.tmpSecretKey || !data?.credentials?.sessionToken) {
    throw new Error("STS å“åº”ç¼ºå°‘ credentials");
  }
  if (!data?.bucket || !data?.region) {
    throw new Error("STS å“åº”ç¼ºå°‘ bucket/region");
  }
  return data;
}
async function ensureCOS() {
  const { uid } = await currentUser();

  const nowSec = Math.floor(Date.now()/1000);
  const needNew = !stsCache || !stsCache.expiredTime || (nowSec + 60) >= Number(stsCache.expiredTime);
  if (needNew) {
    stsCache = await fetchSTS(uid);
    cos = new COS({
      getAuthorization: (_, callback) => {
        const c = stsCache.credentials;
        callback({
          TmpSecretId:  c.tmpSecretId,
          TmpSecretKey: c.tmpSecretKey,
          SecurityToken:c.sessionToken,
          StartTime:    Number(stsCache.startTime),
          ExpiredTime:  Number(stsCache.expiredTime),
        });
      }
    });
  }
  return { cos, bucket: stsCache.bucket, region: stsCache.region, uid };
}

/** ===== 3) ä¸šåŠ¡ï¼šæ–°å¢ / ç¼–è¾‘ / æœç´¢ / åˆ—è¡¨ / ä¸‹è½½ / åˆ é™¤ ===== */
function pad2(n){return n<10?("0"+n):""+n}
function ts(){ const d=new Date(); return d.getFullYear()+pad2(d.getMonth()+1)+pad2(d.getDate())+"_"+pad2(d.getHours())+pad2(d.getMinutes())+pad2(d.getSeconds()); }

// â€”â€” ç¼–è¾‘æ¨¡å¼çŠ¶æ€ â€”â€” //
let editingKey = null;  // éç©ºæ—¶è¡¨ç¤ºæ­£åœ¨ç¼–è¾‘æŸä¸ª Key

function enterEditMode(key, fileName){
  editingKey = key;
  ui.editorTitle.textContent = "ç¼–è¾‘ç¬”è®°";
  ui.editingHint.textContent = fileName ? `ï¼ˆå½“å‰æ–‡ä»¶ï¼š${fileName}ï¼‰` : "";
  ui.btnCancelEdit.classList.remove("hidden");
  ui.saveState.textContent = "";
}
function exitEditMode(){
  editingKey = null;
  ui.editorTitle.textContent = "æ–°å»º / ä¿å­˜ç¬”è®°";
  ui.editingHint.textContent = "";
  ui.btnCancelEdit.classList.add("hidden");
}
function clearEditor(){
  ui.noteTitle.value = "";
  ui.noteContent.value = "";
  exitEditMode();
}

// ä¿å­˜ï¼ˆæ–°å»ºæˆ–è¦†ç›–ï¼‰
ui.btnSave.onclick = async () => {
  ui.saveState.textContent = "æ­£åœ¨ä¸Šä¼ ...";
  try {
    const { cos, bucket, region, uid } = await ensureCOS();

    let key;
    // ç¼–è¾‘æ¨¡å¼ï¼šç›´æ¥è¦†ç›–åŸ Keyï¼›æ–°å»ºæ¨¡å¼ï¼šæŒ‰æ—¶é—´æˆ³+æ ‡é¢˜ç”Ÿæˆæ–° Key
    if (editingKey) {
      key = editingKey;
    } else {
      const title = (ui.noteTitle.value || "æœªå‘½å").replace(/[\\/:*?"<>|\s]+/g,"_").slice(0,60);
      key = `${uid}/${ts()}_${title}.txt`;
    }

    const blob = new Blob([ui.noteContent.value || ""], { type: "text/plain;charset=utf-8" });
    await new Promise((resolve, reject) => {
      cos.putObject({ Bucket: bucket, Region: region, Key: key, Body: blob },
        (err, data) => err ? reject(err) : resolve(data));
    });

    ui.saveState.textContent = editingKey
      ? `å·²ä¿å­˜ä¿®æ”¹ï¼šcos://${bucket}/${key}`
      : `å·²ä¿å­˜ï¼šcos://${bucket}/${key}`;

    // é‡ç½®ç¼–è¾‘å™¨å¹¶åˆ·æ–°
    clearEditor();
    refreshList();
  } catch (e) {
    ui.saveState.textContent = "ä¿å­˜å¤±è´¥ï¼š" + (e?.message || JSON.stringify(e));
  }
};

// å–æ¶ˆç¼–è¾‘
ui.btnCancelEdit.onclick = () => clearEditor();

// â€”â€” åˆ—è¡¨ç¼“å­˜ç”¨äºæœ¬åœ°æœç´¢ â€”â€” //
let latestObjects = [];  // [{Key, LastModified}, ...]

async function refreshList() {
  ui.listState.textContent = "åŠ è½½ä¸­...";
  ui.noteList.innerHTML = "";
  try {
    const { cos, bucket, region, uid } = await ensureCOS();
    const prefix = `${uid}/`;
    const list = await new Promise((resolve, reject) => {
      cos.getBucket({ Bucket: bucket, Region: region, Prefix: prefix, MaxKeys: 1000 },
        (err, data) => err ? reject(err) : resolve(data));
    });
    const objs = (list?.Contents || []).filter(o => o.Key.endsWith(".txt"))
      .sort((a,b)=> new Date(b.LastModified) - new Date(a.LastModified));

    latestObjects = objs;               // æ›´æ–°ç¼“å­˜
    renderList(objs, bucket, region, cos);
    ui.listState.textContent = `å…± ${objs.length} æ¡`;
  } catch (e) {
    ui.listState.textContent = "åŠ è½½å¤±è´¥ï¼š" + (e?.message || JSON.stringify(e));
  }
}
ui.btnRefresh.onclick = refreshList;

// åªæ¸²æŸ“ï¼ˆä¾›åˆ—è¡¨ä¸æœç´¢å…±ç”¨ï¼‰
function renderList(objs, bucket, region, cos){
  ui.noteList.innerHTML = "";
  if (objs.length === 0) {
    ui.noteList.innerHTML = "<li class='muted'>æš‚æ— ç¬”è®°</li>";
    return;
  }
  for (const obj of objs) {
    const li = document.createElement("li");
    const name = obj.Key.split("/").pop();

    const left = document.createElement("div");
    left.innerHTML = `<span class="mono">${name}</span><br/><span class="muted">${new Date(obj.LastModified).toLocaleString()}</span>`;

    const btns = document.createElement("div");

    // ä¸‹è½½
    const btnDown = document.createElement("button");
    btnDown.className = "secondary";
    btnDown.textContent = "ä¸‹è½½";
    btnDown.onclick = async () => {
      const url = await new Promise((resolve, reject) => {
        cos.getObjectUrl({ Bucket: bucket, Region: region, Key: obj.Key, Sign: true },
          (e, r) => e ? reject(e) : resolve(r.Url));
      });
      window.open(url, "_blank");
    };

    // ç¼–è¾‘
    const btnEdit = document.createElement("button");
    btnEdit.className = "secondary";
    btnEdit.textContent = "ç¼–è¾‘";
    btnEdit.onclick = async () => {
      try{
        const data = await new Promise((resolve,reject)=>{
          cos.getObject({ Bucket: bucket, Region: region, Key: obj.Key },
            (e,r)=> e?reject(e):resolve(r));
        });
        // cos.getObject çš„ Body å¯èƒ½æ˜¯ Blob/ArrayBuffer/å­—ç¬¦ä¸²ï¼Œè¿™é‡Œç»Ÿä¸€è½¬ä¸ºå­—ç¬¦ä¸²
        const body = data && (data.Body || data.BodyBuffer || data.Content) || "";
        const text = typeof body === "string" ? body
                    : body instanceof Blob ? await body.text()
                    : new TextDecoder("utf-8").decode(body);

        // è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œå¡«å……å†…å®¹
        ui.noteTitle.value = name.replace(/\.txt$/i,"");
        ui.noteContent.value = text;
        enterEditMode(obj.Key, name);
        window.scrollTo({ top: 0, behavior: "smooth" });
      }catch(e){
        alert("è¯»å–å¤±è´¥ï¼š" + (e?.message || JSON.stringify(e)));
      }
    };

    // åˆ é™¤
    const btnDel = document.createElement("button");
    btnDel.className = "secondary danger";
    btnDel.textContent = "åˆ é™¤";
    btnDel.onclick = async () => {
      if (!confirm(`ç¡®è®¤åˆ é™¤ ${name} å—ï¼Ÿ`)) return;
      try {
        await new Promise((resolve, reject) => {
          cos.deleteObject({ Bucket: bucket, Region: region, Key: obj.Key },
            (e, r) => e ? reject(e) : resolve(r));
        });
        if (editingKey === obj.Key) clearEditor(); // è‹¥åˆ çš„æ˜¯æ­£åœ¨ç¼–è¾‘çš„æ–‡ä»¶ï¼Œé€€å‡ºç¼–è¾‘
        refreshList();
      } catch (e) {
        alert("åˆ é™¤å¤±è´¥ï¼š" + (e?.message || JSON.stringify(e)));
      }
    };

    btns.appendChild(btnDown);
    btns.appendChild(btnEdit);
    btns.appendChild(btnDel);
    li.appendChild(left);
    li.appendChild(btns);
    ui.noteList.appendChild(li);
  }
}

// æœç´¢ï¼ˆå‰ç«¯è¿‡æ»¤ï¼‰
ui.btnSearch.onclick = () => {
  const kw = ui.searchInput.value.trim().toLowerCase();
  const filtered = !kw ? latestObjects
    : latestObjects.filter(o => o.Key.split("/").pop().toLowerCase().includes(kw));
  // ç”¨æœ€è¿‘ä¸€æ¬¡ ensureCOS çš„ä¿¡æ¯æ¸²æŸ“ï¼ˆä¸éœ€è¦é‡æ–°å– stsï¼‰
  if (!stsCache) return; // æç«¯æƒ…å†µï¼šå°šæœªåŠ è½½è¿‡
  renderList(filtered, stsCache.bucket, stsCache.region, cos);
  ui.listState.textContent = `è¿‡æ»¤å ${filtered.length} æ¡`;
};
ui.btnClearSearch.onclick = () => {
  ui.searchInput.value = "";
  if (stsCache) renderList(latestObjects, stsCache.bucket, stsCache.region, cos);
  ui.listState.textContent = `å…± ${latestObjects.length} æ¡`;
};
</script>
</body>
</html>
