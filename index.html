<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>极简笔记（CloudBase 登录 + COS 存储）</title>
  <!-- CloudBase JS SDK v2 -->
  <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.21.6/cloudbase.full.js"></script>
  <!-- COS JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto;max-width:860px;margin:24px auto;padding:0 12px}
    h1{font-size:22px;margin:0 0 12px}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,textarea,button{font:inherit}
    input,textarea{border:1px solid #d1d5db;border-radius:8px;padding:10px}
    input{width:240px}
    textarea{width:100%;min-height:120px}
    button{border:1px solid #111827;background:#111827;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    button.secondary{background:#fff;color:#111827;border-color:#d1d5db}
    .muted{color:#6b7280;font-size:12px}
    .list{list-style:none;padding:0;margin:0}
    .list li{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:8px 0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .hidden{display:none}
    .danger{background:#b91c1c;border-color:#b91c1c}
    .success{background:#065f46;border-color:#065f46}
  </style>
</head>
<body>
  <h1>📝 极简笔记（CloudBase 登录 + COS 存储）</h1>

  <!-- 认证 -->
  <div class="card" id="authCard">
    <div class="row">
      <input id="email" type="email" placeholder="邮箱" />
      <input id="password" type="password" placeholder="密码（8-32位）" />
      <input id="emailCode" placeholder="邮箱验证码（注册必填）" />
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnSendCode">发送验证码（注册用）</button>
      <button id="btnSignUp">注册</button>
      <button id="btnSignIn" class="secondary">登录</button>
      <button id="btnLogout" class="secondary hidden">退出登录</button>
    </div>
    <p class="muted">注册：先发送验证码 → 邮箱取码 → 填入验证码 → 点注册。注册成功会自动登录。</p>
    <p class="mono" id="authState"></p>
  </div>

  <!-- 新建 / 编辑 -->
  <div class="card hidden" id="noteCard">
    <h3 style="margin-top:0">
      <span id="editorTitle">新建 / 保存笔记</span>
      <span class="muted" id="editingHint" style="margin-left:8px"></span>
    </h3>

    <div class="row" style="margin-bottom:8px">
      <input id="noteTitle" placeholder="标题（作为文件名）" />
      <button id="btnSave">保存到 COS</button>
      <button id="btnCancelEdit" class="secondary hidden">取消编辑</button>
    </div>

    <textarea id="noteContent" placeholder="在此输入笔记内容..."></textarea>
    <p class="muted">对象键前缀为 <span class="mono">/&lt;uid&gt;/</span>（由 STS policy 限定）。</p>
    <p class="mono" id="saveState"></p>
  </div>

  <!-- 列表 + 搜索 -->
  <div class="card hidden" id="listCard">
    <h3 style="margin-top:0">我的笔记</h3>

    <div class="row" style="margin:6px 0 10px">
      <input id="searchInput" placeholder="输入关键字过滤（文件名包含）" style="flex:1;min-width:260px" />
      <button id="btnSearch" class="secondary">搜索</button>
      <button id="btnClearSearch" class="secondary">清空</button>
      <button id="btnRefresh" class="secondary">刷新列表</button>
    </div>

    <ul class="list" id="noteList"></ul>
    <p class="mono" id="listState"></p>
  </div>

<script>
/** ===== 0) 基本配置 ===== */
const CLOUDBASE_ENV = "molijun-0gtahyghc6271173";
const STS_URL       = "https://molijun-0gtahyghc6271173-1317231591.ap-shanghai.app.tcloudbase.com/api/sts";

/** ===== 1) CloudBase 初始化 & 认证 ===== */
const app = cloudbase.init({ env: CLOUDBASE_ENV });
const auth = app.auth();

const $ = id => document.getElementById(id);
const ui = {
  // auth
  btnSendCode: $("btnSendCode"),
  btnSignUp: $("btnSignUp"),
  btnSignIn: $("btnSignIn"),
  btnLogout: $("btnLogout"),
  email: $("email"),
  password: $("password"),
  emailCode: $("emailCode"),
  authState: $("authState"),
  // editor
  noteCard: $("noteCard"),
  editorTitle: $("editorTitle"),
  editingHint: $("editingHint"),
  noteTitle: $("noteTitle"),
  noteContent: $("noteContent"),
  btnSave: $("btnSave"),
  btnCancelEdit: $("btnCancelEdit"),
  saveState: $("saveState"),
  // list
  listCard: $("listCard"),
  noteList: $("noteList"),
  btnRefresh: $("btnRefresh"),
  listState: $("listState"),
  searchInput: $("searchInput"),
  btnSearch: $("btnSearch"),
  btnClearSearch: $("btnClearSearch"),
};

function setLoggedInUI(uid, email) {
  ui.btnLogout.classList.remove("hidden");
  ui.noteCard.classList.remove("hidden");
  ui.listCard.classList.remove("hidden");
  ui.authState.textContent = `已登录：${email || "邮箱未知"}，UID=${uid}`;
  refreshList().catch(console.error);
}
function setLoggedOutUI() {
  ui.btnLogout.classList.add("hidden");
  ui.noteCard.classList.add("hidden");
  ui.listCard.classList.add("hidden");
  ui.authState.textContent = "未登录";
  clearEditor();
}

// 恢复登录态
(async () => {
  try {
    const state = await auth.getLoginState();
    if (state && state.user) setLoggedInUI(state.user.uid, state.user.email);
    else setLoggedOutUI();
  } catch (e) { console.warn("getLoginState error", e); }
})();

// 发送邮箱验证码
ui.btnSendCode.onclick = async () => {
  const email = ui.email.value.trim();
  if (!email) return alert("请输入邮箱");
  ui.authState.textContent = "正在发送验证码...";
  try {
    const v = await auth.getVerification({ email });
    ui.email.dataset.verification_id = v.verification_id;
    ui.authState.textContent = "验证码已发送，请在 10 分钟内完成注册。";
  } catch (e) {
    ui.authState.textContent = "发送验证码失败：" + (e?.message || JSON.stringify(e));
  }
};

// 注册
ui.btnSignUp.onclick = async () => {
  const email = ui.email.value.trim();
  const password = ui.password.value.trim();
  const code = ui.emailCode.value.trim();
  const verification_id = ui.email.dataset.verification_id;
  if (!email || !password || !code || !verification_id) {
    return alert("请先发送验证码，并填写 邮箱/密码/验证码");
  }
  ui.authState.textContent = "正在注册...";
  try {
    const verified = await auth.verify({ verification_id, verification_code: code });
    const loginState = await auth.signUp({
      email,
      verification_code: code,
      verification_token: verified.verification_token,
      password,
    });
    setLoggedInUI(loginState.user.uid, loginState.user.email);
    ui.authState.textContent = "注册并登录成功";
  } catch (e) {
    ui.authState.textContent = "注册失败：" + (e?.message || JSON.stringify(e));
  }
};

// 登录
ui.btnSignIn.onclick = async () => {
  const email = ui.email.value.trim();
  const password = ui.password.value.trim();
  if (!email || !password) return alert("请输入邮箱与密码");
  ui.authState.textContent = "正在登录...";
  try {
    const state = await auth.signIn({ username: email, password });
    setLoggedInUI(state.user.uid, state.user.email);
    ui.authState.textContent = "登录成功";
  } catch (e) {
    ui.authState.textContent = "登录失败：" + (e?.message || JSON.stringify(e));
  }
};

// 退出
ui.btnLogout.onclick = async () => {
  try { await auth.signOut(); setLoggedOutUI(); }
  catch (e) { alert("退出失败：" + (e?.message || e)); }
};

/** ===== 2) STS & COS ===== */
let stsCache = null;
let cos = null;

async function currentUser() {
  const s = await auth.getLoginState();
  if (!s || !s.user) throw new Error("尚未登录");
  return { uid: s.user.uid, email: s.user.email };
}
async function fetchSTS(uid) {
  const url = `${STS_URL}?uid=${encodeURIComponent(uid)}`;
  const res = await fetch(url, { headers: { "x-user-uid": uid } });
  if (!res.ok) {
    const t = await res.text().catch(()=>"");
    throw new Error(`STS 获取失败（${res.status}）：${t}`);
  }
  const data = await res.json();
  if (!data?.credentials?.tmpSecretId || !data?.credentials?.tmpSecretKey || !data?.credentials?.sessionToken) {
    throw new Error("STS 响应缺少 credentials");
  }
  if (!data?.bucket || !data?.region) {
    throw new Error("STS 响应缺少 bucket/region");
  }
  return data;
}
async function ensureCOS() {
  const { uid } = await currentUser();

  const nowSec = Math.floor(Date.now()/1000);
  const needNew = !stsCache || !stsCache.expiredTime || (nowSec + 60) >= Number(stsCache.expiredTime);
  if (needNew) {
    stsCache = await fetchSTS(uid);
    cos = new COS({
      getAuthorization: (_, callback) => {
        const c = stsCache.credentials;
        callback({
          TmpSecretId:  c.tmpSecretId,
          TmpSecretKey: c.tmpSecretKey,
          SecurityToken:c.sessionToken,
          StartTime:    Number(stsCache.startTime),
          ExpiredTime:  Number(stsCache.expiredTime),
        });
      }
    });
  }
  return { cos, bucket: stsCache.bucket, region: stsCache.region, uid };
}

/** ===== 3) 业务：新增 / 编辑 / 搜索 / 列表 / 下载 / 删除 ===== */
function pad2(n){return n<10?("0"+n):""+n}
function ts(){ const d=new Date(); return d.getFullYear()+pad2(d.getMonth()+1)+pad2(d.getDate())+"_"+pad2(d.getHours())+pad2(d.getMinutes())+pad2(d.getSeconds()); }

// —— 编辑模式状态 —— //
let editingKey = null;  // 非空时表示正在编辑某个 Key

function enterEditMode(key, fileName){
  editingKey = key;
  ui.editorTitle.textContent = "编辑笔记";
  ui.editingHint.textContent = fileName ? `（当前文件：${fileName}）` : "";
  ui.btnCancelEdit.classList.remove("hidden");
  ui.saveState.textContent = "";
}
function exitEditMode(){
  editingKey = null;
  ui.editorTitle.textContent = "新建 / 保存笔记";
  ui.editingHint.textContent = "";
  ui.btnCancelEdit.classList.add("hidden");
}
function clearEditor(){
  ui.noteTitle.value = "";
  ui.noteContent.value = "";
  exitEditMode();
}

// 保存（新建或覆盖）
ui.btnSave.onclick = async () => {
  ui.saveState.textContent = "正在上传...";
  try {
    const { cos, bucket, region, uid } = await ensureCOS();

    let key;
    // 编辑模式：直接覆盖原 Key；新建模式：按时间戳+标题生成新 Key
    if (editingKey) {
      key = editingKey;
    } else {
      const title = (ui.noteTitle.value || "未命名").replace(/[\\/:*?"<>|\s]+/g,"_").slice(0,60);
      key = `${uid}/${ts()}_${title}.txt`;
    }

    const blob = new Blob([ui.noteContent.value || ""], { type: "text/plain;charset=utf-8" });
    await new Promise((resolve, reject) => {
      cos.putObject({ Bucket: bucket, Region: region, Key: key, Body: blob },
        (err, data) => err ? reject(err) : resolve(data));
    });

    ui.saveState.textContent = editingKey
      ? `已保存修改：cos://${bucket}/${key}`
      : `已保存：cos://${bucket}/${key}`;

    // 重置编辑器并刷新
    clearEditor();
    refreshList();
  } catch (e) {
    ui.saveState.textContent = "保存失败：" + (e?.message || JSON.stringify(e));
  }
};

// 取消编辑
ui.btnCancelEdit.onclick = () => clearEditor();

// —— 列表缓存用于本地搜索 —— //
let latestObjects = [];  // [{Key, LastModified}, ...]

async function refreshList() {
  ui.listState.textContent = "加载中...";
  ui.noteList.innerHTML = "";
  try {
    const { cos, bucket, region, uid } = await ensureCOS();
    const prefix = `${uid}/`;
    const list = await new Promise((resolve, reject) => {
      cos.getBucket({ Bucket: bucket, Region: region, Prefix: prefix, MaxKeys: 1000 },
        (err, data) => err ? reject(err) : resolve(data));
    });
    const objs = (list?.Contents || []).filter(o => o.Key.endsWith(".txt"))
      .sort((a,b)=> new Date(b.LastModified) - new Date(a.LastModified));

    latestObjects = objs;               // 更新缓存
    renderList(objs, bucket, region, cos);
    ui.listState.textContent = `共 ${objs.length} 条`;
  } catch (e) {
    ui.listState.textContent = "加载失败：" + (e?.message || JSON.stringify(e));
  }
}
ui.btnRefresh.onclick = refreshList;

// 只渲染（供列表与搜索共用）
function renderList(objs, bucket, region, cos){
  ui.noteList.innerHTML = "";
  if (objs.length === 0) {
    ui.noteList.innerHTML = "<li class='muted'>暂无笔记</li>";
    return;
  }
  for (const obj of objs) {
    const li = document.createElement("li");
    const name = obj.Key.split("/").pop();

    const left = document.createElement("div");
    left.innerHTML = `<span class="mono">${name}</span><br/><span class="muted">${new Date(obj.LastModified).toLocaleString()}</span>`;

    const btns = document.createElement("div");

    // 下载
    const btnDown = document.createElement("button");
    btnDown.className = "secondary";
    btnDown.textContent = "下载";
    btnDown.onclick = async () => {
      const url = await new Promise((resolve, reject) => {
        cos.getObjectUrl({ Bucket: bucket, Region: region, Key: obj.Key, Sign: true },
          (e, r) => e ? reject(e) : resolve(r.Url));
      });
      window.open(url, "_blank");
    };

    // 编辑
    const btnEdit = document.createElement("button");
    btnEdit.className = "secondary";
    btnEdit.textContent = "编辑";
    btnEdit.onclick = async () => {
      try{
        const data = await new Promise((resolve,reject)=>{
          cos.getObject({ Bucket: bucket, Region: region, Key: obj.Key },
            (e,r)=> e?reject(e):resolve(r));
        });
        // cos.getObject 的 Body 可能是 Blob/ArrayBuffer/字符串，这里统一转为字符串
        const body = data && (data.Body || data.BodyBuffer || data.Content) || "";
        const text = typeof body === "string" ? body
                    : body instanceof Blob ? await body.text()
                    : new TextDecoder("utf-8").decode(body);

        // 进入编辑模式，填充内容
        ui.noteTitle.value = name.replace(/\.txt$/i,"");
        ui.noteContent.value = text;
        enterEditMode(obj.Key, name);
        window.scrollTo({ top: 0, behavior: "smooth" });
      }catch(e){
        alert("读取失败：" + (e?.message || JSON.stringify(e)));
      }
    };

    // 删除
    const btnDel = document.createElement("button");
    btnDel.className = "secondary danger";
    btnDel.textContent = "删除";
    btnDel.onclick = async () => {
      if (!confirm(`确认删除 ${name} 吗？`)) return;
      try {
        await new Promise((resolve, reject) => {
          cos.deleteObject({ Bucket: bucket, Region: region, Key: obj.Key },
            (e, r) => e ? reject(e) : resolve(r));
        });
        if (editingKey === obj.Key) clearEditor(); // 若删的是正在编辑的文件，退出编辑
        refreshList();
      } catch (e) {
        alert("删除失败：" + (e?.message || JSON.stringify(e)));
      }
    };

    btns.appendChild(btnDown);
    btns.appendChild(btnEdit);
    btns.appendChild(btnDel);
    li.appendChild(left);
    li.appendChild(btns);
    ui.noteList.appendChild(li);
  }
}

// 搜索（前端过滤）
ui.btnSearch.onclick = () => {
  const kw = ui.searchInput.value.trim().toLowerCase();
  const filtered = !kw ? latestObjects
    : latestObjects.filter(o => o.Key.split("/").pop().toLowerCase().includes(kw));
  // 用最近一次 ensureCOS 的信息渲染（不需要重新取 sts）
  if (!stsCache) return; // 极端情况：尚未加载过
  renderList(filtered, stsCache.bucket, stsCache.region, cos);
  ui.listState.textContent = `过滤后 ${filtered.length} 条`;
};
ui.btnClearSearch.onclick = () => {
  ui.searchInput.value = "";
  if (stsCache) renderList(latestObjects, stsCache.bucket, stsCache.region, cos);
  ui.listState.textContent = `共 ${latestObjects.length} 条`;
};
</script>
</body>
</html>
