<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cloud Notes</title>
  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--brand:#6757ff}
    .brand{color:var(--brand)}
    .btn-brand{background:var(--brand);color:white}
    .btn-brand:hover{filter:brightness(0.9)}
    .card{box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .scrollbar-thin::-webkit-scrollbar{height:8px;width:8px}
    .scrollbar-thin::-webkit-scrollbar-thumb{background:rgba(0,0,0,.15);border-radius:9999px}
    .fade-enter{opacity:.0;transform:translateY(6px)}
    .fade-enter-active{opacity:1;transform:none;transition:all .2s}
    .ql-toolbar.ql-snow{border-top-left-radius:.75rem;border-top-right-radius:.75rem}
    .ql-container.ql-snow{border-bottom-left-radius:.75rem;border-bottom-right-radius:.75rem;min-height:420px}
    .pdf-page{border-radius:.5rem;box-shadow:0 2px 12px rgba(0,0,0,.08);margin:16px auto}
  </style>

  <!-- Feather Icons -->
  <script src="https://unpkg.com/feather-icons"></script>
  <!-- Quill -->
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
  <!-- PDF.js -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    /* PDF.js worker */
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
  </script>
  <!-- html2canvas + jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- CloudBase JS SDK (Web v2) -->
  <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.14.1/cloudbase.full.js"></script>

  <!-- COS SDK (v5) -->
  <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5@1.8.8/dist/cos-js-sdk-v5.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Toast -->
  <div id="toast" class="fixed top-6 right-6 hidden">
    <div class="flex items-center gap-2 rounded-lg border border-amber-300 bg-amber-50 px-4 py-2 text-amber-800">
      <i data-feather="alert-triangle" class="w-4 h-4"></i>
      <span id="toast-text">提示</span>
    </div>
  </div>

  <!-- 认证视图 -->
  <main id="auth-view" class="min-h-screen flex items-center justify-center p-6">
    <section class="w-full max-w-xl">
      <div class="card rounded-2xl bg-white p-8">
        <header class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-semibold"><span class="brand font-bold">Cloud Notes</span></h1>
          <div class="flex gap-3 text-sm">
            <button id="switch-login" class="text-slate-600 hover:text-slate-900">登录</button>
            <button id="switch-register" class="text-slate-600 hover:text-slate-900">注册</button>
          </div>
        </header>

        <!-- 登录表单 -->
        <form id="login-form" class="space-y-4">
          <div>
            <label class="block mb-1 text-sm text-slate-500">邮箱</label>
            <input id="login-email" type="email" required class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-200" placeholder="you@example.com" />
          </div>
          <div>
            <label class="block mb-1 text-sm text-slate-500">密码</label>
            <input id="login-password" type="password" required minlength="8" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-200" placeholder="至少 8 位，包含字母和数字" />
          </div>
          <button class="btn-brand w-full rounded-lg py-2 font-medium" type="submit">登录</button>
        </form>

        <!-- 注册表单（新版登录体系：需要邮箱验证码） -->
        <form id="register-form" class="space-y-4 hidden">
          <div class="text-sm text-slate-500">注册后系统会发送 <b>验证码</b> 到你的邮箱</div>
          <div>
            <label class="block mb-1 text-sm text-slate-500">邮箱</label>
            <input id="register-email" type="email" required class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-200" placeholder="you@example.com" />
          </div>
          <div>
            <label class="block mb-1 text-sm text-slate-500">密码</label>
            <input id="register-password" type="password" required minlength="8" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-200" placeholder="至少 8 位，包含字母和数字" />
          </div>

          <div id="register-code-row" class="hidden">
            <label class="block mb-1 text-sm text-slate-500">邮箱验证码</label>
            <input id="register-code" type="text" inputmode="numeric" pattern="\\d{4,8}" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-200" placeholder="输入邮箱收到的验证码" />
          </div>

          <div class="flex gap-3">
            <button id="btn-send-code" class="flex-1 rounded-lg border border-slate-300 px-3 py-2 hover:bg-slate-50" type="button">发送验证码</button>
            <button id="btn-register" class="flex-1 btn-brand rounded-lg py-2 font-medium" type="submit">完成注册</button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <!-- 主应用视图 -->
  <div id="main-app-view" class="hidden min-h-screen">
    <div class="flex">
      <!-- Sidebar -->
      <aside id="sidebar" class="w-80 shrink-0 border-r bg-white hidden md:block">
        <div class="flex items-center gap-3 border-b px-4 py-4">
          <div id="avatar" class="grid h-10 w-10 place-items-center rounded-full bg-indigo-100 text-indigo-700 font-semibold">U</div>
          <div class="flex-1 min-w-0">
            <div id="user-email" class="truncate text-sm font-medium">user@example.com</div>
            <button id="btn-logout" class="text-xs text-slate-500 hover:text-slate-800">退出登录</button>
          </div>
        </div>

        <div class="px-4 py-3 border-b flex gap-3">
          <button id="btn-new-folder" class="flex-1 rounded-lg border px-3 py-2 hover:bg-slate-50"><i data-feather="folder-plus" class="inline-block w-4 h-4 mr-1"></i>新建文件夹</button>
          <button id="btn-new-article" class="flex-1 rounded-lg border px-3 py-2 hover:bg-slate-50"><i data-feather="file-plus" class="inline-block w-4 h-4 mr-1"></i>新建文章</button>
        </div>

        <div class="h-[calc(100vh-220px)] overflow-y-auto px-2 py-2 scrollbar-thin">
          <ul id="file-tree" class="space-y-1 text-sm"></ul>
        </div>

        <div class="border-t p-3">
          <details class="rounded-lg bg-slate-50 p-3">
            <summary class="cursor-pointer select-none text-sm text-slate-700">数据管理</summary>
            <div class="mt-3 grid grid-cols-1 gap-2">
              <label class="inline-flex items-center gap-2 rounded border bg-white px-3 py-2 hover:bg-slate-50 cursor-pointer">
                <input id="import-pdf-input" type="file" accept="application/pdf" class="hidden" />
                <i data-feather="file" class="w-4 h-4"></i><span>导入 PDF</span>
              </label>
              <label class="inline-flex items-center gap-2 rounded border bg-white px-3 py-2 hover:bg-slate-50 cursor-pointer">
                <input id="import-backup-input" type="file" accept="application/json" class="hidden" />
                <i data-feather="upload" class="w-4 h-4"></i><span>导入备份</span>
              </label>
              <button id="btn-export-backup" class="rounded border bg-white px-3 py-2 hover:bg-slate-50 inline-flex items-center gap-2"><i data-feather="download" class="w-4 h-4"></i><span>导出备份</span></button>
            </div>
          </details>
        </div>
      </aside>

      <!-- Content -->
      <section class="flex-1">
        <header class="sticky top-0 z-10 flex items-center justify-between border-b bg-white px-4 py-3">
          <div class="flex items-center gap-3">
            <button id="btn-toggle-sidebar" class="md:hidden rounded border p-2 hover:bg-slate-50"><i data-feather="menu"></i></button>
            <h2 id="current-title" class="text-base font-medium truncate max-w-[60vw]">欢迎</h2>
          </div>
          <div id="pdf-controls" class="hidden items-center gap-2 md:flex">
            <button id="btn-prev-page" class="rounded border px-3 py-1 hover:bg-slate-50">上一页</button>
            <button id="btn-next-page" class="rounded border px-3 py-1 hover:bg-slate-50">下一页</button>
            <span id="page-info" class="text-sm text-slate-500">-/-</span>
          </div>
          <div class="flex items-center gap-2">
            <button id="btn-edit" class="hidden rounded border px-3 py-1 hover:bg-slate-50">编辑</button>
            <button id="btn-save" class="hidden btn-brand rounded px-3 py-1">保存</button>
            <button id="btn-export" class="hidden rounded border px-3 py-1 hover:bg-slate-50">导出</button>
            <div class="relative md:hidden">
              <button id="btn-more" class="rounded border px-3 py-1 hover:bg-slate-50">更多</button>
              <div id="more-menu" class="absolute right-0 mt-1 hidden w-40 rounded-lg border bg-white p-2 shadow">
                <button class="w-full rounded px-3 py-2 text-left hover:bg-slate-50" data-action="edit">编辑</button>
                <button class="w-full rounded px-3 py-2 text-left hover:bg-slate-50" data-action="save">保存</button>
                <button class="w-full rounded px-3 py-2 text-left hover:bg-slate-50" data-action="export">导出</button>
              </div>
            </div>
          </div>
        </header>

        <div id="main-content" class="p-4">
          <div id="welcome-view" class="text-center py-16">
            <div class="mx-auto max-w-md text-slate-500">请选择左侧的文章或新建一个。</div>
          </div>

          <div id="article-view" class="hidden">
            <div id="richtext-editor-view" class="hidden">
              <div id="editor-toolbar" class="mb-2"></div>
              <div id="editor"></div>
            </div>

            <div id="pdf-reader-view" class="hidden">
              <div id="pdf-container" class="mx-auto max-w-3xl"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- 创建/重命名/移动/确认 模态框 -->
  <div id="modals" class="hidden">
    <!-- 创建 -->
    <div id="creation-modal" class="fixed inset-0 z-30 hidden items-center justify-center bg-black/20 p-4">
      <div class="w-full max-w-md rounded-xl bg-white p-6">
        <h3 class="mb-4 text-lg font-semibold">新建</h3>
        <div class="space-y-3">
          <input id="create-title" class="w-full rounded border px-3 py-2" placeholder="标题或文件夹名" />
          <select id="create-type" class="w-full rounded border px-3 py-2">
            <option value="folder">文件夹</option>
            <option value="text" selected>富文本文章</option>
            <option value="pdf">PDF 文章</option>
          </select>
          <select id="create-folder" class="w-full rounded border px-3 py-2"></select>
        </div>
        <div class="mt-5 flex justify-end gap-2">
          <button class="rounded border px-4 py-2" data-close>取消</button>
          <button id="confirm-create" class="btn-brand rounded px-4 py-2">确定</button>
        </div>
      </div>
    </div>
    <!-- 重命名 -->
    <div id="rename-modal" class="fixed inset-0 z-30 hidden items-center justify-center bg-black/20 p-4">
      <div class="w-full max-w-md rounded-xl bg-white p-6">
        <h3 class="mb-4 text-lg font-semibold">重命名</h3>
        <input id="rename-input" class="w-full rounded border px-3 py-2" />
        <div class="mt-5 flex justify-end gap-2">
          <button class="rounded border px-4 py-2" data-close>取消</button>
          <button id="confirm-rename" class="btn-brand rounded px-4 py-2">确定</button>
        </div>
      </div>
    </div>
    <!-- 移动 -->
    <div id="move-modal" class="fixed inset-0 z-30 hidden items-center justify-center bg-black/20 p-4">
      <div class="w-full max-w-md rounded-xl bg-white p-6">
        <h3 class="mb-4 text-lg font-semibold">移动到</h3>
        <select id="move-target" class="w-full rounded border px-3 py-2"></select>
        <div class="mt-5 flex justify-end gap-2">
          <button class="rounded border px-4 py-2" data-close>取消</button>
          <button id="confirm-move" class="btn-brand rounded px-4 py-2">确定</button>
        </div>
      </div>
    </div>
    <!-- 确认 -->
    <div id="confirm-modal" class="fixed inset-0 z-30 hidden items-center justify-center bg-black/20 p-4">
      <div class="w-full max-w-md rounded-xl bg-white p-6">
        <h3 id="confirm-title" class="mb-2 text-lg font-semibold">确认</h3>
        <p id="confirm-message" class="text-sm text-slate-600">确定执行该操作？</p>
        <div class="mt-5 flex justify-end gap-2">
          <button class="rounded border px-4 py-2" data-close>取消</button>
          <button id="confirm-yes" class="btn-brand rounded px-4 py-2">确定</button>
        </div>
      </div>
    </div>
  </div>

  <!-- App 脚本 -->
  <script>
    const CONFIG = {
      envId: "molijun-0gtahyghc6271173",
      clientId: "", // 新版登录体系建议在控制台 登录授权->应用配置 中获取 Client ID 后填入；留空也可尝试
      cos: {
        bucket: "notes-1317231591",
        region: "ap-guangzhou",
        stsUrl: "https://molijun-0gtahyghc6271173-1317231591.ap-shanghai.app.tcloudbase.com/api/sts"
      }
    };

    // --------------- 小工具 --------------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const show = (el) => (typeof el === 'string' ? $(el) : el).classList.remove('hidden');
    const hide = (el) => (typeof el === 'string' ? $(el) : el).classList.add('hidden');
    const setText = (el, t) => (typeof el === 'string' ? $(el) : el).textContent = t;

    function toast(msg){
      $("#toast-text").textContent = msg;
      const box = $("#toast");
      box.classList.remove("hidden");
      setTimeout(()=> box.classList.add("hidden"), 3000);
    }

    function prettyDate(ts){
      return new Date(ts).toLocaleString();
    }

    // --------------- CloudBase 初始化 --------------
    let app, auth, db;
    try{
      const initOpts = { env: CONFIG.envId };
      if (CONFIG.clientId) initOpts.clientId = CONFIG.clientId;
      app = cloudbase.init(initOpts);
      auth = app.auth({ persistence: "local" });
      db = app.database();
    }catch(e){
      console.error("CloudBase init failed", e);
      toast("CloudBase 初始化失败，请检查 CDN 与 envId");
    }

    // --------------- COS 初始化 --------------
    const cos = new COS({
      getAuthorization: async (options, callback) => {
        try {
          const res = await fetch(CONFIG.cos.stsUrl);
          const data = await res.json();
          callback({
            TmpSecretId: data.credentials.tmpSecretId,
            TmpSecretKey: data.credentials.tmpSecretKey,
            SecurityToken: data.credentials.sessionToken,
            StartTime: data.startTime,
            ExpiredTime: data.expiredTime
          });
        } catch (err) {
          console.error("STS 获取失败", err);
          toast("获取上传凭证失败");
        }
      }
    });

    // --------------- 认证视图逻辑（新版 API） --------------
    let regFlow = null; // { email, password, verification_id, is_user }

    $("#switch-login").addEventListener("click", () => {
      hide("#register-form"); show("#login-form");
    });
    $("#switch-register").addEventListener("click", () => {
      hide("#login-form"); show("#register-form");
    });

    $("#login-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = $("#login-email").value.trim();
      const password = $("#login-password").value;
      try{
        await auth.signIn({ username: email, password });
        await enterApp();
      }catch(err){
        console.error(err);
        toast(err?.message || "登录失败");
      }
    });

    $("#btn-send-code").addEventListener("click", async ()=>{
      const email = $("#register-email").value.trim();
      const password = $("#register-password").value;
      if(!email || !password){ toast("请输入邮箱和密码"); return; }
      try{
        const v = await auth.getVerification({ email });
        regFlow = { email, password, verification_id: v.verification_id, is_user: v.is_user };
        show("#register-code-row");
        toast("验证码已发送到邮箱，请查收并输入");
      }catch(err){
        console.error(err);
        toast(err?.message || "发送验证码失败");
      }
    });

    $("#register-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const code = $("#register-code").value.trim();
      if(!regFlow){ toast("请先发送验证码"); return; }
      try{
        const ver = await auth.verify({
          verification_id: regFlow.verification_id,
          verification_code: code
        });
        if (regFlow.is_user){
          // 已存在，直接登录
          await auth.signIn({ username: regFlow.email, password: regFlow.password });
        }else{
          // 新注册（自动登录）
          await auth.signUp({
            email: regFlow.email,
            password: regFlow.password,
            verification_code: code,
            verification_token: ver.verification_token
          });
        }
        await enterApp();
      }catch(err){
        console.error(err);
        toast(err?.message || "注册失败");
      }
    });

    async function loadUser(){
      try{
        const loginState = await auth.getLoginState?.(); // v2 仍兼容
        if (loginState && loginState?.credential){
          return await auth.currentUser;
        }
      }catch(_){}
      return null;
    }

    // --------------- 主应用逻辑 --------------
    let quill = null;
    let current = null; // {type,id,title,folder_id,...}

    async function enterApp(){
      const user = await auth.currentUser;
      if(!user){ toast("尚未登录"); return; }
      setText("#user-email", user?.email || user?.uid || "已登录");
      $("#avatar").textContent = (user?.email || "U").slice(0,1).toUpperCase();
      hide("#auth-view");
      show("#main-app-view");
      await refreshTree();
    }

    $("#btn-logout").addEventListener("click", async()=>{
      try{ await auth.signOut(); }catch(_){}
      show("#auth-view"); hide("#main-app-view");
    });

    $("#btn-toggle-sidebar").addEventListener("click", ()=>{
      const aside = $("#sidebar");
      aside.classList.toggle("hidden");
    });

    // --------------- 数据模型 --------------
    const collFolders = () => db.collection("folders");
    const collArticles = () => db.collection("articles");

    async function refreshTree(){
      const foldersRes = await collFolders().orderBy("created_at","asc").get();
      const articlesRes = await collArticles().orderBy("updated_at","desc").get();
      const folders = foldersRes.data || [];
      const articles = articlesRes.data || [];

      const treeEl = $("#file-tree");
      treeEl.innerHTML = "";

      // 未分类
      const uncat = articles.filter(a=>!a.folder_id);
      if (uncat.length){
        const ul = document.createElement("ul");
        ul.className = "ml-3 space-y-1";
        uncat.forEach(a=> ul.appendChild(articleItem(a)));
        const li = document.createElement("li");
        li.innerHTML = \`
          <div class="flex items-center justify-between px-2 py-1 text-xs text-slate-500">未分类</div>
        \`;
        li.appendChild(ul);
        treeEl.appendChild(li);
      }

      // 文件夹
      for (const f of folders){
        const li = document.createElement("li");
        li.innerHTML = \`
          <details open class="rounded-lg">
            <summary class="flex cursor-pointer items-center gap-2 rounded px-2 py-2 hover:bg-slate-50">
              <i data-feather="folder" class="w-4 h-4"></i>
              <span class="flex-1 truncate">\${f.name}</span>
              <span class="text-xs text-slate-400">\${new Date(f.created_at||Date.now()).toLocaleDateString()}</span>
            </summary>
            <ul class="ml-5 space-y-1"></ul>
          </details>
        \`;
        const ul = $("ul", li);
        articles.filter(a=>a.folder_id===f.id).forEach(a=> ul.appendChild(articleItem(a)));
        treeEl.appendChild(li);
      }
      feather.replace();
      fillFolderSelects(folders);
    }

    function articleItem(a){
      const li = document.createElement("li");
      li.innerHTML = \`
        <a href="#" class="group flex items-center gap-2 rounded px-2 py-2 hover:bg-slate-50" data-id="\${a.id}">
          <i data-feather="\${a.type==='pdf'?'file-text':'edit'}" class="w-4 h-4"></i>
          <span class="flex-1 truncate">\${a.title||'(未命名)'}</span>
          <span class="text-xs text-slate-400">\${new Date(a.updated_at||a.created_at).toLocaleDateString()}</span>
        </a>
      \`;
      $("a", li).addEventListener("click", async (e)=>{
        e.preventDefault();
        await openArticle(a.id);
      });
      return li;
    }

    function fillFolderSelects(folders){
      // creation modal
      const s1 = $("#create-folder");
      s1.innerHTML = '<option value="">未分类</option>';
      folders.forEach(f=>{
        const op = document.createElement("option");
        op.value = f.id; op.textContent = f.name;
        s1.appendChild(op);
      });
      // move modal
      const s2 = $("#move-target");
      s2.innerHTML = '<option value="">未分类</option>';
      folders.forEach(f=>{
        const op = document.createElement("option");
        op.value = f.id; op.textContent = f.name;
        s2.appendChild(op);
      });
    }

    // --------------- 创建/编辑/保存 --------------
    $("#btn-new-folder").addEventListener("click", ()=> openCreateModal("folder"));
    $("#btn-new-article").addEventListener("click", ()=> openCreateModal("text"));

    function openCreateModal(type){
      $("#create-title").value = "";
      $("#create-type").value = type;
      show("#creation-modal");
    }

    // 关闭所有 modal
    $$("#modals [data-close]").forEach(btn => btn.addEventListener("click", ()=>{
      $$("#modals > div").forEach(d=> hide(d));
    }));

    $("#confirm-create").addEventListener("click", async ()=>{
      const type = $("#create-type").value;
      const title = $("#create-title").value.trim() || (type==='folder'?'新建文件夹':'新建文章');
      const folder_id = $("#create-folder").value || null;
      if (type === "folder"){
        await collFolders().add({ id: crypto.randomUUID(), name: title, created_at: Date.now() });
      }else if (type === "text"){
        const now = Date.now();
        await collArticles().add({ id: crypto.randomUUID(), title, type: "text", content: "", folder_id, created_at: now, updated_at: now });
      }else if (type === "pdf"){
        const now = Date.now();
        await collArticles().add({ id: crypto.randomUUID(), title, type: "pdf", pdf_key: "", folder_id, created_at: now, updated_at: now });
      }
      hide("#creation-modal");
      await refreshTree();
    });

    async function openArticle(id){
      const { data } = await collArticles().where({ id }).get();
      if(!data?.length){ toast("文章不存在"); return; }
      current = data[0];
      setText("#current-title", current.title || "(未命名)");
      hide("#welcome-view");
      show("#article-view");

      // 切换按钮
      hide("#btn-edit"); hide("#btn-save"); hide("#btn-export"); hide("#pdf-controls");
      if (current.type === "text"){
        show("#richtext-editor-view"); hide("#pdf-reader-view");
        if (!quill){
          quill = new Quill("#editor", {
            theme: 'snow',
            modules: {
              toolbar: [
                [{ header: [1,2,3,false] }],
                ['bold','italic','underline','strike'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['blockquote','code-block'],
                ['link','image'],
                [{ color: [] }, { background: [] }],
                ['clean']
              ]
            }
          });
        }
        quill.setContents(current.content || []);
        show("#btn-save"); show("#btn-export"); show("#btn-edit");
      }else{
        hide("#richtext-editor-view"); show("#pdf-reader-view");
        show("#pdf-controls"); show("#btn-export");
        await renderPDF(current.pdf_key);
      }
      feather.replace();
    }

    // 保存
    $("#btn-save").addEventListener("click", async ()=>{
      if (!current) return;
      if (current.type === "text"){
        const delta = quill.getContents();
        await collArticles().where({ id: current.id }).update({ content: delta, updated_at: Date.now() });
        toast("已保存");
        await refreshTree();
      }
    });

    // 导出
    $("#btn-export").addEventListener("click", async ()=>{
      if (!current) return;
      if (current.type === "text"){
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ unit: 'px', format: 'a4' });
        const node = document.querySelector("#editor");
        const canvas = await html2canvas(node);
        const img = canvas.toDataURL("image/png");
        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();
        const ratio = Math.min(pageW / canvas.width, pageH / canvas.height);
        pdf.addImage(img, 'PNG', 0, 0, canvas.width*ratio, canvas.height*ratio);
        pdf.save((current.title||"note") + ".pdf");
      }else if (current.type === "pdf"){
        // 直接下载 COS 上的原文件
        const a = document.createElement("a");
        a.href = await getCosUrl(current.pdf_key);
        a.download = (current.title || "note") + ".pdf";
        a.click();
      }
    });

    // PDF 渲染
    let pdfDoc = null, currentPage = 1;
    async function renderPDF(key){
      if(!key){ $("#pdf-container").innerHTML = '<div class="text-center text-slate-400 py-8">还没有上传 PDF</div>'; return; }
      const url = await getCosUrl(key);
      pdfDoc = await pdfjsLib.getDocument(url).promise;
      currentPage = 1;
      await renderPage(currentPage);
      setText("#page-info", \`\${currentPage}/\${pdfDoc.numPages}\`);
    }

    async function renderPage(num){
      const page = await pdfDoc.getPage(num);
      const viewport = page.getViewport({ scale: 1.2 });
      const canvas = document.createElement("canvas");
      canvas.className = "pdf-page";
      canvas.width = viewport.width; canvas.height = viewport.height;
      const ctx = canvas.getContext("2d");
      await page.render({ canvasContext: ctx, viewport }).promise;
      $("#pdf-container").innerHTML = "";
      $("#pdf-container").appendChild(canvas);
    }

    $("#btn-prev-page").addEventListener("click", async ()=>{
      if (pdfDoc && currentPage>1){ currentPage--; await renderPage(currentPage); setText("#page-info", \`\${currentPage}/\${pdfDoc.numPages}\`); }
    });
    $("#btn-next-page").addEventListener("click", async ()=>{
      if (pdfDoc && currentPage<pdfDoc.numPages){ currentPage++; await renderPage(currentPage); setText("#page-info", \`\${currentPage}/\${pdfDoc.numPages}\`); }
    });

    // --------------- COS 上传/URL --------------
    async function uploadToCOS(file, key){
      return new Promise((resolve, reject)=>{
        cos.putObject({
          Bucket: CONFIG.cos.bucket,
          Region: CONFIG.cos.region,
          Key: key,
          Body: file
        }, (err, data)=>{
          if (err) reject(err);
          else resolve(data);
        });
      });
    }

    async function getCosUrl(key){
      return cos.getObjectUrl({
        Bucket: CONFIG.cos.bucket,
        Region: CONFIG.cos.region,
        Key: key,
        Sign: true
      }, (err, data)=>{});
    }

    // --------------- 导入 PDF --------------
    $("#import-pdf-input").addEventListener("change", async (e)=>{
      const f = e.target.files[0];
      if (!f){ return; }
      if (!current || current.type!=="pdf"){ toast("请选择一个 PDF 文章再导入"); return; }
      try{
        const key = \`pdf/\${current.id}/\${encodeURIComponent(f.name)}\`;
        await uploadToCOS(f, key);
        await collArticles().where({ id: current.id }).update({ pdf_key: key, updated_at: Date.now() });
        toast("PDF 已上传");
        await openArticle(current.id);
      }catch(err){
        console.error(err); toast("上传失败");
      }finally{
        e.target.value = "";
      }
    });

    // --------------- 备份导入/导出 --------------
    $("#btn-export-backup").addEventListener("click", async ()=>{
      const folders = (await collFolders().get()).data || [];
      const articles = (await collArticles().get()).data || [];
      const blob = new Blob([JSON.stringify({ folders, articles }, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "cloud-notes-backup.json";
      a.click();
    });

    $("#import-backup-input").addEventListener("change", async (e)=>{
      const f = e.target.files[0];
      if (!f) return;
      const txt = await f.text();
      try{
        const data = JSON.parse(txt);
        // 清空再导入（简单实现）
        const allFolders = (await collFolders().get()).data || [];
        const allArticles = (await collArticles().get()).data || [];
        for (const d of allFolders){ await collFolders().where({ id: d.id }).remove(); }
        for (const d of allArticles){ await collArticles().where({ id: d.id }).remove(); }

        if (Array.isArray(data.folders)){
          for (const r of data.folders){ await collFolders().add(r); }
        }
        if (Array.isArray(data.articles)){
          for (const r of data.articles){ await collArticles().add(r); }
        }
        toast("导入完成");
        await refreshTree();
      }catch(err){
        console.error(err);
        toast("备份文件格式不正确");
      }finally{
        e.target.value = "";
      }
    });

    // 自动登录
    (async ()=>{
      feather.replace();
      try{
        const state = await auth.getLoginState?.();
        if (state && state.credential){ await enterApp(); }
      }catch(_){}
    })();
  </script>
</body>
</html>
