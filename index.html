<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cloud Notes</title>

  <!-- Tailwind（开发期可用；生产建议用 PostCSS 构建） -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Quill 富文本编辑器 -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

  <!-- PDF.js（显示层） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    /* 指定 worker（与上面版本保持一致） */
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>

  <!-- jsPDF + html2canvas（导出 PDF 用） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Feather 图标 -->
  <script src="https://unpkg.com/feather-icons"></script>

  <!-- COS JS SDK v5（前端直传，需要 STS） -->
  <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>

  <!-- CloudBase Web SDK（全量包，包含 auth/database 等模块） -->
  <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.15.1/cloudbase.full.js"></script>

  <style>
    .card { @apply bg-white rounded-2xl shadow-lg; }
    .btn { @apply inline-flex items-center justify-center rounded-xl px-4 py-2 font-medium transition; }
    .btn-primary { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
    .btn-ghost { @apply hover:bg-slate-100; }
    .badge { @apply inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium bg-slate-100 text-slate-600; }
    .menu { @apply absolute z-50 bg-white rounded-xl shadow-lg border border-slate-200 py-1 min-w-[160px]; }
    .menu button { @apply w-full text-left px-3 py-2 hover:bg-slate-50; }
    .hidden-important { display: none !important; }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-800">
<!-- ===================== 片段 1/3：页面骨架 + 认证视图 + 主布局 ===================== -->

<!-- 认证视图 -->
<section id="auth-view" class="min-h-screen grid place-items-center">
  <div class="card w-[560px] max-w-[94vw] p-8">
    <div class="flex items-center justify-between border-b pb-3">
      <div class="text-xl font-semibold">欢迎使用 Cloud Notes</div>
      <div class="space-x-2">
        <button id="tab-login"  class="btn btn-ghost data-[active=true]:bg-slate-100" data-active="true">登录</button>
        <button id="tab-register" class="btn btn-ghost">注册</button>
      </div>
    </div>

    <!-- 登录表单 -->
    <form id="login-form" class="mt-6 space-y-4">
      <div>
        <label class="block mb-1 text-sm text-slate-600">邮箱</label>
        <input id="login-email" type="email" required class="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-100" />
      </div>
      <div>
        <label class="block mb-1 text-sm text-slate-600">密码</label>
        <input id="login-password" type="password" required class="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-100" />
      </div>
      <button class="btn btn-primary w-full" type="submit">登录</button>
    </form>

    <!-- 注册表单 -->
    <form id="register-form" class="mt-6 space-y-4 hidden">
      <div>
        <label class="block mb-1 text-sm text-slate-600">邮箱</label>
        <input id="register-email" type="email" required class="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-100" />
      </div>
      <div>
        <label class="block mb-1 text-sm text-slate-600">密码</label>
        <input id="register-password" type="password" minlength="6" required class="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-100" />
      </div>
      <button class="btn btn-primary w-full" type="submit">注册</button>
      <p class="text-xs text-slate-500">注册后系统会发送验证邮件到你的邮箱</p>
    </form>
  </div>
</section>

<!-- 主应用视图（UI骨架，功能在 2/3、3/3 里接上） -->
<section id="main-app-view" class="hidden min-h-screen">
  <div class="grid lg:grid-cols-[280px_1fr] grid-cols-1 gap-0">
    <!-- 侧边栏 -->
    <aside id="sidebar" class="card lg:rounded-none lg:rounded-r-2xl lg:min-h-screen p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div id="avatar" class="w-10 h-10 rounded-full grid place-items-center bg-indigo-100 text-indigo-700 font-bold"></div>
          <div>
            <div id="user-email" class="text-sm font-medium"></div>
            <div class="text-xs text-slate-500">已登录</div>
          </div>
        </div>
        <button id="btn-signout" class="btn btn-ghost" title="退出登录"><i data-feather="log-out"></i></button>
      </div>

      <div class="mt-6 grid grid-cols-2 gap-2">
        <button id="btn-new-folder"  class="btn bg-slate-100 hover:bg-slate-200"><i data-feather="folder-plus" class="mr-2"></i>新建文件夹</button>
        <button id="btn-new-article" class="btn bg-slate-100 hover:bg-slate-200"><i data-feather="file-plus"   class="mr-2"></i>新建文章</button>
      </div>

      <div class="mt-4">
        <div class="flex items-center justify-between mb-2">
          <div class="font-medium">我的笔记</div>
          <button id="btn-data-toggle" class="btn btn-ghost text-sm"><i data-feather="hard-drive" class="mr-2"></i>数据管理</button>
        </div>
        <nav id="file-tree" class="text-sm space-y-1 select-none">
          <!-- 文件夹/文章项由 JS 渲染（片段 2/3） -->
        </nav>
      </div>

      <div id="data-panel" class="mt-4 hidden border-t pt-3 space-y-2">
        <label class="btn w-full bg-slate-100 hover:bg-slate-200">
          <input id="input-import-pdf" class="hidden" type="file" accept="application/pdf" />
          <i data-feather="file-text" class="mr-2"></i>导入 PDF
        </label>
        <label class="btn w-full bg-slate-100 hover:bg-slate-200">
          <input id="input-import-backup" class="hidden" type="file" accept="application/json" />
          <i data-feather="upload" class="mr-2"></i>导入备份
        </label>
        <button id="btn-export-backup" class="btn w-full bg-slate-100 hover:bg-slate-200"><i data-feather="download" class="mr-2"></i>导出备份</button>
      </div>
    </aside>

    <!-- 主内容区 -->
    <main id="main-content" class="min-h-screen">
      <header class="card rounded-none lg:rounded-none lg:rounded-b-2xl p-4 flex items-center justify-between sticky top-0 z-40">
        <div class="flex items-center gap-3">
          <button id="btn-toggle-sidebar" class="btn btn-ghost lg:hidden"><i data-feather="menu"></i></button>
          <div id="current-title" class="text-lg font-semibold truncate max-w-[50vw]">欢迎</div>
        </div>

        <!-- PDF 翻页控件（仅 PDF 模式显示：片段 2/3 接逻辑） -->
        <div id="pdf-controls" class="hidden items-center gap-2">
          <button id="btn-pdf-prev" class="btn btn-ghost"><i data-feather="chevron-left"></i></button>
          <span class="badge"><span id="pdf-page">1</span>/<span id="pdf-total">1</span></span>
          <button id="btn-pdf-next" class="btn btn-ghost"><i data-feather="chevron-right"></i></button>
        </div>

        <div class="flex items-center gap-2">
          <button id="btn-edit"  class="btn btn-ghost hidden"><i data-feather="edit-3" class="mr-2"></i>编辑</button>
          <button id="btn-save"  class="btn btn-primary hidden"><i data-feather="save" class="mr-2"></i>保存</button>
          <button id="btn-export" class="btn btn-ghost hidden"><i data-feather="share" class="mr-2"></i>导出</button>
          <button id="btn-more"   class="btn btn-ghost"><i data-feather="more-horizontal"></i></button>
        </div>
      </header>

      <section id="welcome-view" class="p-10 grid place-items-center">
        <div class="text-center max-w-[680px]">
          <div class="text-2xl font-semibold mb-3">开始创作你的第一篇笔记</div>
          <p class="text-slate-500">从左侧“新建文章”或“导入 PDF”开始，也可先创建文件夹来分类管理。</p>
        </div>
      </section>

      <section id="article-view" class="hidden p-6">
        <!-- 富文本编辑器容器（片段 2/3 初始化） -->
        <div id="richtext-editor-view" class="hidden">
          <div id="quill-toolbar" class="q-toolbar border rounded-t-xl">
            <span class="ql-formats">
              <select class="ql-header">
                <option selected></option>
                <option value="1"></option>
                <option value="2"></option>
              </select>
              <select class="ql-font"></select>
              <select class="ql-size"></select>
            </span>
            <span class="ql-formats">
              <button class="ql-bold"></button>
              <button class="ql-italic"></button>
              <button class="ql-underline"></button>
              <button class="ql-strike"></button>
            </span>
            <span class="ql-formats">
              <select class="ql-color"></select>
              <select class="ql-background"></select>
            </span>
            <span class="ql-formats">
              <button class="ql-list" value="ordered"></button>
              <button class="ql-list" value="bullet"></button>
              <select class="ql-align"></select>
            </span>
            <span class="ql-formats">
              <button id="btn-insert-image" type="button"><i data-feather="image"></i></button>
            </span>
          </div>
          <div id="quill-editor" class="h-[60vh] bg-white border-x border-b rounded-b-xl"></div>
        </div>

        <!-- PDF 阅读器画布 -->
        <div id="pdf-reader-view" class="hidden">
          <canvas id="pdf-canvas" class="bg-white rounded-2xl shadow border mx-auto block max-w-full"></canvas>
        </div>
      </section>
    </main>
  </div>
</section>

<!-- Modals（创建/重命名/移动/确认） -->
<div id="creation-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden-important">
  <div class="card max-w-md mx-auto mt-32 p-6">
    <div class="text-lg font-semibold mb-3" id="creation-title">新建</div>
    <input id="creation-input" class="w-full rounded-xl border px-3 py-2 mb-4" placeholder="输入名称…" />
    <div class="flex justify-end gap-2">
      <button data-close="#creation-modal" class="btn">取消</button>
      <button id="creation-confirm" class="btn btn-primary">确定</button>
    </div>
  </div>
</div>

<div id="rename-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden-important">
  <div class="card max-w-md mx-auto mt-32 p-6">
    <div class="text-lg font-semibold mb-3">重命名</div>
    <input id="rename-input" class="w-full rounded-xl border px-3 py-2 mb-4" />
    <div class="flex justify-end gap-2">
      <button data-close="#rename-modal" class="btn">取消</button>
      <button id="rename-confirm" class="btn btn-primary">确定</button>
    </div>
  </div>
</div>

<div id="move-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden-important">
  <div class="card max-w-md mx-auto mt-32 p-6">
    <div class="text-lg font-semibold mb-3">移动到</div>
    <select id="move-select" class="w-full rounded-xl border px-3 py-2 mb-4"></select>
    <div class="flex justify-end gap-2">
      <button data-close="#move-modal" class="btn">取消</button>
      <button id="move-confirm" class="btn btn-primary">确定</button>
    </div>
  </div>
</div>

<div id="confirm-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden-important">
  <div class="card max-w-md mx-auto mt-32 p-6">
    <div id="confirm-text" class="mb-4">确定要执行该操作吗？</div>
    <div class="flex justify-end gap-2">
      <button data-close="#confirm-modal" class="btn">取消</button>
      <button id="confirm-yes" class="btn btn-primary">确定</button>
    </div>
  </div>
</div>

<!-- 右上角 Toast + 右键菜单容器 -->
<div id="toast" class="fixed right-4 top-4"></div>
<div id="context-menu" class="menu hidden"></div>

<!-- ============ 应用脚本（片段 1/3：CloudBase/COS 初始化 + 认证 + 视图切换） ============ -->
<script>
const CONFIG = {
  envId: "molijun-0gtahyghc6271173",                                  // CloudBase 环境
  cosBucket: "notes-1317231591",                                       // COS 桶名（BucketName-APPID）
  cosRegion: "ap-guangzhou",                                           // COS 区域
  stsUrl: "https://molijun-0gtahyghc6271173-1317231591.ap-shanghai.app.tcloudbase.com/api/sts", // STS HTTPS
};

// --- CloudBase 初始化（全量包已含 auth/database 模块） ---
let app, auth, db;
try {
  app = cloudbase.init({ env: CONFIG.envId });
  auth = app.auth({ persistence: "local" }); // 持久化登录
  db = app.database();
} catch (e) {
  console.error("CloudBase 初始化失败：", e);
  showToast("CloudBase 初始化失败", "error");
}

// --- COS 客户端（使用 STS 动态授权） ---
let cos = new COS({
  getAuthorization: function (options, callback) {
    fetch(CONFIG.stsUrl, { credentials: "include" })
      .then(res => res.json())
      .then(data => {
        const cred = data.credentials || data.data?.credentials;
        if (!cred) throw new Error("STS 响应缺少 credentials");
        callback({
          TmpSecretId: cred.tmpSecretId,
          TmpSecretKey: cred.tmpSecretKey,
          SecurityToken: cred.sessionToken || cred.token || cred.SecurityToken,
          StartTime: data.startTime || Math.floor(Date.now()/1000),
          ExpiredTime: data.expiredTime || (Math.floor(Date.now()/1000) + 1800),
        });
      })
      .catch(err => {
        console.error("获取 STS 失败", err);
        showToast("获取上传凭证失败", "error");
      });
  }
});

// ---- 便捷函数 ----
function $(s){ return document.querySelector(s); }
function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }
function toggle(el){ el.classList.toggle("hidden"); }
function iconRefresh(){ feather.replace(); }
function showToast(text, type="info", ms=2400){
  const box=document.createElement("div");
  box.className="card px-4 py-3 mb-3 border "+(type==="error"?"border-red-200":"border-slate-200");
  box.innerHTML=`<div class="flex items-center gap-2">
    <i data-feather="${type==='error'?'alert-triangle':'check-circle'}"></i>
    <span>${text}</span></div>`;
  $("#toast").appendChild(box);
  iconRefresh();
  setTimeout(()=>box.remove(), ms);
}

// ---- 认证视图切换 ----
const tabLogin=$("#tab-login"), tabRegister=$("#tab-register");
const loginForm=$("#login-form"), registerForm=$("#register-form");
tabLogin.addEventListener("click", ()=>{ tabLogin.dataset.active="true"; tabRegister.dataset.active="false"; hide(registerForm); show(loginForm); });
tabRegister.addEventListener("click", ()=>{ tabRegister.dataset.active="true"; tabLogin.dataset.active="false"; hide(loginForm); show(registerForm); });

// ---- 登录 ----
loginForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email=$("#login-email").value.trim();
  const password=$("#login-password").value;
  try{
    await auth.signInWithEmailAndPassword(email,password);
    showToast("登录成功");
    await enterApp();
  }catch(err){
    console.error(err);
    showToast(err?.message||err?.code||"登录失败","error");
  }
});

// ---- 注册 ----
registerForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email=$("#register-email").value.trim();
  const password=$("#register-password").value;
  try{
    await auth.signUpWithEmailAndPassword(email,password);
    showToast("注册成功，验证邮件已发送");
    tabLogin.click();
  }catch(err){
    console.error(err);
    showToast(err?.message||err?.code||"注册失败","error");
  }
});

// ---- 进入主应用视图（片段 2/3 会在这里挂业务逻辑） ----
async function enterApp(){
  const state = await auth.getLoginState();
  if(!state || !auth.currentUser){ showToast("未登录","error"); return; }
  const email = auth.currentUser.username || auth.currentUser.email || "用户";
  $("#user-email").textContent = email;
  $("#avatar").textContent = (email[0]||"U").toUpperCase();
  hide($("#auth-view")); show($("#main-app-view"));
  $("#current-title").textContent = "欢迎";
  hide($("#article-view")); show($("#welcome-view"));
  iconRefresh();
  // 👉 片段 2/3：loadFoldersAndArticles();
}

// ---- 登出 ----
$("#btn-signout").addEventListener("click", async ()=>{
  try{ await auth.signOut(); showToast("已退出登录"); show($("#auth-view")); hide($("#main-app-view")); }
  catch(e){ console.error(e); showToast("退出失败","error"); }
});

// 侧栏与数据面板开关（功能在片段 2/3 接上）
$("#btn-data-toggle").addEventListener("click", ()=>toggle($("#data-panel")));
$("#btn-toggle-sidebar").addEventListener("click", ()=>$("#sidebar").classList.toggle("hidden"));

// ---- 启动：如已登录则直接进入主视图 ----
(async function bootstrap(){
  try{ const s=await auth.getLoginState(); if(s) enterApp(); }catch(e){}
  iconRefresh();
})();
</script>
<!-- ===================== 片段 1/3 结束（不要在此处写 </body></html>） ===================== -->
<!-- ============ 片段 2/3：数据层 + 文件树 + 编辑器 + COS 上传 + PDF 阅读 + 备份 ============ -->
<script>
/* --------------------------- 全局状态 --------------------------- */
const COLL = { folders: "folders", articles: "articles" };
let gFolders = [];      // [{_id, name, user_id, created_at}]
let gArticles = [];     // [{_id, title, type:'text'|'pdf', content_html?, cos_key?, folder_id?, user_id, created_at, updated_at}]
let currentArticle = null;
let quill = null;
let isEditing = false;
let editBaseUpdatedAt = 0; // 进入编辑时的云端更新时间，用于冲突检测

/* --------------------------- 小工具 --------------------------- */
const uid = () => (auth?.currentUser?.uid || auth?.currentUser?.uid || auth?.currentUser?.userId || ""); // 以 SDK 返回为准
function now() { return Date.now(); }
function fmt(ts) {
  const d = new Date(ts); const pad = (n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function stripHtml(html){ const div=document.createElement("div"); div.innerHTML=html||""; return (div.textContent||"").trim(); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* --------------------------- 文件树渲染 --------------------------- */
async function loadFoldersAndArticles() {
  const user = uid();
  if (!user) return;

  try {
    const [fs, as] = await Promise.all([
      db.collection(COLL.folders).where({ user_id: user }).get(),
      db.collection(COLL.articles).where({ user_id: user }).get(),
    ]); // 依据 CloudBase Web DB 文档：collection().where().get() 获取数据 :contentReference[oaicite:0]{index=0}

    gFolders = (fs?.data || []).sort((a,b)=>a.created_at-b.created_at);
    gArticles = (as?.data || []).sort((a,b)=>b.updated_at - a.updated_at);

    renderFileTree();
  } catch (e) {
    console.error(e);
    showToast("加载数据失败","error");
  }
}

function renderFileTree() {
  const tree = $("#file-tree");
  tree.innerHTML = "";

  const byFolder = new Map();
  byFolder.set(null, []); // 未分类
  gFolders.forEach(f => byFolder.set(f._id, []));
  gArticles.forEach(a => {
    const list = byFolder.get(a.folder_id || null) || [];
    list.push(a); byFolder.set(a.folder_id || null, list);
  });

  // Helper: 渲染一篇文章行
  const renderArticleRow = (a) => {
    const row = document.createElement("button");
    row.className = "w-full flex items-center justify-between px-2 py-2 hover:bg-slate-50 rounded-lg";
    row.dataset.id = a._id;
    row.innerHTML = `
      <div class="flex items-center gap-2">
        <i data-feather="${a.type==='pdf'?'file-text':'file'}" class="shrink-0"></i>
        <div class="text-left">
          <div class="text-[13px] leading-5">${a.title || "(未命名)"}</div>
          <div class="text-[11px] text-slate-500">${fmt(a.updated_at || a.created_at)}</div>
        </div>
      </div>
      <span class="badge hidden" data-role="draft-dot">草稿</span>
    `;
    row.addEventListener("click", () => openArticle(a._id));
    return row;
  };

  // 未分类
  if ((byFolder.get(null) || []).length) {
    const h = document.createElement("div");
    h.className = "mt-3 mb-1 text-xs text-slate-500 px-1"; h.textContent = "未分类";
    tree.appendChild(h);
    byFolder.get(null).forEach(a => tree.appendChild(renderArticleRow(a)));
  }

  // 各文件夹
  gFolders.forEach(f => {
    const head = document.createElement("div");
    head.className = "flex items-center justify-between mt-4 mb-1 px-1";
    head.innerHTML = `
      <div class="flex items-center gap-2">
        <i data-feather="folder"></i><span class="text-sm font-medium">${f.name}</span>
      </div>
    `;
    tree.appendChild(head);

    const list = byFolder.get(f._id) || [];
    if (!list.length) {
      const empty = document.createElement("div");
      empty.className = "text-xs text-slate-400 px-2 py-1"; empty.textContent = "（空）";
      tree.appendChild(empty);
    } else {
      list.forEach(a => tree.appendChild(renderArticleRow(a)));
    }
  });

  iconRefresh();
  // 草稿提示
  markDraftBadges();
}

function markDraftBadges() {
  const user = uid();
  if (!user) return;
  document.querySelectorAll("#file-tree [data-role='draft-dot']").forEach(el => el.classList.add("hidden"));
  gArticles.forEach(a => {
    const raw = localStorage.getItem(`draft:${user}:${a._id}`);
    if (!raw) return;
    try {
      const draft = JSON.parse(raw);
      if (draft?.ts && draft.ts > (a.updated_at || 0)) {
        const row = document.querySelector(`#file-tree [data-id="${a._id}"] [data-role='draft-dot']`);
        if (row) row.classList.remove("hidden");
      }
    } catch {}
  });
}

/* --------------------------- 新建文件夹 / 文章 --------------------------- */
$("#btn-new-folder").addEventListener("click", () => {
  openCreationModal("新建文件夹", "新建文件夹", async (name) => {
    const user = uid(); if (!user) return;
    const res = await db.collection(COLL.folders).add({ name, user_id: user, created_at: now() });
    showToast("文件夹已创建");
    await loadFoldersAndArticles();
  });
});

$("#btn-new-article").addEventListener("click", () => {
  openCreationModal("新建文章", "未命名文章", async (title) => {
    const user = uid(); if (!user) return;
    const res = await db.collection(COLL.articles).add({
      title, type: "text", content_html: "<p><br/></p>",
      user_id: user, folder_id: null, created_at: now(), updated_at: now()
    });
    showToast("文章已创建");
    await loadFoldersAndArticles();
  });
});

/* --------------------------- 打开文章 --------------------------- */
async function openArticle(id) {
  const target = gArticles.find(a => a._id === id);
  if (!target) return;
  currentArticle = target;
  $("#current-title").textContent = target.title || "未命名";
  hide($("#welcome-view")); show($("#article-view"));

  // 切换按钮可见性
  $("#btn-export").classList.remove("hidden");
  if (target.type === "text") {
    $("#pdf-controls").classList.add("hidden");
    show($("#richtext-editor-view")); hide($("#pdf-reader-view"));
    await ensureQuill();
    quill.setContents([]); // 清空
    const serverHtml = target.content_html || "<p><br/></p>";
    const restored = tryRestoreLocalDraft(serverHtml, target);
    quill.root.innerHTML = restored;
    setEditMode(false);
  } else {
    hide($("#richtext-editor-view")); show($("#pdf-reader-view"));
    $("#pdf-controls").classList.remove("hidden");
    await renderPdfFromCOS(target.cos_key);
    setEditMode(false); // PDF 不可编辑
    $("#btn-edit").classList.add("hidden");
    $("#btn-save").classList.add("hidden");
  }
  iconRefresh();
}

/* --------------------------- 富文本编辑器 + 图片上传 --------------------------- */
async function ensureQuill() {
  if (quill) return;
  quill = new Quill("#quill-editor", {
    theme: "snow",
    modules: { toolbar: "#quill-toolbar" },
    placeholder: "开始记录你的想法……"
  });

  // 自定义“插入图片”：选择文件 -> 上传 COS -> 插入链接
  $("#btn-insert-image").addEventListener("click", () => {
    const input = document.createElement("input");
    input.type = "file"; input.accept = "image/*";
    input.onchange = async () => {
      const file = input.files[0];
      if (!file) return;
      try {
        const key = `${uid()}/images/${Date.now()}-${encodeURIComponent(file.name)}`;
        // 使用 putObject / uploadFile 上传（官方 SDK 示例支持多种方式）:contentReference[oaicite:1]{index=1}
        await new Promise((resolve, reject) => {
          cos.uploadFile({
            Bucket: CONFIG.cosBucket,
            Region: CONFIG.cosRegion,
            Key: key,
            Body: file,
            SliceSize: 1024 * 1024, // >1MB 分块
            onProgress: (info)=>{ /* 可显示进度 */ },
          }, (err, data) => err ? reject(err) : resolve(data));
        });
        const url = await getSignedUrl(key); // 生成预签名 URL 以便私有桶访问 :contentReference[oaicite:2]{index=2}
        const range = quill.getSelection(true);
        quill.insertEmbed(range.index, "image", url, "user");
        quill.setSelection(range.index + 1);
      } catch (e) {
        console.error(e); showToast("图片上传失败","error");
      }
    };
    input.click();
  });
}

function setEditMode(on) {
  isEditing = !!on;
  const isText = currentArticle?.type === "text";
  $("#btn-edit").classList.toggle("hidden", !isText || on);
  $("#btn-save").classList.toggle("hidden", !isText || !on);
  if (quill) quill.enable(!!on);
  if (on) editBaseUpdatedAt = currentArticle?.updated_at || 0;
}
$("#btn-edit").addEventListener("click", ()=> setEditMode(true));

$("#btn-save").addEventListener("click", async ()=>{
  if (!currentArticle || currentArticle.type !== "text") return;
  try {
    // 冲突检测：先读最新 updated_at 再决定是否保存 :contentReference[oaicite:3]{index=3}
    const fresh = await db.collection(COLL.articles).doc(currentArticle._id).get();
    const latest = fresh?.data?.updated_at || 0;
    if (latest > editBaseUpdatedAt) {
      const htmlNow = quill.root.innerHTML;
      await navigator.clipboard?.writeText(stripHtml(htmlNow)).catch(()=>{});
      showToast("检测到内容已在别处更新，已复制你的草稿到剪贴板","error");
      currentArticle = fresh.data; // 覆盖到最新
      quill.root.innerHTML = currentArticle.content_html || "<p><br/></p>";
      setEditMode(false);
      return;
    }

    const html = quill.root.innerHTML;
    await db.collection(COLL.articles).doc(currentArticle._id).update({
      content_html: html, updated_at: now()
    });
    // 清除草稿
    localStorage.removeItem(`draft:${uid()}:${currentArticle._id}`);
    showToast("保存成功");
    setEditMode(false);
    await loadFoldersAndArticles();
  } catch (e) {
    console.error(e); showToast("保存失败","error");
  }
});

// 本地草稿：编辑时持续保存
setInterval(()=>{
  if (!isEditing || !currentArticle || currentArticle.type !== "text" || !quill) return;
  const key = `draft:${uid()}:${currentArticle._id}`;
  const html = quill.root.innerHTML;
  localStorage.setItem(key, JSON.stringify({ ts: now(), html }));
  markDraftBadges();
}, 2000);

function tryRestoreLocalDraft(serverHtml, article) {
  const key = `draft:${uid()}:${article._id}`;
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return serverHtml;
    const draft = JSON.parse(raw);
    if (draft?.ts > (article.updated_at || 0)) {
      // 草稿更新更近，直接恢复
      showToast("已加载本地草稿");
      return draft.html || serverHtml;
    }
  } catch {}
  return serverHtml;
}

/* --------------------------- PDF 导入 / 阅读 --------------------------- */
$("#input-import-pdf").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0]; e.target.value = "";
  if (!file) return;
  try {
    const key = `${uid()}/pdfs/${Date.now()}-${encodeURIComponent(file.name)}`;
    await new Promise((resolve, reject) => {
      cos.uploadFile({
        Bucket: CONFIG.cosBucket, Region: CONFIG.cosRegion,
        Key: key, Body: file, SliceSize: 1024 * 1024 * 3,
      }, (err, data)=> err ? reject(err) : resolve(data));
    }); // 高级上传/分块上传，见 COS JS SDK 示例 :contentReference[oaicite:4]{index=4}

    const title = file.name.replace(/\.(pdf)$/i,"");
    const user = uid();
    await db.collection(COLL.articles).add({
      title, type: "pdf", cos_key: key, user_id: user, folder_id: null,
      created_at: now(), updated_at: now()
    });
    showToast("PDF 已导入");
    await loadFoldersAndArticles();
  } catch (e) {
    console.error(e); showToast("PDF 导入失败","error");
  }
});

let pdfDoc=null, pdfPage=1, pdfTotal=1, pdfRendering=false;
async function renderPdfFromCOS(key) {
  const url = await getSignedUrl(key);  // 预签名 URL 用于私有读 :contentReference[oaicite:5]{index=5}
  const loading = pdfjsLib.getDocument(url); // 标准 PDF.js 加载并渲染页面 :contentReference[oaicite:6]{index=6}
  pdfDoc = await loading.promise;
  pdfTotal = pdfDoc.numPages; pdfPage = 1;
  $("#pdf-total").textContent = String(pdfTotal);
  await renderPdfPage();
}
async function renderPdfPage() {
  if (!pdfDoc) return;
  const canvas = $("#pdf-canvas"), ctx = canvas.getContext("2d");
  const page = await pdfDoc.getPage(pdfPage);
  const viewport = page.getViewport({ scale: 1.5 });
  canvas.width = viewport.width; canvas.height = viewport.height;
  await page.render({ canvasContext: ctx, viewport }).promise;
  $("#pdf-page").textContent = String(pdfPage);
}
$("#btn-pdf-prev").addEventListener("click", async ()=>{ if(pdfPage>1){ pdfPage--; await renderPdfPage(); }});
$("#btn-pdf-next").addEventListener("click", async ()=>{ if(pdfPage<pdfTotal){ pdfPage++; await renderPdfPage(); }});

async function getSignedUrl(key, inline=false){
  return await new Promise((resolve, reject)=>{
    cos.getObjectUrl({
      Bucket: CONFIG.cosBucket, Region: CONFIG.cosRegion, Key: key, Sign: true,
      Headers: inline ? { "Content-Disposition": "inline" } : undefined
    }, (err, data)=> err ? reject(err) : resolve(data?.Url || data?.url));
  }); // getObjectUrl 生成带签名的可访问 URL :contentReference[oaicite:7]{index=7}
}

/* --------------------------- 导入/导出备份（JSON） --------------------------- */
$("#btn-export-backup").addEventListener("click", async ()=>{
  const user = uid(); if (!user) return;
  try{
    const [fs, as] = await Promise.all([
      db.collection(COLL.folders).where({ user_id: user }).get(),
      db.collection(COLL.articles).where({ user_id: user }).get()
    ]);
    const payload = {
      version: 1,
      exported_at: now(),
      folders: fs.data || [],
      articles: as.data || []
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `cloud-notes-backup-${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    showToast("已导出备份 JSON");
  }catch(e){ console.error(e); showToast("导出失败","error"); }
});

$("#input-import-backup").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0]; e.target.value = "";
  if (!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text || "{}");
    if (!data || !Array.isArray(data.articles) || !Array.isArray(data.folders)) throw new Error("格式不正确");
    if (!confirm("导入将清空你当前云端数据并完整恢复备份，是否继续？")) return;

    const user = uid(); if (!user) return;

    // 先清空
    await db.collection(COLL.articles).where({ user_id: user }).remove(); // CloudBase 支持 where().remove() 批量删除 :contentReference[oaicite:8]{index=8}
    await db.collection(COLL.folders).where({ user_id: user }).remove();

    // 再写入
    const tasks = [];
    (data.folders||[]).forEach(f=>{
      const {_id, ...rest} = f;
      tasks.push(db.collection(COLL.folders).add({ ...rest, user_id: user }));
    });
    (data.articles||[]).forEach(a=>{
      const {_id, user_id, ...rest} = a;
      tasks.push(db.collection(COLL.articles).add({ ...rest, user_id: user }));
    });
    await Promise.all(tasks);
    showToast("导入完成");
    await loadFoldersAndArticles();
  }catch(e){ console.error(e); showToast("导入失败","error"); }
});

/* --------------------------- 单篇导出（txt / pdf） --------------------------- */
$("#btn-export").addEventListener("click", async ()=>{
  if (!currentArticle) return;
  if (currentArticle.type === "text") {
    const html = quill ? quill.root.innerHTML : (currentArticle.content_html || "");
    // 弹一个简易选择（片段3会改为菜单）
    const asPdf = confirm("确定导出为 PDF 吗？（取消将导出为 TXT）");
    if (asPdf) {
      await exportArticleAsPDF(currentArticle.title || "未命名", html);
    } else {
      const blob = new Blob([stripHtml(html)], {type: "text/plain;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${(currentArticle.title||"note")}.txt`;
      a.click(); URL.revokeObjectURL(a.href);
    }
  } else {
    // PDF 笔记：直接下载原文件
    const url = await getSignedUrl(currentArticle.cos_key, false);
    const a = document.createElement("a");
    a.href = url; a.download = `${(currentArticle.title||"note")}.pdf`;
    a.click();
  }
});

async function exportArticleAsPDF(title, html) {
  // 用 jsPDF + html2canvas 快速导出
  const { jsPDF } = window.jspdf;
  const wrapper = document.createElement("div");
  wrapper.style.padding = "24px";
  wrapper.style.width = "794px"; // A4 96dpi approx
  wrapper.innerHTML = `<h1 style="font-size:20px;margin:0 0 12px 0;">${title}</h1>${html}`;
  document.body.appendChild(wrapper);
  const canvas = await html2canvas(wrapper, { scale: 2, useCORS: true });
  const img = canvas.toDataURL("image/png");
  const pdf = new jsPDF({ unit: "pt", format: "a4" });
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  // 等比缩放
  const imgWidth = pageWidth - 60, imgHeight = canvas.height * (imgWidth / canvas.width);
  let remaining = imgHeight, y = 30;
  pdf.addImage(img, "PNG", 30, y, imgWidth, Math.min(imgHeight, pageHeight-60));
  remaining -= (pageHeight - 60);
  while (remaining > 0) {
    pdf.addPage();
    y = 30 - (imgHeight - remaining);
    pdf.addImage(img, "PNG", 30, y, imgWidth, Math.min(imgHeight, pageHeight-60));
    remaining -= (pageHeight - 60);
  }
  pdf.save(`${title||"note"}.pdf`);
  wrapper.remove();
}

/* --------------------------- 创建弹窗（片段1已有 DOM，这里封装逻辑） --------------------------- */
function openCreationModal(title, placeholder, onConfirm){
  $("#creation-title").textContent = title;
  $("#creation-input").value = placeholder || ""; show($("#creation-modal"));
  $("#creation-confirm").onclick = async ()=>{
    const val = $("#creation-input").value.trim();
    if(!val){ showToast("请输入名称","error"); return;}
    hide($("#creation-modal"));
    try{ await onConfirm?.(val); }catch(e){ console.error(e); showToast("操作失败","error"); }
  };
}
document.querySelectorAll("[data-close='#creation-modal']").forEach(b=>b.addEventListener("click", ()=>hide($("#creation-modal"))));

/* --------------------------- 进入应用后加载数据 --------------------------- */
(async function afterEnterPatch(){
  // 如果用户已在片段1中进入主视图，这里注册一次性加载
  // 以及针对后续登录进入的情况，在 enterApp() 中会再调用它
  if ($("#main-app-view") && !$("#auth-view").classList.contains("hidden")) return;
})();

// 将函数暴露给片段1里的 enterApp 调用
window.loadFoldersAndArticles = loadFoldersAndArticles;

// 覆写片段1中的 enterApp 尾部调用
const _enterAppV1 = enterApp;
enterApp = async function(){
  await _enterAppV1();
  await loadFoldersAndArticles();
}
</script>
<!-- ===================== 片段 2/3 结束（不要在此处写 </body></html>） ===================== -->
<!-- ============ 片段 3/3：右键菜单 + 重命名/移动/删除 + 更多菜单 + 收尾 ============ -->
<script>
/* --------------------------- Modal 封装（重命名 / 移动 / 确认） --------------------------- */
function openRenameModal(initial, onConfirm){
  $("#rename-input").value = initial || "";
  show($("#rename-modal"));
  $("#rename-confirm").onclick = async ()=>{
    const val = $("#rename-input").value.trim();
    if(!val){ showToast("请输入新名称","error"); return; }
    hide($("#rename-modal"));
    try{ await onConfirm?.(val); }catch(e){ console.error(e); showToast("重命名失败","error"); }
  };
}
function openMoveModal(currentFolderId, onConfirm){
  const sel = $("#move-select");
  sel.innerHTML = `<option value="">未分类</option>` + gFolders.map(f=>`<option value="${f._id}">${f.name}</option>`).join("");
  sel.value = currentFolderId || "";
  show($("#move-modal"));
  $("#move-confirm").onclick = async ()=>{
    const val = sel.value || null;
    hide($("#move-modal"));
    try{ await onConfirm?.(val); }catch(e){ console.error(e); showToast("移动失败","error"); }
  };
}
function openConfirm(text, onYes){
  $("#confirm-text").textContent = text || "确定要执行该操作吗？";
  show($("#confirm-modal"));
  $("#confirm-yes").onclick = async ()=>{
    hide($("#confirm-modal"));
    try{ await onYes?.(); }catch(e){ console.error(e); showToast("操作失败","error"); }
  };
}
;["#rename-modal","#move-modal","#confirm-modal"].forEach(sel=>{
  document.querySelectorAll(`[data-close='${sel}']`).forEach(b=>b.addEventListener("click", ()=>hide($(sel))));
});

/* --------------------------- 上下文（右键）菜单 --------------------------- */
const ctxMenu = $("#context-menu");
let ctxMenuOutsideCloser = null;
function openContextMenu(items, x, y){
  ctxMenu.innerHTML = "";
  items.forEach(it=>{
    const btn = document.createElement("button");
    btn.textContent = it.label;
    btn.onclick = ()=>{ closeContextMenu(); it.action?.(); };
    ctxMenu.appendChild(btn);
  });
  ctxMenu.style.left = x + "px";
  ctxMenu.style.top  = y + "px";
  ctxMenu.classList.remove("hidden");
  if (ctxMenuOutsideCloser) { document.removeEventListener("click", ctxMenuOutsideCloser); }
  ctxMenuOutsideCloser = (e)=>{ if (!ctxMenu.contains(e.target)) closeContextMenu(); };
  setTimeout(()=>document.addEventListener("click", ctxMenuOutsideCloser), 0);
}
function closeContextMenu(){
  ctxMenu.classList.add("hidden");
  if (ctxMenuOutsideCloser) { document.removeEventListener("click", ctxMenuOutsideCloser); ctxMenuOutsideCloser = null; }
}

/* --------------------------- 覆盖渲染文件树：为节点补充 dataset 与右键菜单 --------------------------- */
const _renderFileTreeV2 = renderFileTree;
renderFileTree = function(){
  const tree = $("#file-tree");
  tree.innerHTML = "";

  const byFolder = new Map();
  byFolder.set(null, []);
  gFolders.forEach(f => byFolder.set(f._id, []));
  gArticles.forEach(a => {
    const list = byFolder.get(a.folder_id || null) || [];
    list.push(a); byFolder.set(a.folder_id || null, list);
  });

  // 渲染文章行（带 data-*）
  const renderArticleRow = (a) => {
    const row = document.createElement("button");
    row.className = "w-full flex items-center justify-between px-2 py-2 hover:bg-slate-50 rounded-lg node-article";
    row.dataset.type = "article";
    row.dataset.id = a._id;
    row.innerHTML = `
      <div class="flex items-center gap-2">
        <i data-feather="${a.type==='pdf'?'file-text':'file'}" class="shrink-0"></i>
        <div class="text-left">
          <div class="text-[13px] leading-5">${a.title || "(未命名)"}</div>
          <div class="text-[11px] text-slate-500">${fmt(a.updated_at || a.created_at)}</div>
        </div>
      </div>
      <span class="badge hidden" data-role="draft-dot">草稿</span>
    `;
    row.addEventListener("click", () => openArticle(a._id));
    row.addEventListener("contextmenu", (e)=>{
      e.preventDefault(); openArticleContextMenu(a, e.clientX, e.clientY);
    });
    return row;
  };

  // 未分类
  const uncats = byFolder.get(null) || [];
  if (uncats.length) {
    const h = document.createElement("div");
    h.className = "mt-3 mb-1 text-xs text-slate-500 px-1"; h.textContent = "未分类";
    tree.appendChild(h);
    uncats.forEach(a => tree.appendChild(renderArticleRow(a)));
  }

  // 文件夹
  gFolders.forEach(f=>{
    const head = document.createElement("div");
    head.className = "flex items-center justify-between mt-4 mb-1 px-1 node-folder";
    head.dataset.type = "folder";
    head.dataset.id = f._id;
    head.innerHTML = `
      <div class="flex items-center gap-2">
        <i data-feather="folder"></i><span class="text-sm font-medium">${f.name}</span>
      </div>`;
    head.addEventListener("contextmenu", (e)=>{
      e.preventDefault(); openFolderContextMenu(f, e.clientX, e.clientY);
    });
    tree.appendChild(head);

    const list = byFolder.get(f._id) || [];
    if (!list.length) {
      const empty = document.createElement("div");
      empty.className = "text-xs text-slate-400 px-2 py-1"; empty.textContent = "（空）";
      tree.appendChild(empty);
    } else {
      list.forEach(a => tree.appendChild(renderArticleRow(a)));
    }
  });

  iconRefresh();
  markDraftBadges();
}

/* --------------------------- 节点右键菜单项 --------------------------- */
function openFolderContextMenu(folder, x, y){
  openContextMenu([
    { label: "在此新建文章", action: async ()=>{
        const user = uid(); if(!user) return;
        const res = await db.collection(COLL.articles).add({
          title: "未命名文章", type:"text", content_html:"<p><br/></p>",
          user_id: user, folder_id: folder._id, created_at: now(), updated_at: now()
        });
        await loadFoldersAndArticles(); showToast("已创建文章");
      } },
    { label: "重命名文件夹", action: ()=> openRenameModal(folder.name, async (name)=>{
        await db.collection(COLL.folders).doc(folder._id).update({ name });
        await loadFoldersAndArticles(); showToast("文件夹已重命名");
      }) },
    { label: "删除文件夹（连带其中文章）", action: ()=> openConfirm("删除该文件夹将级联删除其中文章，且 PDF 文件会一并从 COS 删除。继续？", async ()=>{
        await deleteFolderCascade(folder._id);
        await loadFoldersAndArticles(); showToast("文件夹及其中文章已删除");
      }) }
  ], x, y);
}

function openArticleContextMenu(article, x, y){
  const items = [
    { label: "打开", action: ()=> openArticle(article._id) },
  ];
  if (article.type === "text") {
    items.push(
      { label: isEditing && currentArticle?._id===article._id ? "保存" : "编辑",
        action: ()=>{
          if (currentArticle?._id !== article._id) openArticle(article._id);
          if (isEditing) $("#btn-save").click(); else $("#btn-edit").click();
        }
      },
      { label: "导出为 TXT", action: async ()=>{
          if (currentArticle?._id !== article._id) await openArticle(article._id);
          const html = quill ? quill.root.innerHTML : (article.content_html || "");
          const blob = new Blob([stripHtml(html)], {type: "text/plain;charset=utf-8"});
          const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
          a.download = `${(article.title||"note")}.txt`; a.click(); URL.revokeObjectURL(a.href);
        } },
      { label: "导出为 PDF", action: async ()=>{
          if (currentArticle?._id !== article._id) await openArticle(article._id);
          const html = quill ? quill.root.innerHTML : (article.content_html || "");
          await exportArticleAsPDF(article.title||"note", html);
        } },
    );
  } else { // pdf
    items.push(
      { label: "下载原 PDF", action: async ()=>{
          const url = await getSignedUrl(article.cos_key, false);
          const a = document.createElement("a"); a.href = url; a.download = `${(article.title||"note")}.pdf`; a.click();
        } }
    );
  }
  items.push(
    { label: "重命名", action: ()=> openRenameModal(article.title||"未命名", async (name)=>{
        await db.collection(COLL.articles).doc(article._id).update({ title: name, updated_at: now() });
        if (currentArticle && currentArticle._id===article._id) { currentArticle.title = name; $("#current-title").textContent = name; }
        await loadFoldersAndArticles(); showToast("文章已重命名");
      }) },
    { label: "移动到…", action: ()=> openMoveModal(article.folder_id||"", async (folderId)=>{
        await db.collection(COLL.articles).doc(article._id).update({ folder_id: folderId });
        if (currentArticle && currentArticle._id===article._id) currentArticle.folder_id = folderId;
        await loadFoldersAndArticles(); showToast("已移动文章");
      }) },
    { label: "删除", action: ()=> openConfirm("确定删除该文章？（PDF 将连带删除 COS 文件）", async ()=>{
        await deleteArticle(article._id);
        if (currentArticle && currentArticle._id===article._id) {
          currentArticle = null; $("#current-title").textContent = "欢迎";
          show($("#welcome-view")); hide($("#article-view"));
        }
        await loadFoldersAndArticles(); showToast("文章已删除");
      }) }
  );
  openContextMenu(items, x, y);
}

/* --------------------------- 删除逻辑（含 COS 对象） --------------------------- */
async function deleteArticle(articleId){
  try{
    const r = await db.collection(COLL.articles).doc(articleId).get();
    const art = r?.data || gArticles.find(a=>a._id===articleId);
    if (art && art.type==="pdf" && art.cos_key) {
      await new Promise((resolve)=> {
        cos.deleteObject({ Bucket: CONFIG.cosBucket, Region: CONFIG.cosRegion, Key: art.cos_key },
          (err)=>{ if(err){ console.warn("COS 删除失败", err); } resolve(); });
      });
    }
    await db.collection(COLL.articles).doc(articleId).remove();
  }catch(e){ console.error(e); throw e; }
}

async function deleteFolderCascade(folderId){
  const arts = await db.collection(COLL.articles).where({ folder_id: folderId }).get();
  const list = arts?.data || [];
  for (const a of list) { await deleteArticle(a._id); }
  await db.collection(COLL.folders).doc(folderId).remove();
}

/* --------------------------- 顶部“更多”按钮（当前文章操作） --------------------------- */
$("#btn-more").addEventListener("click", (e)=>{
  const rect = e.currentTarget.getBoundingClientRect();
  const x = rect.left, y = rect.bottom+6;
  const items = [];
  if (currentArticle) {
    if (currentArticle.type === "text") {
      items.push(
        { label: isEditing ? "保存" : "编辑", action: ()=> (isEditing? $("#btn-save").click() : $("#btn-edit").click()) },
        { label: "导出为 TXT", action: async ()=>{
            const html = quill ? quill.root.innerHTML : (currentArticle.content_html || "");
            const blob = new Blob([stripHtml(html)], {type: "text/plain;charset=utf-8"});
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
            a.download = `${(currentArticle.title||"note")}.txt`; a.click(); URL.revokeObjectURL(a.href);
          } },
        { label: "导出为 PDF", action: async ()=>{
            const html = quill ? quill.root.innerHTML : (currentArticle.content_html || "");
            await exportArticleAsPDF(currentArticle.title||"note", html);
          } }
      );
    } else {
      items.push({ label: "下载原 PDF", action: async ()=>{
        const url = await getSignedUrl(currentArticle.cos_key, false);
        const a = document.createElement("a"); a.href = url; a.download = `${(currentArticle.title||"note")}.pdf`; a.click();
      }});
    }
    items.push(
      { label: "重命名", action: ()=> openRenameModal(currentArticle.title||"未命名", async (name)=>{
          await db.collection(COLL.articles).doc(currentArticle._id).update({ title: name, updated_at: now() });
          currentArticle.title = name; $("#current-title").textContent = name;
          await loadFoldersAndArticles(); showToast("文章已重命名");
        }) },
      { label: "移动到…", action: ()=> openMoveModal(currentArticle.folder_id||"", async (fid)=>{
          await db.collection(COLL.articles).doc(currentArticle._id).update({ folder_id: fid });
          currentArticle.folder_id = fid;
          await loadFoldersAndArticles(); showToast("已移动文章");
        }) },
      { label: "删除", action: ()=> openConfirm("确定删除当前文章？", async ()=>{
          await deleteArticle(currentArticle._id);
          currentArticle = null; $("#current-title").textContent = "欢迎";
          show($("#welcome-view")); hide($("#article-view"));
          await loadFoldersAndArticles(); showToast("文章已删除");
        }) }
    );
  } else {
    items.push({ label: "无可操作的文章", action: ()=>{} });
  }
  openContextMenu(items, x, y);
});

/* --------------------------- 辅助：在进入应用时确保加载一次数据（与片段 2 协作） --------------------------- */
if (typeof loadFoldersAndArticles === "function") {
  // 已在 2/3 中注入 enterApp 覆盖；这里只在首次进入主视图后点击“更多”等也能正常工作
}

/* --------------------------- 小的 UX 调整 --------------------------- */
// ESC 关闭任一菜单/弹窗
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){
    closeContextMenu();
    ["#creation-modal","#rename-modal","#move-modal","#confirm-modal"].forEach(sel=>hide($(sel)));
  }
});
</script>

</body>
</html>
