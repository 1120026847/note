<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æç®€ç¬”è®° Â· äº‘ç«¯ç‰ˆï¼ˆå« PDF é˜…è¯»å™¨ï¼‰</title>

  <!-- CloudBase JS SDKï¼ˆè®¤è¯ï¼‰ -->
  <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.21.6/cloudbase.full.js"></script>
  <!-- COS JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>
  <!-- Markdown æ¸²æŸ“ + XSS æ¸…ç†ï¼ˆç”¨äºç¬”è®°ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
  <!-- PDF.jsï¼ˆæ ¸å¿ƒä¸ workerï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
  <script>
    // æŒ‰ PDF.js å®˜æ–¹æ–¹å¼è®¾ç½® worker è·¯å¾„ï¼Œå¦åˆ™å°†æ— æ³•æ¸²æŸ“ã€‚:contentReference[oaicite:2]{index=2}
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js";
  </script>

  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --border:#e5e7eb; --muted:#6b7280; --text:#0f172a; --brand:#0f172a;
      --danger:#b91c1c; --radius:14px; --drop:#eef2ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial}
    .app{max-width:1200px;margin:0 auto;height:100%;display:grid;grid-template-rows:auto 1fr}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);background:var(--card);position:sticky;top:0;z-index:5}
    .main{display:grid;grid-template-columns:300px 1fr;gap:16px;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px}
    .sidebar{padding:12px;display:flex;flex-direction:column;gap:12px;height:calc(100vh - 80px);overflow:hidden}
    .sidebar .user{display:flex;align-items:center;justify-content:space-between;border:1px dashed var(--border);border-radius:12px;padding:10px}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--text);border-color:var(--border)}
    .btn.ghost{background:transparent;border-color:var(--border)}
    .btn.danger{background:#b91c1c;border-color:#b91c1c;color:#fff}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,textarea{font:inherit;border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff}
    input[type="search"]{width:100%}
    .muted{color:var(--muted);font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
    .hidden{display:none !important}
    .section-title{font-weight:700;padding:0 6px}

    .list{list-style:none;margin:0;padding:0;overflow:auto}
    .list li{display:flex;justify-content:space-between;align-items:center;gap:10px;border-top:1px solid #f1f5f9;padding:10px 6px}
    .list li:first-child{border-top:0}
    .list .meta{display:flex;flex-direction:column}
    .list .name{font-size:13px}
    .list .time{font-size:12px;color:var(--muted)}
    .list .ops{display:flex;gap:6px}

    .editor{padding:14px;display:flex;flex-direction:column;gap:10px;min-height:560px;position:relative}
    .editor .toolbar{display:flex;align-items:center;justify-content:space-between}
    .editor textarea{width:100%;min-height:220px;resize:vertical}
    .preview{border:1px dashed var(--border);border-radius:12px;padding:12px;background:#fff;overflow:auto}
    .preview img{max-width:100%;height:auto;border-radius:8px}
    .drop-mask{position:absolute;inset:0;border-radius:14px;border:2px dashed #818cf8;background:var(--drop);display:none;align-items:center;justify-content:center;color:#4338ca;font-weight:600;font-size:16px}
    .editor.dragover .drop-mask{display:flex}

    /* PDF viewer */
    .pdf-toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .pdf-controls{display:flex;gap:8px;align-items:center}
    .pdf-canvas-wrap{display:flex;justify-content:center;align-items:center;background:#fff;border:1px dashed var(--border);border-radius:12px;padding:8px;min-height:400px;overflow:auto}
    canvas{max-width:100%}
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>ğŸ“ æç®€ç¬”è®°</h1>
    <div class="row">
      <button id="btnToggleEdit" class="btn hidden">ç¼–è¾‘</button>
      <button id="btnLogout" class="btn secondary hidden">é€€å‡ºç™»å½•</button>
    </div>
  </header>

  <div class="main">
    <!-- å·¦ä¾§ï¼šè´¦æˆ· / ç¬”è®°ç®¡ç† / PDF ç®¡ç† -->
    <aside class="sidebar card">
      <div class="user">
        <div>
          <div class="mono" id="accountEmail">æœªç™»å½•</div>
          <div class="muted" id="accountUid"></div>
        </div>
        <button id="btnOpenAuth" class="btn ghost">ç™»å½•/æ³¨å†Œ</button>
      </div>

      <!-- ç¬”è®°æ“ä½œ -->
      <div class="card" style="padding:10px">
        <div class="row">
          <button id="btnNew" class="btn">æ–°å»ºæ–‡ç« </button>
          <button id="btnRefreshNotes" class="btn secondary">åˆ·æ–°</button>
        </div>
        <div class="row" style="margin-top:8px">
          <input id="searchInput" type="search" placeholder="æœç´¢æ–‡ä»¶åâ€¦" />
          <button id="btnSearch" class="btn secondary">æœç´¢</button>
          <button id="btnClearSearch" class="btn secondary">æ¸…ç©º</button>
        </div>
      </div>

      <div class="section-title">ç¬”è®°ç®¡ç†</div>
      <ul class="list card" id="noteList" style="padding:6px;height:180px"></ul>
      <div class="muted mono" id="listStateNotes" style="padding:0 6px"></div>

      <!-- PDF æ“ä½œ -->
      <div class="card" style="padding:10px;margin-top:8px">
        <div class="row">
          <input id="pdfFile" type="file" accept="application/pdf" class="hidden" />
          <button id="btnPickPdf" class="btn">ä¸Šä¼  PDF</button>
          <button id="btnRefreshPdfs" class="btn secondary">åˆ·æ–°</button>
        </div>
        <div class="muted" style="margin-top:6px">ä¹Ÿå¯æŠŠ PDF æ‹–åˆ°å³ä¾§åŒºåŸŸä¸Šä¼ </div>
      </div>

      <div class="section-title">PDF ç®¡ç†</div>
      <ul class="list card" id="pdfList" style="padding:6px;height:180px"></ul>
      <div class="muted mono" id="listStatePdfs" style="padding:0 6px"></div>
    </aside>

    <!-- å³ä¾§å†…å®¹ï¼šç¬”è®°ç¼–è¾‘å™¨ / PDF é˜…è¯»å™¨ï¼ˆè‡ªåŠ¨åˆ‡æ¢ï¼‰ -->
    <section class="editor card" id="editorCard">
      <!-- ç¬”è®°å·¥å…·æ¡ -->
      <div id="noteToolbar" class="toolbar">
        <div class="row" style="align-items:center;gap:8px">
          <input id="noteTitle" placeholder="è¯·è¾“å…¥æ ‡é¢˜â€¦" style="min-width:240px;width:360px" />
          <span class="muted" id="fileHint"></span>
        </div>
        <div class="muted" id="saveState"></div>
      </div>

      <!-- ç¬”è®°æ­£æ–‡ -->
      <textarea id="noteContent" placeholder="åœ¨è¿™é‡Œè¾“å…¥å†…å®¹â€¦ï¼ˆæ”¯æŒç²˜è´´/æ‹–æ‹½å›¾ç‰‡ï¼ŒMarkdown é¢„è§ˆï¼‰"></textarea>
      <div id="notePreview" class="preview"></div>

      <!-- PDF å·¥å…·æ¡ -->
      <div id="pdfToolbar" class="pdf-toolbar hidden">
        <div class="pdf-controls">
          <button id="pdfPrev" class="btn secondary">ä¸Šä¸€é¡µ</button>
          <button id="pdfNext" class="btn secondary">ä¸‹ä¸€é¡µ</button>
          <span class="muted" id="pdfPageInfo">-/-</span>
        </div>
        <div class="pdf-controls">
          <button id="pdfZoomOut" class="btn secondary">ç¼©å°</button>
          <button id="pdfZoomIn" class="btn secondary">æ”¾å¤§</button>
          <a id="pdfOpenRaw" class="btn" target="_blank" href="#">æ‰“å¼€åŸæ–‡ä»¶</a>
        </div>
      </div>
      <div id="pdfCanvasWrap" class="pdf-canvas-wrap hidden">
        <canvas id="pdfCanvas"></canvas>
      </div>

      <div id="emptyHint" class="muted" style="text-align:center;padding:20px">è¯·é€‰æ‹©å·¦ä¾§çš„ç¬”è®°æˆ– PDFï¼›æˆ–æ–°å»º/ä¸Šä¼ </div>
      <div id="dropMask" class="drop-mask">æ¾å¼€å³å¯ä¸Šä¼ ï¼ˆå›¾ç‰‡æˆ– PDFï¼‰åˆ° COS</div>
    </section>
  </div>
</div>

<!-- ç™»å½•æ¡† -->
<div id="authModal" class="card hidden" style="position:fixed;inset:auto 16px 16px auto;max-width:680px;padding:14px;box-shadow:0 10px 30px rgb(0 0 0 / .1)">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <strong>ç™»å½• / æ³¨å†Œ</strong>
    <button id="btnCloseAuth" class="btn secondary">å…³é—­</button>
  </div>
  <div class="row">
    <input id="email" type="email" placeholder="é‚®ç®±" />
    <input id="password" type="password" placeholder="å¯†ç ï¼ˆ8-32ä½ï¼‰" />
    <input id="emailCode" placeholder="é‚®ç®±éªŒè¯ç ï¼ˆæ³¨å†Œå¿…å¡«ï¼‰" />
  </div>
  <div class="row" style="margin-top:8px">
    <button id="btnSendCode" class="btn secondary">å‘é€éªŒè¯ç ï¼ˆæ³¨å†Œï¼‰</button>
    <button id="btnSignUp" class="btn">æ³¨å†Œ</button>
    <button id="btnSignIn" class="btn secondary">ç™»å½•</button>
  </div>
  <div class="mono muted" id="authState" style="margin-top:6px"></div>
</div>

<script>
/* ========= åŸºæœ¬é…ç½® ========= */
const CLOUDBASE_ENV = "molijun-0gtahyghc6271173";
const STS_URL       = "https://molijun-0gtahyghc6271173-1317231591.ap-shanghai.app.tcloudbase.com/api/sts";

/* ========= SDK åˆå§‹åŒ– ========= */
const app  = cloudbase.init({ env: CLOUDBASE_ENV });
const auth = app.auth();

/* ========= DOM å¿«æ· ========= */
const $ = id => document.getElementById(id);
const ui = {
  // é¡¶éƒ¨
  btnToggleEdit: $("btnToggleEdit"),
  btnLogout: $("btnLogout"),
  // å·¦ä¾§
  accountEmail: $("accountEmail"),
  accountUid: $("accountUid"),
  btnOpenAuth: $("btnOpenAuth"),
  btnCloseAuth: $("btnCloseAuth"),
  btnNew: $("btnNew"),
  btnRefreshNotes: $("btnRefreshNotes"),
  searchInput: $("searchInput"),
  btnSearch: $("btnSearch"),
  btnClearSearch: $("btnClearSearch"),
  noteList: $("noteList"),
  listStateNotes: $("listStateNotes"),
  pdfFile: $("pdfFile"),
  btnPickPdf: $("btnPickPdf"),
  btnRefreshPdfs: $("btnRefreshPdfs"),
  pdfList: $("pdfList"),
  listStatePdfs: $("listStatePdfs"),
  // å³ä¾§ï¼ˆç¬”è®°ï¼‰
  editorCard: $("editorCard"),
  noteToolbar: $("noteToolbar"),
  noteTitle: $("noteTitle"),
  noteContent: $("noteContent"),
  notePreview: $("notePreview"),
  fileHint: $("fileHint"),
  saveState: $("saveState"),
  // å³ä¾§ï¼ˆPDFï¼‰
  pdfToolbar: $("pdfToolbar"),
  pdfPrev: $("pdfPrev"),
  pdfNext: $("pdfNext"),
  pdfZoomOut: $("pdfZoomOut"),
  pdfZoomIn: $("pdfZoomIn"),
  pdfPageInfo: $("pdfPageInfo"),
  pdfOpenRaw: $("pdfOpenRaw"),
  pdfCanvasWrap: $("pdfCanvasWrap"),
  pdfCanvas: $("pdfCanvas"),
  // å…¶ä»–
  emptyHint: $("emptyHint"),
  dropMask: $("dropMask"),
  // ç™»å½•
  authModal: $("authModal"),
  email: $("email"), password: $("password"), emailCode: $("emailCode"),
  btnSendCode: $("btnSendCode"), btnSignUp: $("btnSignUp"), btnSignIn: $("btnSignIn"),
  authState: $("authState"),
};

/* ========= å…¨å±€çŠ¶æ€ ========= */
let currentUID = null;
let latestNotes = [];
let latestPdfs = [];
let editing = false;
let openedNoteKey = null;
let openedPdf = { doc: null, url: null, page: 1, total: 0, scale: 1.15 };

function pad2(n){return n<10?("0"+n):""+n}
function ts(){
  const d = new Date();
  return d.getFullYear()+pad2(d.getMonth()+1)+pad2(d.getDate())+"_"+pad2(d.getHours())+pad2(d.getMinutes())+pad2(d.getSeconds());
}

/* ========= ç™»å½• ========= */
function setAuthUI(st){
  const uid = st?.user?.uid || null;
  const email = st?.user?.email || "";
  currentUID = uid;
  ui.accountEmail.textContent = email || "ï¼ˆæœªå–åˆ°é‚®ç®±ï¼‰";
  ui.accountUid.textContent = uid ? ("UID: " + uid) : "";
  ui.btnLogout.classList.toggle("hidden", !uid);
  ui.btnOpenAuth.classList.toggle("hidden", !!uid);
  if(uid){ refreshNotes(); refreshPdfs(); }
}
ui.btnOpenAuth.onclick = ()=> ui.authModal.classList.remove("hidden");
ui.btnCloseAuth.onclick = ()=> ui.authModal.classList.add("hidden");

ui.btnSendCode.onclick = async ()=>{
  const email = ui.email.value.trim(); if(!email) return alert("è¯·è¾“å…¥é‚®ç®±");
  ui.authState.textContent = "å‘é€éªŒè¯ç â€¦";
  try{
    const v = await auth.getVerification({ email });
    ui.email.dataset.verification_id = v.verification_id;
    ui.authState.textContent = "éªŒè¯ç å·²å‘é€ï¼ˆ10åˆ†é’Ÿæœ‰æ•ˆï¼‰";
  }catch(e){ ui.authState.textContent = "å¤±è´¥ï¼š" + (e?.message || e); }
};
ui.btnSignUp.onclick = async ()=>{
  const email = ui.email.value.trim(), pwd = ui.password.value.trim();
  const code = ui.emailCode.value.trim(), vid = ui.email.dataset.verification_id;
  if(!email||!pwd||!code||!vid) return alert("è¯·å®Œæ•´å¡«å†™å¹¶å…ˆå–éªŒè¯ç ");
  ui.authState.textContent = "æ³¨å†Œä¸­â€¦";
  try{
    const verified = await auth.verify({ verification_id: vid, verification_code: code });
    const st = await auth.signUp({ email, verification_code: code, verification_token: verified.verification_token, password: pwd });
    setAuthUI(st); ui.authModal.classList.add("hidden");
  }catch(e){ ui.authState.textContent = "å¤±è´¥ï¼š" + (e?.message || e); }
};
ui.btnSignIn.onclick = async ()=>{
  const email = ui.email.value.trim(), pwd = ui.password.value.trim();
  if(!email||!pwd) return alert("è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ");
  ui.authState.textContent = "ç™»å½•ä¸­â€¦";
  try{ const st = await auth.signIn({ username: email, password: pwd }); setAuthUI(st); ui.authModal.classList.add("hidden"); }
  catch(e){ ui.authState.textContent = "å¤±è´¥ï¼š" + (e?.message || e); }
};
ui.btnLogout.onclick = async ()=>{ try{ await auth.signOut(); setAuthUI(null); clearNoteUI(); clearPdfUI(); }catch(e){ alert("é€€å‡ºå¤±è´¥ï¼š"+e); } };
(async ()=>{ try{ const st = await auth.getLoginState(); if(st) setAuthUI(st); }catch{} })();

/* ========= STS / COS ========= */
let stsCache = null, cos = null;
async function ensureLogin(){ const st = await auth.getLoginState(); if(!st?.user) throw new Error("å°šæœªç™»å½•"); return st.user; }
async function fetchSTS(uid){
  const r = await fetch(`${STS_URL}?uid=${encodeURIComponent(uid)}`, { headers:{ "x-user-uid": uid } });
  if(!r.ok) throw new Error("STS è·å–å¤±è´¥");
  const j = await r.json(); if(!j?.credentials?.tmpSecretId) throw new Error("STS å“åº”ä¸å®Œæ•´"); return j;
}
async function ensureCOS(){
  const { uid } = await ensureLogin();
  const now = Math.floor(Date.now()/1000);
  if(!stsCache || !stsCache.expiredTime || (now + 60) >= Number(stsCache.expiredTime)){
    stsCache = await fetchSTS(uid);
    cos = new COS({
      getAuthorization: (_, cb) => {
        const c = stsCache.credentials;
        cb({ TmpSecretId:c.tmpSecretId, TmpSecretKey:c.tmpSecretKey, SecurityToken:c.sessionToken,
             StartTime:Number(stsCache.startTime), ExpiredTime:Number(stsCache.expiredTime) });
      }
    });
  }
  return { cos, bucket: stsCache.bucket, region: stsCache.region, uid };
}

/* ========= ç¬”è®°ï¼šåˆ—è¡¨/æ‰“å¼€/ä¿å­˜ ========= */
function clearNoteUI(){
  openedNoteKey = null; editing = false;
  ui.noteTitle.value = ""; ui.noteContent.value = ""; ui.notePreview.innerHTML = "";
  ui.fileHint.textContent = ""; ui.btnToggleEdit.classList.add("hidden");
  ui.saveState.textContent = ""; ui.emptyHint.classList.remove("hidden");
}
function renderNotePreview(){ ui.notePreview.innerHTML = DOMPurify.sanitize(marked.parse(ui.noteContent.value||"")); }

async function refreshNotes(){
  ui.listStateNotes.textContent = "åŠ è½½ä¸­â€¦";
  try{
    const { cos, bucket, region, uid } = await ensureCOS();
    const prefix = `${uid}/`;
    const data = await new Promise((res,rej)=> cos.getBucket({Bucket:bucket,Region:region,Prefix:prefix,MaxKeys:1000},(e,d)=>e?rej(e):res(d)));
    latestNotes = (data?.Contents||[]).filter(o=>o.Key.endsWith(".txt") || o.Key.endsWith(".md"))
                  .sort((a,b)=> new Date(b.LastModified)-new Date(a.LastModified));
    ui.noteList.innerHTML = "";
    for(const o of latestNotes){
      const name = o.Key.split("/").pop();
      const li = document.createElement("li");
      const meta = document.createElement("div");
      meta.className="meta"; meta.innerHTML = `<span class="name mono">${name}</span><span class="time">${new Date(o.LastModified).toLocaleString()}</span>`;
      const ops = document.createElement("div"); ops.className="ops";
      const bOpen = document.createElement("button"); bOpen.className="btn secondary"; bOpen.textContent="æ‰“å¼€";
      bOpen.onclick = ()=> openNote(o);
      const bDel = document.createElement("button"); bDel.className="btn danger"; bDel.textContent="åˆ é™¤";
      bDel.onclick = ()=> delObject(o.Key);
      ops.append(bOpen,bDel); li.append(meta,ops); ui.noteList.appendChild(li);
    }
    ui.listStateNotes.textContent = `å…± ${latestNotes.length} ç¯‡`;
  }catch(e){ ui.listStateNotes.textContent = "å¤±è´¥ï¼š" + (e?.message||e); }
}
async function openNote(obj){
  try{
    const { cos, bucket, region } = await ensureCOS();
    const data = await new Promise((res,rej)=> cos.getObject({Bucket:bucket,Region:region,Key:obj.Key},(e,d)=>e?rej(e):res(d)));
    const body = data.Body instanceof Blob ? await data.Body.text() : (typeof data.Body==="string"?data.Body:new TextDecoder().decode(data.Body));
    const name = obj.Key.split("/").pop();
    openedNoteKey = obj.Key; editing=false;
    ui.noteTitle.value = name.replace(/\.(txt|md)$/i,"");
    ui.noteContent.value = body||""; ui.noteContent.readOnly = true;
    ui.fileHint.textContent = name; ui.btnToggleEdit.textContent="ç¼–è¾‘"; ui.btnToggleEdit.classList.remove("hidden");
    ui.emptyHint.classList.add("hidden");
    showNoteUI();
    renderNotePreview();
  }catch(e){ alert("è¯»å–å¤±è´¥ï¼š"+(e?.message||e)); }
}
ui.btnNew.onclick = ()=>{ openedNoteKey=null; editing=true; showNoteUI(); ui.noteTitle.value=""; ui.noteContent.value=""; ui.noteContent.readOnly=false; ui.btnToggleEdit.textContent="ä¿å­˜"; ui.btnToggleEdit.classList.remove("hidden"); ui.emptyHint.classList.add("hidden"); renderNotePreview(); };
ui.btnToggleEdit.onclick = async ()=>{
  if(!editing){ editing=true; ui.noteContent.readOnly=false; ui.btnToggleEdit.textContent="ä¿å­˜"; return; }
  ui.saveState.textContent="ä¿å­˜ä¸­â€¦";
  try{
    const { cos, bucket, region, uid } = await ensureCOS();
    let key = openedNoteKey;
    if(!key){
      const safe = (ui.noteTitle.value||"æœªå‘½å").replace(/[\\/:*?"<>|\s]+/g,"_").slice(0,60);
      key = `${uid}/${ts()}_${safe}.md`;
    }
    const blob = new Blob([ui.noteContent.value||""],{type:"text/markdown;charset=utf-8"});
    await new Promise((res,rej)=> cos.putObject({Bucket:bucket,Region:region,Key:key,Body:blob},(e,d)=>e?rej(e):res(d)));
    openedNoteKey = key; editing=false; ui.noteContent.readOnly=true; ui.btnToggleEdit.textContent="ç¼–è¾‘";
    ui.saveState.textContent="å·²ä¿å­˜"; refreshNotes();
  }catch(e){ ui.saveState.textContent="å¤±è´¥ï¼š"+(e?.message||e); }
};
ui.noteContent.addEventListener("input", renderNotePreview);
ui.btnRefreshNotes.onclick = ()=> refreshNotes();
ui.btnSearch.onclick = ()=>{
  const kw = ui.searchInput.value.trim().toLowerCase();
  const list = !kw? latestNotes : latestNotes.filter(o=>o.Key.toLowerCase().includes(kw));
  renderSimpleList(ui.noteList, list, openNote); ui.listStateNotes.textContent = `è¿‡æ»¤å ${list.length} æ¡`;
};
ui.btnClearSearch.onclick = ()=>{ ui.searchInput.value=""; renderSimpleList(ui.noteList, latestNotes, openNote); ui.listStateNotes.textContent=`å…± ${latestNotes.length} æ¡`; };

/* ========= PDFï¼šåˆ—è¡¨/ä¸Šä¼ /é˜…è¯» ========= */
function clearPdfUI(){
  openedPdf = { doc:null,url:null,page:1,total:0,scale:1.15 };
  ui.pdfToolbar.classList.add("hidden"); ui.pdfCanvasWrap.classList.add("hidden");
}
function showNoteUI(){ // åˆ‡æ¢åˆ°ç¬”è®°ç•Œé¢
  ui.noteToolbar.classList.remove("hidden");
  ui.noteContent.classList.remove("hidden");
  ui.notePreview.classList.remove("hidden");
  ui.pdfToolbar.classList.add("hidden");
  ui.pdfCanvasWrap.classList.add("hidden");
}
function showPdfUI(){ // åˆ‡æ¢åˆ° PDF ç•Œé¢
  ui.noteToolbar.classList.add("hidden");
  ui.noteContent.classList.add("hidden");
  ui.notePreview.classList.add("hidden");
  ui.pdfToolbar.classList.remove("hidden");
  ui.pdfCanvasWrap.classList.remove("hidden");
}
async function refreshPdfs(){
  ui.listStatePdfs.textContent = "åŠ è½½ä¸­â€¦";
  try{
    const { cos, bucket, region, uid } = await ensureCOS();
    const prefix = `${uid}/assets/pdf/`;
    const data = await new Promise((res,rej)=> cos.getBucket({Bucket:bucket,Region:region,Prefix:prefix,MaxKeys:1000},(e,d)=>e?rej(e):res(d)));
    latestPdfs = (data?.Contents||[]).filter(o=>o.Key.toLowerCase().endsWith(".pdf"))
                 .sort((a,b)=> new Date(b.LastModified)-new Date(a.LastModified));
    renderSimpleList(ui.pdfList, latestPdfs, openPdf);
    ui.listStatePdfs.textContent = `å…± ${latestPdfs.length} ä¸ª`;
  }catch(e){ ui.listStatePdfs.textContent = "å¤±è´¥ï¼š" + (e?.message||e); }
}
function renderSimpleList(target, objs, openFn){
  target.innerHTML="";
  if(!objs.length){ target.innerHTML="<li class='muted' style='padding:12px'>æš‚æ— æ–‡ä»¶</li>"; return; }
  for(const o of objs){
    const name = o.Key.split("/").pop();
    const li = document.createElement("li");
    const meta = document.createElement("div"); meta.className="meta";
    meta.innerHTML=`<span class="name mono">${name}</span><span class="time">${new Date(o.LastModified).toLocaleString()}</span>`;
    const ops = document.createElement("div"); ops.className="ops";
    const bOpen = document.createElement("button"); bOpen.className="btn secondary"; bOpen.textContent="æ‰“å¼€";
    bOpen.onclick = ()=> openFn(o);
    const bDown = document.createElement("button"); bDown.className="btn secondary"; bDown.textContent="ä¸‹è½½";
    bDown.onclick = async ()=>{
      const { bucket, region } = stsCache || {}; if(!bucket) return;
      const url = await new Promise((res,rej)=> cos.getObjectUrl({Bucket:bucket,Region:region,Key:o.Key,Sign:true},(e,r)=>e?rej(e):res(r.Url)));
      window.open(url,"_blank");
    };
    const bDel = document.createElement("button"); bDel.className="btn danger"; bDel.textContent="åˆ é™¤";
    bDel.onclick = ()=> delObject(o.Key);
    ops.append(bOpen,bDown,bDel); li.append(meta,ops); target.appendChild(li);
  }
}
async function delObject(key){
  if(!confirm(`ç¡®å®šåˆ é™¤ï¼š${key.split("/").pop()} ?`)) return;
  try{ const { cos, bucket, region } = await ensureCOS(); await new Promise((res,rej)=> cos.deleteObject({Bucket:bucket,Region:region,Key:key},(e,d)=>e?rej(e):res(d))); refreshNotes(); refreshPdfs(); }
  catch(e){ alert("åˆ é™¤å¤±è´¥ï¼š"+(e?.message||e)); }
}

/* ä¸Šä¼  PDFï¼ˆæŒ‰é’®/æ‹–æ‹½ï¼‰ */
ui.btnPickPdf.onclick = ()=> ui.pdfFile.click();
ui.pdfFile.onchange = async (e)=>{ const f = e.target.files?.[0]; if(f) await handlePdfFiles([f]); e.target.value=""; };

["dragenter","dragover"].forEach(ev=> ui.editorCard.addEventListener(ev, e=>{ e.preventDefault(); ui.dropMask.style.display="flex"; }));
["dragleave","drop"].forEach(ev=> ui.editorCard.addEventListener(ev, e=>{ e.preventDefault(); if(ev==="drop") onDrop(e); ui.dropMask.style.display="none"; }));
async function onDrop(e){
  const files = Array.from(e.dataTransfer?.files || []);
  const imgs = files.filter(f=> f.type.startsWith("image/"));
  const pdfs = files.filter(f=> f.type === "application/pdf");
  if(pdfs.length) await handlePdfFiles(pdfs);
  if(imgs.length) await handleImageFiles(imgs); // å¤ç”¨ä½ åŸå…ˆçš„å›¾ç‰‡ä¸Šä¼ é€»è¾‘ï¼ˆè§ä¸‹ï¼‰
}

/* å®é™…ä¸Šä¼ åˆ° COSï¼šä½¿ç”¨ uploadFileï¼Œé«˜çº§æ¥å£æ”¯æŒåˆ†ç‰‡ä¸è¿›åº¦ã€‚:contentReference[oaicite:3]{index=3} */
async function handlePdfFiles(files){
  for(const f of files){
    if(f.type!=="application/pdf"){ ui.saveState.textContent=`è·³è¿‡é PDFï¼š${f.name}`; continue; }
    try{
      const url = await uploadPdfToCOS(f);
      ui.saveState.textContent = `PDF ä¸Šä¼ æˆåŠŸï¼š${f.name}`;
      await refreshPdfs();
      // ä¸Šä¼ åç›´æ¥æ‰“å¼€é˜…è¯»
      const last = latestPdfs[0];
      if(last) openPdf(last);
    }catch(e){ ui.saveState.textContent = `ä¸Šä¼ å¤±è´¥ï¼š${e?.message||e}`; }
  }
}
async function uploadPdfToCOS(file){
  const { cos, bucket, region, uid } = await ensureCOS();
  const y = new Date().getFullYear(), m = pad2(new Date().getMonth()+1);
  const base = (file.name.replace(/\.pdf$/i,"") || "æœªå‘½å").replace(/[\\/:*?"<>|\s]+/g,"_").slice(0,64);
  const key = `${uid}/assets/pdf/${y}/${m}/${ts()}_${base}.pdf`;
  await new Promise((res,rej)=> cos.uploadFile({
      Bucket:bucket,Region:region,Key:key,Body:file,SliceSize:1024*1024,
      onProgress:p=> ui.saveState.textContent=`ä¸Šä¼ ä¸­ ${file.name} ${(p.percent*100).toFixed(1)}%`
  },(e,d)=> e?rej(e):res(d)));
  const url = await new Promise((res,rej)=> cos.getObjectUrl({Bucket:bucket,Region:region,Key:key,Sign:true},(e,r)=>e?rej(e):res(r.Url)));
  return url;
}

/* æ‰“å¼€ PDFï¼ˆä½¿ç”¨ PDF.js æ¸²æŸ“ï¼‰ã€‚ç”¨æ³•æ¥è‡ªå®˜æ–¹é¦–é¡µ/ç¤ºä¾‹ï¼šgetDocument().promise -> doc.getPage(page).render()ã€‚:contentReference[oaicite:4]{index=4} */
async function openPdf(obj){
  try{
    const { bucket, region } = stsCache || await ensureCOS();
    const signedUrl = await new Promise((res,rej)=> cos.getObjectUrl({Bucket:bucket,Region:region,Key:obj.Key,Sign:true},(e,r)=>e?rej(e):res(r.Url)));
    openedPdf.url = signedUrl; ui.pdfOpenRaw.href = signedUrl;

    // åˆ‡åˆ° PDF ç•Œé¢
    showPdfUI(); ui.emptyHint.classList.add("hidden");
    ui.saveState.textContent = "åŠ è½½ PDFâ€¦";

    // åŠ è½½æ–‡æ¡£
    const loadingTask = pdfjsLib.getDocument({ url: signedUrl });
    openedPdf.doc = await loadingTask.promise;
    openedPdf.total = openedPdf.doc.numPages;
    openedPdf.page = 1; openedPdf.scale = 1.15;
    ui.pdfPageInfo.textContent = `1 / ${openedPdf.total}`;
    await renderPdfPage();

    ui.saveState.textContent = "";
  }catch(e){ ui.saveState.textContent = "PDF åŠ è½½å¤±è´¥ï¼š" + (e?.message || e); }
}
async function renderPdfPage(){
  if(!openedPdf.doc) return;
  const page = await openedPdf.doc.getPage(openedPdf.page);
  const viewport = page.getViewport({ scale: openedPdf.scale });
  const canvas = ui.pdfCanvas, ctx = canvas.getContext("2d");
  canvas.width = viewport.width; canvas.height = viewport.height;
  await page.render({ canvasContext: ctx, viewport }).promise;
  ui.pdfPageInfo.textContent = `${openedPdf.page} / ${openedPdf.total}`;
}
ui.pdfPrev.onclick = async ()=>{ if(openedPdf.page>1){ openedPdf.page--; await renderPdfPage(); } };
ui.pdfNext.onclick = async ()=>{ if(openedPdf.page<openedPdf.total){ openedPdf.page++; await renderPdfPage(); } };
ui.pdfZoomIn.onclick = async ()=>{ openedPdf.scale = Math.min(3, openedPdf.scale+0.15); await renderPdfPage(); };
ui.pdfZoomOut.onclick = async ()=>{ openedPdf.scale = Math.max(0.5, openedPdf.scale-0.15); await renderPdfPage(); };

/* ========= å›¾ç‰‡ä¸Šä¼ ï¼ˆæ²¿ç”¨ä½ ä¹‹å‰çš„åŠŸèƒ½ï¼Œä¾¿äºæ‹–æ‹½æ··ç”¨ï¼‰ ========= */
const IMAGE_MAX = 20*1024*1024;
const ACCEPT_IMG = ["image/png","image/jpeg","image/gif","image/webp","image/svg+xml"];
async function handleImageFiles(files){
  for(const f of files){
    if(!ACCEPT_IMG.includes(f.type)){ ui.saveState.textContent=`è·³è¿‡ä¸æ”¯æŒçš„å›¾ç‰‡ç±»å‹ï¼š${f.type}`; continue; }
    if(f.size>IMAGE_MAX){ ui.saveState.textContent=`å›¾ç‰‡è¿‡å¤§ï¼š${f.name}`; continue; }
    try{
      const url = await uploadImageToCOS(f);
      // åˆ‡å›ç¬”è®°ç¼–è¾‘æ€å¹¶æ’å…¥
      showNoteUI(); openedNoteKey ??= null; editing = true; ui.noteContent.readOnly=false; ui.btnToggleEdit.textContent="ä¿å­˜"; ui.btnToggleEdit.classList.remove("hidden");
      insertAtCursor(ui.noteContent, `\n![](${url})\n`); renderNotePreview();
      ui.saveState.textContent = `å›¾ç‰‡å·²ä¸Šä¼ å¹¶æ’å…¥ï¼š${f.name}`;
    }catch(e){ ui.saveState.textContent = `å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š${e?.message||e}`; }
  }
}
async function uploadImageToCOS(file){
  const { cos, bucket, region, uid } = await ensureCOS();
  const ext = (file.name.split(".").pop()||"png").toLowerCase();
  const key = `${uid}/assets/${new Date().getFullYear()}/${pad2(new Date().getMonth()+1)}/${ts()}_${(ui.noteTitle.value||"æœªå‘½å").replace(/[\\/:*?"<>|\s]+/g,"_").slice(0,40)}.${ext}`;
  await new Promise((res,rej)=> cos.uploadFile({Bucket:bucket,Region:region,Key:key,Body:file,SliceSize:1024*1024,onProgress:p=>ui.saveState.textContent=`ä¸Šä¼ ä¸­ ${file.name} ${(p.percent*100).toFixed(1)}%`},(e,d)=>e?rej(e):res(d)));
  return await new Promise((res,rej)=> cos.getObjectUrl({Bucket:bucket,Region:region,Key:key,Sign:true},(e,r)=>e?rej(e):res(r.Url)));
}
function insertAtCursor(el, text){
  const s = el.selectionStart ?? el.value.length, e = el.selectionEnd ?? el.value.length;
  el.value = el.value.slice(0,s) + text + el.value.slice(e);
  el.selectionStart = el.selectionEnd = s + text.length; el.focus();
}

/* ========= åˆå§‹åŒ– ========= */
(async ()=>{ try{ const st = await auth.getLoginState(); if(st) setAuthUI(st); }catch{} })();
</script>
</body>
</html>
