<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cloud Notes</title>

  <!-- Tailwindï¼ˆå¼€å‘æœŸå¯ç”¨ï¼›ç”Ÿäº§å»ºè®®ç”¨ PostCSS æ„å»ºï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Quill å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

  <!-- PDF.jsï¼ˆæ˜¾ç¤ºå±‚ï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    /* æŒ‡å®š workerï¼ˆä¸ä¸Šé¢ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼‰ */
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>

  <!-- jsPDF + html2canvasï¼ˆå¯¼å‡º PDF ç”¨ï¼‰ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Feather å›¾æ ‡ -->
  <script src="https://unpkg.com/feather-icons"></script>

  <!-- COS JS SDK v5ï¼ˆå‰ç«¯ç›´ä¼ ï¼Œéœ€è¦ STSï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>

  <!-- CloudBase Web SDKï¼ˆå…¨é‡åŒ…ï¼ŒåŒ…å« auth/database ç­‰æ¨¡å—ï¼‰ -->
  <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.15.1/cloudbase.full.js"></script>

  <style>
    .card { @apply bg-white rounded-2xl shadow-lg; }
    .btn { @apply inline-flex items-center justify-center rounded-xl px-4 py-2 font-medium transition; }
    .btn-primary { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
    .btn-ghost { @apply hover:bg-slate-100; }
    .badge { @apply inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium bg-slate-100 text-slate-600; }
    .menu { @apply absolute z-50 bg-white rounded-xl shadow-lg border border-slate-200 py-1 min-w-[160px]; }
    .menu button { @apply w-full text-left px-3 py-2 hover:bg-slate-50; }
    .hidden-important { display: none !important; }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-800">
<!-- ===================== ç‰‡æ®µ 1/3ï¼šé¡µé¢éª¨æ¶ + è®¤è¯è§†å›¾ + ä¸»å¸ƒå±€ ===================== -->

<!-- è®¤è¯è§†å›¾ -->
<section id="auth-view" class="min-h-screen grid place-items-center">
  <div class="card w-[560px] max-w-[94vw] p-8">
    <div class="flex items-center justify-between border-b pb-3">
      <div class="text-xl font-semibold">æ¬¢è¿ä½¿ç”¨ Cloud Notes</div>
      <div class="space-x-2">
        <button id="tab-login"  class="btn btn-ghost data-[active=true]:bg-slate-100" data-active="true">ç™»å½•</button>
        <button id="tab-register" class="btn btn-ghost">æ³¨å†Œ</button>
      </div>
    </div>

    <!-- ç™»å½•è¡¨å• -->
    <form id="login-form" class="mt-6 space-y-4">
      <div>
        <label class="block mb-1 text-sm text-slate-600">é‚®ç®±</label>
        <input id="login-email" type="email" required class="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-100" />
      </div>
      <div>
        <label class="block mb-1 text-sm text-slate-600">å¯†ç </label>
        <input id="login-password" type="password" required class="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-100" />
      </div>
      <button class="btn btn-primary w-full" type="submit">ç™»å½•</button>
    </form>

    <!-- æ³¨å†Œè¡¨å• -->
    <form id="register-form" class="mt-6 space-y-4 hidden">
      <div>
        <label class="block mb-1 text-sm text-slate-600">é‚®ç®±</label>
        <input id="register-email" type="email" required class="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-100" />
      </div>
      <div>
        <label class="block mb-1 text-sm text-slate-600">å¯†ç </label>
        <input id="register-password" type="password" minlength="6" required class="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-100" />
      </div>
      <button class="btn btn-primary w-full" type="submit">æ³¨å†Œ</button>
      <p class="text-xs text-slate-500">æ³¨å†Œåç³»ç»Ÿä¼šå‘é€éªŒè¯é‚®ä»¶åˆ°ä½ çš„é‚®ç®±</p>
    </form>
  </div>
</section>

<!-- ä¸»åº”ç”¨è§†å›¾ï¼ˆUIéª¨æ¶ï¼ŒåŠŸèƒ½åœ¨ 2/3ã€3/3 é‡Œæ¥ä¸Šï¼‰ -->
<section id="main-app-view" class="hidden min-h-screen">
  <div class="grid lg:grid-cols-[280px_1fr] grid-cols-1 gap-0">
    <!-- ä¾§è¾¹æ  -->
    <aside id="sidebar" class="card lg:rounded-none lg:rounded-r-2xl lg:min-h-screen p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div id="avatar" class="w-10 h-10 rounded-full grid place-items-center bg-indigo-100 text-indigo-700 font-bold"></div>
          <div>
            <div id="user-email" class="text-sm font-medium"></div>
            <div class="text-xs text-slate-500">å·²ç™»å½•</div>
          </div>
        </div>
        <button id="btn-signout" class="btn btn-ghost" title="é€€å‡ºç™»å½•"><i data-feather="log-out"></i></button>
      </div>

      <div class="mt-6 grid grid-cols-2 gap-2">
        <button id="btn-new-folder"  class="btn bg-slate-100 hover:bg-slate-200"><i data-feather="folder-plus" class="mr-2"></i>æ–°å»ºæ–‡ä»¶å¤¹</button>
        <button id="btn-new-article" class="btn bg-slate-100 hover:bg-slate-200"><i data-feather="file-plus"   class="mr-2"></i>æ–°å»ºæ–‡ç« </button>
      </div>

      <div class="mt-4">
        <div class="flex items-center justify-between mb-2">
          <div class="font-medium">æˆ‘çš„ç¬”è®°</div>
          <button id="btn-data-toggle" class="btn btn-ghost text-sm"><i data-feather="hard-drive" class="mr-2"></i>æ•°æ®ç®¡ç†</button>
        </div>
        <nav id="file-tree" class="text-sm space-y-1 select-none">
          <!-- æ–‡ä»¶å¤¹/æ–‡ç« é¡¹ç”± JS æ¸²æŸ“ï¼ˆç‰‡æ®µ 2/3ï¼‰ -->
        </nav>
      </div>

      <div id="data-panel" class="mt-4 hidden border-t pt-3 space-y-2">
        <label class="btn w-full bg-slate-100 hover:bg-slate-200">
          <input id="input-import-pdf" class="hidden" type="file" accept="application/pdf" />
          <i data-feather="file-text" class="mr-2"></i>å¯¼å…¥ PDF
        </label>
        <label class="btn w-full bg-slate-100 hover:bg-slate-200">
          <input id="input-import-backup" class="hidden" type="file" accept="application/json" />
          <i data-feather="upload" class="mr-2"></i>å¯¼å…¥å¤‡ä»½
        </label>
        <button id="btn-export-backup" class="btn w-full bg-slate-100 hover:bg-slate-200"><i data-feather="download" class="mr-2"></i>å¯¼å‡ºå¤‡ä»½</button>
      </div>
    </aside>

    <!-- ä¸»å†…å®¹åŒº -->
    <main id="main-content" class="min-h-screen">
      <header class="card rounded-none lg:rounded-none lg:rounded-b-2xl p-4 flex items-center justify-between sticky top-0 z-40">
        <div class="flex items-center gap-3">
          <button id="btn-toggle-sidebar" class="btn btn-ghost lg:hidden"><i data-feather="menu"></i></button>
          <div id="current-title" class="text-lg font-semibold truncate max-w-[50vw]">æ¬¢è¿</div>
        </div>

        <!-- PDF ç¿»é¡µæ§ä»¶ï¼ˆä»… PDF æ¨¡å¼æ˜¾ç¤ºï¼šç‰‡æ®µ 2/3 æ¥é€»è¾‘ï¼‰ -->
        <div id="pdf-controls" class="hidden items-center gap-2">
          <button id="btn-pdf-prev" class="btn btn-ghost"><i data-feather="chevron-left"></i></button>
          <span class="badge"><span id="pdf-page">1</span>/<span id="pdf-total">1</span></span>
          <button id="btn-pdf-next" class="btn btn-ghost"><i data-feather="chevron-right"></i></button>
        </div>

        <div class="flex items-center gap-2">
          <button id="btn-edit"  class="btn btn-ghost hidden"><i data-feather="edit-3" class="mr-2"></i>ç¼–è¾‘</button>
          <button id="btn-save"  class="btn btn-primary hidden"><i data-feather="save" class="mr-2"></i>ä¿å­˜</button>
          <button id="btn-export" class="btn btn-ghost hidden"><i data-feather="share" class="mr-2"></i>å¯¼å‡º</button>
          <button id="btn-more"   class="btn btn-ghost"><i data-feather="more-horizontal"></i></button>
        </div>
      </header>

      <section id="welcome-view" class="p-10 grid place-items-center">
        <div class="text-center max-w-[680px]">
          <div class="text-2xl font-semibold mb-3">å¼€å§‹åˆ›ä½œä½ çš„ç¬¬ä¸€ç¯‡ç¬”è®°</div>
          <p class="text-slate-500">ä»å·¦ä¾§â€œæ–°å»ºæ–‡ç« â€æˆ–â€œå¯¼å…¥ PDFâ€å¼€å§‹ï¼Œä¹Ÿå¯å…ˆåˆ›å»ºæ–‡ä»¶å¤¹æ¥åˆ†ç±»ç®¡ç†ã€‚</p>
        </div>
      </section>

      <section id="article-view" class="hidden p-6">
        <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å®¹å™¨ï¼ˆç‰‡æ®µ 2/3 åˆå§‹åŒ–ï¼‰ -->
        <div id="richtext-editor-view" class="hidden">
          <div id="quill-toolbar" class="q-toolbar border rounded-t-xl">
            <span class="ql-formats">
              <select class="ql-header">
                <option selected></option>
                <option value="1"></option>
                <option value="2"></option>
              </select>
              <select class="ql-font"></select>
              <select class="ql-size"></select>
            </span>
            <span class="ql-formats">
              <button class="ql-bold"></button>
              <button class="ql-italic"></button>
              <button class="ql-underline"></button>
              <button class="ql-strike"></button>
            </span>
            <span class="ql-formats">
              <select class="ql-color"></select>
              <select class="ql-background"></select>
            </span>
            <span class="ql-formats">
              <button class="ql-list" value="ordered"></button>
              <button class="ql-list" value="bullet"></button>
              <select class="ql-align"></select>
            </span>
            <span class="ql-formats">
              <button id="btn-insert-image" type="button"><i data-feather="image"></i></button>
            </span>
          </div>
          <div id="quill-editor" class="h-[60vh] bg-white border-x border-b rounded-b-xl"></div>
        </div>

        <!-- PDF é˜…è¯»å™¨ç”»å¸ƒ -->
        <div id="pdf-reader-view" class="hidden">
          <canvas id="pdf-canvas" class="bg-white rounded-2xl shadow border mx-auto block max-w-full"></canvas>
        </div>
      </section>
    </main>
  </div>
</section>

<!-- Modalsï¼ˆåˆ›å»º/é‡å‘½å/ç§»åŠ¨/ç¡®è®¤ï¼‰ -->
<div id="creation-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden-important">
  <div class="card max-w-md mx-auto mt-32 p-6">
    <div class="text-lg font-semibold mb-3" id="creation-title">æ–°å»º</div>
    <input id="creation-input" class="w-full rounded-xl border px-3 py-2 mb-4" placeholder="è¾“å…¥åç§°â€¦" />
    <div class="flex justify-end gap-2">
      <button data-close="#creation-modal" class="btn">å–æ¶ˆ</button>
      <button id="creation-confirm" class="btn btn-primary">ç¡®å®š</button>
    </div>
  </div>
</div>

<div id="rename-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden-important">
  <div class="card max-w-md mx-auto mt-32 p-6">
    <div class="text-lg font-semibold mb-3">é‡å‘½å</div>
    <input id="rename-input" class="w-full rounded-xl border px-3 py-2 mb-4" />
    <div class="flex justify-end gap-2">
      <button data-close="#rename-modal" class="btn">å–æ¶ˆ</button>
      <button id="rename-confirm" class="btn btn-primary">ç¡®å®š</button>
    </div>
  </div>
</div>

<div id="move-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden-important">
  <div class="card max-w-md mx-auto mt-32 p-6">
    <div class="text-lg font-semibold mb-3">ç§»åŠ¨åˆ°</div>
    <select id="move-select" class="w-full rounded-xl border px-3 py-2 mb-4"></select>
    <div class="flex justify-end gap-2">
      <button data-close="#move-modal" class="btn">å–æ¶ˆ</button>
      <button id="move-confirm" class="btn btn-primary">ç¡®å®š</button>
    </div>
  </div>
</div>

<div id="confirm-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden-important">
  <div class="card max-w-md mx-auto mt-32 p-6">
    <div id="confirm-text" class="mb-4">ç¡®å®šè¦æ‰§è¡Œè¯¥æ“ä½œå—ï¼Ÿ</div>
    <div class="flex justify-end gap-2">
      <button data-close="#confirm-modal" class="btn">å–æ¶ˆ</button>
      <button id="confirm-yes" class="btn btn-primary">ç¡®å®š</button>
    </div>
  </div>
</div>

<!-- å³ä¸Šè§’ Toast + å³é”®èœå•å®¹å™¨ -->
<div id="toast" class="fixed right-4 top-4"></div>
<div id="context-menu" class="menu hidden"></div>

<!-- ============ åº”ç”¨è„šæœ¬ï¼ˆç‰‡æ®µ 1/3ï¼šCloudBase/COS åˆå§‹åŒ– + è®¤è¯ + è§†å›¾åˆ‡æ¢ï¼‰ ============ -->
<script>
const CONFIG = {
  envId: "molijun-0gtahyghc6271173",                                  // CloudBase ç¯å¢ƒ
  cosBucket: "notes-1317231591",                                       // COS æ¡¶åï¼ˆBucketName-APPIDï¼‰
  cosRegion: "ap-guangzhou",                                           // COS åŒºåŸŸ
  stsUrl: "https://molijun-0gtahyghc6271173-1317231591.ap-shanghai.app.tcloudbase.com/api/sts", // STS HTTPS
};

// --- CloudBase åˆå§‹åŒ–ï¼ˆå…¨é‡åŒ…å·²å« auth/database æ¨¡å—ï¼‰ ---
let app, auth, db;
try {
  app = cloudbase.init({ env: CONFIG.envId });
  auth = app.auth({ persistence: "local" }); // æŒä¹…åŒ–ç™»å½•
  db = app.database();
} catch (e) {
  console.error("CloudBase åˆå§‹åŒ–å¤±è´¥ï¼š", e);
  showToast("CloudBase åˆå§‹åŒ–å¤±è´¥", "error");
}

// --- COS å®¢æˆ·ç«¯ï¼ˆä½¿ç”¨ STS åŠ¨æ€æˆæƒï¼‰ ---
let cos = new COS({
  getAuthorization: function (options, callback) {
    fetch(CONFIG.stsUrl, { credentials: "include" })
      .then(res => res.json())
      .then(data => {
        const cred = data.credentials || data.data?.credentials;
        if (!cred) throw new Error("STS å“åº”ç¼ºå°‘ credentials");
        callback({
          TmpSecretId: cred.tmpSecretId,
          TmpSecretKey: cred.tmpSecretKey,
          SecurityToken: cred.sessionToken || cred.token || cred.SecurityToken,
          StartTime: data.startTime || Math.floor(Date.now()/1000),
          ExpiredTime: data.expiredTime || (Math.floor(Date.now()/1000) + 1800),
        });
      })
      .catch(err => {
        console.error("è·å– STS å¤±è´¥", err);
        showToast("è·å–ä¸Šä¼ å‡­è¯å¤±è´¥", "error");
      });
  }
});

// ---- ä¾¿æ·å‡½æ•° ----
function $(s){ return document.querySelector(s); }
function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }
function toggle(el){ el.classList.toggle("hidden"); }
function iconRefresh(){ feather.replace(); }
function showToast(text, type="info", ms=2400){
  const box=document.createElement("div");
  box.className="card px-4 py-3 mb-3 border "+(type==="error"?"border-red-200":"border-slate-200");
  box.innerHTML=`<div class="flex items-center gap-2">
    <i data-feather="${type==='error'?'alert-triangle':'check-circle'}"></i>
    <span>${text}</span></div>`;
  $("#toast").appendChild(box);
  iconRefresh();
  setTimeout(()=>box.remove(), ms);
}

// ---- è®¤è¯è§†å›¾åˆ‡æ¢ ----
const tabLogin=$("#tab-login"), tabRegister=$("#tab-register");
const loginForm=$("#login-form"), registerForm=$("#register-form");
tabLogin.addEventListener("click", ()=>{ tabLogin.dataset.active="true"; tabRegister.dataset.active="false"; hide(registerForm); show(loginForm); });
tabRegister.addEventListener("click", ()=>{ tabRegister.dataset.active="true"; tabLogin.dataset.active="false"; hide(loginForm); show(registerForm); });

// ---- ç™»å½• ----
loginForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email=$("#login-email").value.trim();
  const password=$("#login-password").value;
  try{
    await auth.signInWithEmailAndPassword(email,password);
    showToast("ç™»å½•æˆåŠŸ");
    await enterApp();
  }catch(err){
    console.error(err);
    showToast(err?.message||err?.code||"ç™»å½•å¤±è´¥","error");
  }
});

// ---- æ³¨å†Œ ----
registerForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email=$("#register-email").value.trim();
  const password=$("#register-password").value;
  try{
    await auth.signUpWithEmailAndPassword(email,password);
    showToast("æ³¨å†ŒæˆåŠŸï¼ŒéªŒè¯é‚®ä»¶å·²å‘é€");
    tabLogin.click();
  }catch(err){
    console.error(err);
    showToast(err?.message||err?.code||"æ³¨å†Œå¤±è´¥","error");
  }
});

// ---- è¿›å…¥ä¸»åº”ç”¨è§†å›¾ï¼ˆç‰‡æ®µ 2/3 ä¼šåœ¨è¿™é‡ŒæŒ‚ä¸šåŠ¡é€»è¾‘ï¼‰ ----
async function enterApp(){
  const state = await auth.getLoginState();
  if(!state || !auth.currentUser){ showToast("æœªç™»å½•","error"); return; }
  const email = auth.currentUser.username || auth.currentUser.email || "ç”¨æˆ·";
  $("#user-email").textContent = email;
  $("#avatar").textContent = (email[0]||"U").toUpperCase();
  hide($("#auth-view")); show($("#main-app-view"));
  $("#current-title").textContent = "æ¬¢è¿";
  hide($("#article-view")); show($("#welcome-view"));
  iconRefresh();
  // ğŸ‘‰ ç‰‡æ®µ 2/3ï¼šloadFoldersAndArticles();
}

// ---- ç™»å‡º ----
$("#btn-signout").addEventListener("click", async ()=>{
  try{ await auth.signOut(); showToast("å·²é€€å‡ºç™»å½•"); show($("#auth-view")); hide($("#main-app-view")); }
  catch(e){ console.error(e); showToast("é€€å‡ºå¤±è´¥","error"); }
});

// ä¾§æ ä¸æ•°æ®é¢æ¿å¼€å…³ï¼ˆåŠŸèƒ½åœ¨ç‰‡æ®µ 2/3 æ¥ä¸Šï¼‰
$("#btn-data-toggle").addEventListener("click", ()=>toggle($("#data-panel")));
$("#btn-toggle-sidebar").addEventListener("click", ()=>$("#sidebar").classList.toggle("hidden"));

// ---- å¯åŠ¨ï¼šå¦‚å·²ç™»å½•åˆ™ç›´æ¥è¿›å…¥ä¸»è§†å›¾ ----
(async function bootstrap(){
  try{ const s=await auth.getLoginState(); if(s) enterApp(); }catch(e){}
  iconRefresh();
})();
</script>
<!-- ===================== ç‰‡æ®µ 1/3 ç»“æŸï¼ˆä¸è¦åœ¨æ­¤å¤„å†™ </body></html>ï¼‰ ===================== -->
<!-- ============ ç‰‡æ®µ 2/3ï¼šæ•°æ®å±‚ + æ–‡ä»¶æ ‘ + ç¼–è¾‘å™¨ + COS ä¸Šä¼  + PDF é˜…è¯» + å¤‡ä»½ ============ -->
<script>
/* --------------------------- å…¨å±€çŠ¶æ€ --------------------------- */
const COLL = { folders: "folders", articles: "articles" };
let gFolders = [];      // [{_id, name, user_id, created_at}]
let gArticles = [];     // [{_id, title, type:'text'|'pdf', content_html?, cos_key?, folder_id?, user_id, created_at, updated_at}]
let currentArticle = null;
let quill = null;
let isEditing = false;
let editBaseUpdatedAt = 0; // è¿›å…¥ç¼–è¾‘æ—¶çš„äº‘ç«¯æ›´æ–°æ—¶é—´ï¼Œç”¨äºå†²çªæ£€æµ‹

/* --------------------------- å°å·¥å…· --------------------------- */
const uid = () => (auth?.currentUser?.uid || auth?.currentUser?.uid || auth?.currentUser?.userId || ""); // ä»¥ SDK è¿”å›ä¸ºå‡†
function now() { return Date.now(); }
function fmt(ts) {
  const d = new Date(ts); const pad = (n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function stripHtml(html){ const div=document.createElement("div"); div.innerHTML=html||""; return (div.textContent||"").trim(); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* --------------------------- æ–‡ä»¶æ ‘æ¸²æŸ“ --------------------------- */
async function loadFoldersAndArticles() {
  const user = uid();
  if (!user) return;

  try {
    const [fs, as] = await Promise.all([
      db.collection(COLL.folders).where({ user_id: user }).get(),
      db.collection(COLL.articles).where({ user_id: user }).get(),
    ]); // ä¾æ® CloudBase Web DB æ–‡æ¡£ï¼šcollection().where().get() è·å–æ•°æ® :contentReference[oaicite:0]{index=0}

    gFolders = (fs?.data || []).sort((a,b)=>a.created_at-b.created_at);
    gArticles = (as?.data || []).sort((a,b)=>b.updated_at - a.updated_at);

    renderFileTree();
  } catch (e) {
    console.error(e);
    showToast("åŠ è½½æ•°æ®å¤±è´¥","error");
  }
}

function renderFileTree() {
  const tree = $("#file-tree");
  tree.innerHTML = "";

  const byFolder = new Map();
  byFolder.set(null, []); // æœªåˆ†ç±»
  gFolders.forEach(f => byFolder.set(f._id, []));
  gArticles.forEach(a => {
    const list = byFolder.get(a.folder_id || null) || [];
    list.push(a); byFolder.set(a.folder_id || null, list);
  });

  // Helper: æ¸²æŸ“ä¸€ç¯‡æ–‡ç« è¡Œ
  const renderArticleRow = (a) => {
    const row = document.createElement("button");
    row.className = "w-full flex items-center justify-between px-2 py-2 hover:bg-slate-50 rounded-lg";
    row.dataset.id = a._id;
    row.innerHTML = `
      <div class="flex items-center gap-2">
        <i data-feather="${a.type==='pdf'?'file-text':'file'}" class="shrink-0"></i>
        <div class="text-left">
          <div class="text-[13px] leading-5">${a.title || "(æœªå‘½å)"}</div>
          <div class="text-[11px] text-slate-500">${fmt(a.updated_at || a.created_at)}</div>
        </div>
      </div>
      <span class="badge hidden" data-role="draft-dot">è‰ç¨¿</span>
    `;
    row.addEventListener("click", () => openArticle(a._id));
    return row;
  };

  // æœªåˆ†ç±»
  if ((byFolder.get(null) || []).length) {
    const h = document.createElement("div");
    h.className = "mt-3 mb-1 text-xs text-slate-500 px-1"; h.textContent = "æœªåˆ†ç±»";
    tree.appendChild(h);
    byFolder.get(null).forEach(a => tree.appendChild(renderArticleRow(a)));
  }

  // å„æ–‡ä»¶å¤¹
  gFolders.forEach(f => {
    const head = document.createElement("div");
    head.className = "flex items-center justify-between mt-4 mb-1 px-1";
    head.innerHTML = `
      <div class="flex items-center gap-2">
        <i data-feather="folder"></i><span class="text-sm font-medium">${f.name}</span>
      </div>
    `;
    tree.appendChild(head);

    const list = byFolder.get(f._id) || [];
    if (!list.length) {
      const empty = document.createElement("div");
      empty.className = "text-xs text-slate-400 px-2 py-1"; empty.textContent = "ï¼ˆç©ºï¼‰";
      tree.appendChild(empty);
    } else {
      list.forEach(a => tree.appendChild(renderArticleRow(a)));
    }
  });

  iconRefresh();
  // è‰ç¨¿æç¤º
  markDraftBadges();
}

function markDraftBadges() {
  const user = uid();
  if (!user) return;
  document.querySelectorAll("#file-tree [data-role='draft-dot']").forEach(el => el.classList.add("hidden"));
  gArticles.forEach(a => {
    const raw = localStorage.getItem(`draft:${user}:${a._id}`);
    if (!raw) return;
    try {
      const draft = JSON.parse(raw);
      if (draft?.ts && draft.ts > (a.updated_at || 0)) {
        const row = document.querySelector(`#file-tree [data-id="${a._id}"] [data-role='draft-dot']`);
        if (row) row.classList.remove("hidden");
      }
    } catch {}
  });
}

/* --------------------------- æ–°å»ºæ–‡ä»¶å¤¹ / æ–‡ç«  --------------------------- */
$("#btn-new-folder").addEventListener("click", () => {
  openCreationModal("æ–°å»ºæ–‡ä»¶å¤¹", "æ–°å»ºæ–‡ä»¶å¤¹", async (name) => {
    const user = uid(); if (!user) return;
    const res = await db.collection(COLL.folders).add({ name, user_id: user, created_at: now() });
    showToast("æ–‡ä»¶å¤¹å·²åˆ›å»º");
    await loadFoldersAndArticles();
  });
});

$("#btn-new-article").addEventListener("click", () => {
  openCreationModal("æ–°å»ºæ–‡ç« ", "æœªå‘½åæ–‡ç« ", async (title) => {
    const user = uid(); if (!user) return;
    const res = await db.collection(COLL.articles).add({
      title, type: "text", content_html: "<p><br/></p>",
      user_id: user, folder_id: null, created_at: now(), updated_at: now()
    });
    showToast("æ–‡ç« å·²åˆ›å»º");
    await loadFoldersAndArticles();
  });
});

/* --------------------------- æ‰“å¼€æ–‡ç«  --------------------------- */
async function openArticle(id) {
  const target = gArticles.find(a => a._id === id);
  if (!target) return;
  currentArticle = target;
  $("#current-title").textContent = target.title || "æœªå‘½å";
  hide($("#welcome-view")); show($("#article-view"));

  // åˆ‡æ¢æŒ‰é’®å¯è§æ€§
  $("#btn-export").classList.remove("hidden");
  if (target.type === "text") {
    $("#pdf-controls").classList.add("hidden");
    show($("#richtext-editor-view")); hide($("#pdf-reader-view"));
    await ensureQuill();
    quill.setContents([]); // æ¸…ç©º
    const serverHtml = target.content_html || "<p><br/></p>";
    const restored = tryRestoreLocalDraft(serverHtml, target);
    quill.root.innerHTML = restored;
    setEditMode(false);
  } else {
    hide($("#richtext-editor-view")); show($("#pdf-reader-view"));
    $("#pdf-controls").classList.remove("hidden");
    await renderPdfFromCOS(target.cos_key);
    setEditMode(false); // PDF ä¸å¯ç¼–è¾‘
    $("#btn-edit").classList.add("hidden");
    $("#btn-save").classList.add("hidden");
  }
  iconRefresh();
}

/* --------------------------- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ + å›¾ç‰‡ä¸Šä¼  --------------------------- */
async function ensureQuill() {
  if (quill) return;
  quill = new Quill("#quill-editor", {
    theme: "snow",
    modules: { toolbar: "#quill-toolbar" },
    placeholder: "å¼€å§‹è®°å½•ä½ çš„æƒ³æ³•â€¦â€¦"
  });

  // è‡ªå®šä¹‰â€œæ’å…¥å›¾ç‰‡â€ï¼šé€‰æ‹©æ–‡ä»¶ -> ä¸Šä¼  COS -> æ’å…¥é“¾æ¥
  $("#btn-insert-image").addEventListener("click", () => {
    const input = document.createElement("input");
    input.type = "file"; input.accept = "image/*";
    input.onchange = async () => {
      const file = input.files[0];
      if (!file) return;
      try {
        const key = `${uid()}/images/${Date.now()}-${encodeURIComponent(file.name)}`;
        // ä½¿ç”¨ putObject / uploadFile ä¸Šä¼ ï¼ˆå®˜æ–¹ SDK ç¤ºä¾‹æ”¯æŒå¤šç§æ–¹å¼ï¼‰:contentReference[oaicite:1]{index=1}
        await new Promise((resolve, reject) => {
          cos.uploadFile({
            Bucket: CONFIG.cosBucket,
            Region: CONFIG.cosRegion,
            Key: key,
            Body: file,
            SliceSize: 1024 * 1024, // >1MB åˆ†å—
            onProgress: (info)=>{ /* å¯æ˜¾ç¤ºè¿›åº¦ */ },
          }, (err, data) => err ? reject(err) : resolve(data));
        });
        const url = await getSignedUrl(key); // ç”Ÿæˆé¢„ç­¾å URL ä»¥ä¾¿ç§æœ‰æ¡¶è®¿é—® :contentReference[oaicite:2]{index=2}
        const range = quill.getSelection(true);
        quill.insertEmbed(range.index, "image", url, "user");
        quill.setSelection(range.index + 1);
      } catch (e) {
        console.error(e); showToast("å›¾ç‰‡ä¸Šä¼ å¤±è´¥","error");
      }
    };
    input.click();
  });
}

function setEditMode(on) {
  isEditing = !!on;
  const isText = currentArticle?.type === "text";
  $("#btn-edit").classList.toggle("hidden", !isText || on);
  $("#btn-save").classList.toggle("hidden", !isText || !on);
  if (quill) quill.enable(!!on);
  if (on) editBaseUpdatedAt = currentArticle?.updated_at || 0;
}
$("#btn-edit").addEventListener("click", ()=> setEditMode(true));

$("#btn-save").addEventListener("click", async ()=>{
  if (!currentArticle || currentArticle.type !== "text") return;
  try {
    // å†²çªæ£€æµ‹ï¼šå…ˆè¯»æœ€æ–° updated_at å†å†³å®šæ˜¯å¦ä¿å­˜ :contentReference[oaicite:3]{index=3}
    const fresh = await db.collection(COLL.articles).doc(currentArticle._id).get();
    const latest = fresh?.data?.updated_at || 0;
    if (latest > editBaseUpdatedAt) {
      const htmlNow = quill.root.innerHTML;
      await navigator.clipboard?.writeText(stripHtml(htmlNow)).catch(()=>{});
      showToast("æ£€æµ‹åˆ°å†…å®¹å·²åœ¨åˆ«å¤„æ›´æ–°ï¼Œå·²å¤åˆ¶ä½ çš„è‰ç¨¿åˆ°å‰ªè´´æ¿","error");
      currentArticle = fresh.data; // è¦†ç›–åˆ°æœ€æ–°
      quill.root.innerHTML = currentArticle.content_html || "<p><br/></p>";
      setEditMode(false);
      return;
    }

    const html = quill.root.innerHTML;
    await db.collection(COLL.articles).doc(currentArticle._id).update({
      content_html: html, updated_at: now()
    });
    // æ¸…é™¤è‰ç¨¿
    localStorage.removeItem(`draft:${uid()}:${currentArticle._id}`);
    showToast("ä¿å­˜æˆåŠŸ");
    setEditMode(false);
    await loadFoldersAndArticles();
  } catch (e) {
    console.error(e); showToast("ä¿å­˜å¤±è´¥","error");
  }
});

// æœ¬åœ°è‰ç¨¿ï¼šç¼–è¾‘æ—¶æŒç»­ä¿å­˜
setInterval(()=>{
  if (!isEditing || !currentArticle || currentArticle.type !== "text" || !quill) return;
  const key = `draft:${uid()}:${currentArticle._id}`;
  const html = quill.root.innerHTML;
  localStorage.setItem(key, JSON.stringify({ ts: now(), html }));
  markDraftBadges();
}, 2000);

function tryRestoreLocalDraft(serverHtml, article) {
  const key = `draft:${uid()}:${article._id}`;
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return serverHtml;
    const draft = JSON.parse(raw);
    if (draft?.ts > (article.updated_at || 0)) {
      // è‰ç¨¿æ›´æ–°æ›´è¿‘ï¼Œç›´æ¥æ¢å¤
      showToast("å·²åŠ è½½æœ¬åœ°è‰ç¨¿");
      return draft.html || serverHtml;
    }
  } catch {}
  return serverHtml;
}

/* --------------------------- PDF å¯¼å…¥ / é˜…è¯» --------------------------- */
$("#input-import-pdf").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0]; e.target.value = "";
  if (!file) return;
  try {
    const key = `${uid()}/pdfs/${Date.now()}-${encodeURIComponent(file.name)}`;
    await new Promise((resolve, reject) => {
      cos.uploadFile({
        Bucket: CONFIG.cosBucket, Region: CONFIG.cosRegion,
        Key: key, Body: file, SliceSize: 1024 * 1024 * 3,
      }, (err, data)=> err ? reject(err) : resolve(data));
    }); // é«˜çº§ä¸Šä¼ /åˆ†å—ä¸Šä¼ ï¼Œè§ COS JS SDK ç¤ºä¾‹ :contentReference[oaicite:4]{index=4}

    const title = file.name.replace(/\.(pdf)$/i,"");
    const user = uid();
    await db.collection(COLL.articles).add({
      title, type: "pdf", cos_key: key, user_id: user, folder_id: null,
      created_at: now(), updated_at: now()
    });
    showToast("PDF å·²å¯¼å…¥");
    await loadFoldersAndArticles();
  } catch (e) {
    console.error(e); showToast("PDF å¯¼å…¥å¤±è´¥","error");
  }
});

let pdfDoc=null, pdfPage=1, pdfTotal=1, pdfRendering=false;
async function renderPdfFromCOS(key) {
  const url = await getSignedUrl(key);  // é¢„ç­¾å URL ç”¨äºç§æœ‰è¯» :contentReference[oaicite:5]{index=5}
  const loading = pdfjsLib.getDocument(url); // æ ‡å‡† PDF.js åŠ è½½å¹¶æ¸²æŸ“é¡µé¢ :contentReference[oaicite:6]{index=6}
  pdfDoc = await loading.promise;
  pdfTotal = pdfDoc.numPages; pdfPage = 1;
  $("#pdf-total").textContent = String(pdfTotal);
  await renderPdfPage();
}
async function renderPdfPage() {
  if (!pdfDoc) return;
  const canvas = $("#pdf-canvas"), ctx = canvas.getContext("2d");
  const page = await pdfDoc.getPage(pdfPage);
  const viewport = page.getViewport({ scale: 1.5 });
  canvas.width = viewport.width; canvas.height = viewport.height;
  await page.render({ canvasContext: ctx, viewport }).promise;
  $("#pdf-page").textContent = String(pdfPage);
}
$("#btn-pdf-prev").addEventListener("click", async ()=>{ if(pdfPage>1){ pdfPage--; await renderPdfPage(); }});
$("#btn-pdf-next").addEventListener("click", async ()=>{ if(pdfPage<pdfTotal){ pdfPage++; await renderPdfPage(); }});

async function getSignedUrl(key, inline=false){
  return await new Promise((resolve, reject)=>{
    cos.getObjectUrl({
      Bucket: CONFIG.cosBucket, Region: CONFIG.cosRegion, Key: key, Sign: true,
      Headers: inline ? { "Content-Disposition": "inline" } : undefined
    }, (err, data)=> err ? reject(err) : resolve(data?.Url || data?.url));
  }); // getObjectUrl ç”Ÿæˆå¸¦ç­¾åçš„å¯è®¿é—® URL :contentReference[oaicite:7]{index=7}
}

/* --------------------------- å¯¼å…¥/å¯¼å‡ºå¤‡ä»½ï¼ˆJSONï¼‰ --------------------------- */
$("#btn-export-backup").addEventListener("click", async ()=>{
  const user = uid(); if (!user) return;
  try{
    const [fs, as] = await Promise.all([
      db.collection(COLL.folders).where({ user_id: user }).get(),
      db.collection(COLL.articles).where({ user_id: user }).get()
    ]);
    const payload = {
      version: 1,
      exported_at: now(),
      folders: fs.data || [],
      articles: as.data || []
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `cloud-notes-backup-${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    showToast("å·²å¯¼å‡ºå¤‡ä»½ JSON");
  }catch(e){ console.error(e); showToast("å¯¼å‡ºå¤±è´¥","error"); }
});

$("#input-import-backup").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0]; e.target.value = "";
  if (!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text || "{}");
    if (!data || !Array.isArray(data.articles) || !Array.isArray(data.folders)) throw new Error("æ ¼å¼ä¸æ­£ç¡®");
    if (!confirm("å¯¼å…¥å°†æ¸…ç©ºä½ å½“å‰äº‘ç«¯æ•°æ®å¹¶å®Œæ•´æ¢å¤å¤‡ä»½ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")) return;

    const user = uid(); if (!user) return;

    // å…ˆæ¸…ç©º
    await db.collection(COLL.articles).where({ user_id: user }).remove(); // CloudBase æ”¯æŒ where().remove() æ‰¹é‡åˆ é™¤ :contentReference[oaicite:8]{index=8}
    await db.collection(COLL.folders).where({ user_id: user }).remove();

    // å†å†™å…¥
    const tasks = [];
    (data.folders||[]).forEach(f=>{
      const {_id, ...rest} = f;
      tasks.push(db.collection(COLL.folders).add({ ...rest, user_id: user }));
    });
    (data.articles||[]).forEach(a=>{
      const {_id, user_id, ...rest} = a;
      tasks.push(db.collection(COLL.articles).add({ ...rest, user_id: user }));
    });
    await Promise.all(tasks);
    showToast("å¯¼å…¥å®Œæˆ");
    await loadFoldersAndArticles();
  }catch(e){ console.error(e); showToast("å¯¼å…¥å¤±è´¥","error"); }
});

/* --------------------------- å•ç¯‡å¯¼å‡ºï¼ˆtxt / pdfï¼‰ --------------------------- */
$("#btn-export").addEventListener("click", async ()=>{
  if (!currentArticle) return;
  if (currentArticle.type === "text") {
    const html = quill ? quill.root.innerHTML : (currentArticle.content_html || "");
    // å¼¹ä¸€ä¸ªç®€æ˜“é€‰æ‹©ï¼ˆç‰‡æ®µ3ä¼šæ”¹ä¸ºèœå•ï¼‰
    const asPdf = confirm("ç¡®å®šå¯¼å‡ºä¸º PDF å—ï¼Ÿï¼ˆå–æ¶ˆå°†å¯¼å‡ºä¸º TXTï¼‰");
    if (asPdf) {
      await exportArticleAsPDF(currentArticle.title || "æœªå‘½å", html);
    } else {
      const blob = new Blob([stripHtml(html)], {type: "text/plain;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${(currentArticle.title||"note")}.txt`;
      a.click(); URL.revokeObjectURL(a.href);
    }
  } else {
    // PDF ç¬”è®°ï¼šç›´æ¥ä¸‹è½½åŸæ–‡ä»¶
    const url = await getSignedUrl(currentArticle.cos_key, false);
    const a = document.createElement("a");
    a.href = url; a.download = `${(currentArticle.title||"note")}.pdf`;
    a.click();
  }
});

async function exportArticleAsPDF(title, html) {
  // ç”¨ jsPDF + html2canvas å¿«é€Ÿå¯¼å‡º
  const { jsPDF } = window.jspdf;
  const wrapper = document.createElement("div");
  wrapper.style.padding = "24px";
  wrapper.style.width = "794px"; // A4 96dpi approx
  wrapper.innerHTML = `<h1 style="font-size:20px;margin:0 0 12px 0;">${title}</h1>${html}`;
  document.body.appendChild(wrapper);
  const canvas = await html2canvas(wrapper, { scale: 2, useCORS: true });
  const img = canvas.toDataURL("image/png");
  const pdf = new jsPDF({ unit: "pt", format: "a4" });
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  // ç­‰æ¯”ç¼©æ”¾
  const imgWidth = pageWidth - 60, imgHeight = canvas.height * (imgWidth / canvas.width);
  let remaining = imgHeight, y = 30;
  pdf.addImage(img, "PNG", 30, y, imgWidth, Math.min(imgHeight, pageHeight-60));
  remaining -= (pageHeight - 60);
  while (remaining > 0) {
    pdf.addPage();
    y = 30 - (imgHeight - remaining);
    pdf.addImage(img, "PNG", 30, y, imgWidth, Math.min(imgHeight, pageHeight-60));
    remaining -= (pageHeight - 60);
  }
  pdf.save(`${title||"note"}.pdf`);
  wrapper.remove();
}

/* --------------------------- åˆ›å»ºå¼¹çª—ï¼ˆç‰‡æ®µ1å·²æœ‰ DOMï¼Œè¿™é‡Œå°è£…é€»è¾‘ï¼‰ --------------------------- */
function openCreationModal(title, placeholder, onConfirm){
  $("#creation-title").textContent = title;
  $("#creation-input").value = placeholder || ""; show($("#creation-modal"));
  $("#creation-confirm").onclick = async ()=>{
    const val = $("#creation-input").value.trim();
    if(!val){ showToast("è¯·è¾“å…¥åç§°","error"); return;}
    hide($("#creation-modal"));
    try{ await onConfirm?.(val); }catch(e){ console.error(e); showToast("æ“ä½œå¤±è´¥","error"); }
  };
}
document.querySelectorAll("[data-close='#creation-modal']").forEach(b=>b.addEventListener("click", ()=>hide($("#creation-modal"))));

/* --------------------------- è¿›å…¥åº”ç”¨ååŠ è½½æ•°æ® --------------------------- */
(async function afterEnterPatch(){
  // å¦‚æœç”¨æˆ·å·²åœ¨ç‰‡æ®µ1ä¸­è¿›å…¥ä¸»è§†å›¾ï¼Œè¿™é‡Œæ³¨å†Œä¸€æ¬¡æ€§åŠ è½½
  // ä»¥åŠé’ˆå¯¹åç»­ç™»å½•è¿›å…¥çš„æƒ…å†µï¼Œåœ¨ enterApp() ä¸­ä¼šå†è°ƒç”¨å®ƒ
  if ($("#main-app-view") && !$("#auth-view").classList.contains("hidden")) return;
})();

// å°†å‡½æ•°æš´éœ²ç»™ç‰‡æ®µ1é‡Œçš„ enterApp è°ƒç”¨
window.loadFoldersAndArticles = loadFoldersAndArticles;

// è¦†å†™ç‰‡æ®µ1ä¸­çš„ enterApp å°¾éƒ¨è°ƒç”¨
const _enterAppV1 = enterApp;
enterApp = async function(){
  await _enterAppV1();
  await loadFoldersAndArticles();
}
</script>
<!-- ===================== ç‰‡æ®µ 2/3 ç»“æŸï¼ˆä¸è¦åœ¨æ­¤å¤„å†™ </body></html>ï¼‰ ===================== -->
<!-- ============ ç‰‡æ®µ 3/3ï¼šå³é”®èœå• + é‡å‘½å/ç§»åŠ¨/åˆ é™¤ + æ›´å¤šèœå• + æ”¶å°¾ ============ -->
<script>
/* --------------------------- Modal å°è£…ï¼ˆé‡å‘½å / ç§»åŠ¨ / ç¡®è®¤ï¼‰ --------------------------- */
function openRenameModal(initial, onConfirm){
  $("#rename-input").value = initial || "";
  show($("#rename-modal"));
  $("#rename-confirm").onclick = async ()=>{
    const val = $("#rename-input").value.trim();
    if(!val){ showToast("è¯·è¾“å…¥æ–°åç§°","error"); return; }
    hide($("#rename-modal"));
    try{ await onConfirm?.(val); }catch(e){ console.error(e); showToast("é‡å‘½åå¤±è´¥","error"); }
  };
}
function openMoveModal(currentFolderId, onConfirm){
  const sel = $("#move-select");
  sel.innerHTML = `<option value="">æœªåˆ†ç±»</option>` + gFolders.map(f=>`<option value="${f._id}">${f.name}</option>`).join("");
  sel.value = currentFolderId || "";
  show($("#move-modal"));
  $("#move-confirm").onclick = async ()=>{
    const val = sel.value || null;
    hide($("#move-modal"));
    try{ await onConfirm?.(val); }catch(e){ console.error(e); showToast("ç§»åŠ¨å¤±è´¥","error"); }
  };
}
function openConfirm(text, onYes){
  $("#confirm-text").textContent = text || "ç¡®å®šè¦æ‰§è¡Œè¯¥æ“ä½œå—ï¼Ÿ";
  show($("#confirm-modal"));
  $("#confirm-yes").onclick = async ()=>{
    hide($("#confirm-modal"));
    try{ await onYes?.(); }catch(e){ console.error(e); showToast("æ“ä½œå¤±è´¥","error"); }
  };
}
;["#rename-modal","#move-modal","#confirm-modal"].forEach(sel=>{
  document.querySelectorAll(`[data-close='${sel}']`).forEach(b=>b.addEventListener("click", ()=>hide($(sel))));
});

/* --------------------------- ä¸Šä¸‹æ–‡ï¼ˆå³é”®ï¼‰èœå• --------------------------- */
const ctxMenu = $("#context-menu");
let ctxMenuOutsideCloser = null;
function openContextMenu(items, x, y){
  ctxMenu.innerHTML = "";
  items.forEach(it=>{
    const btn = document.createElement("button");
    btn.textContent = it.label;
    btn.onclick = ()=>{ closeContextMenu(); it.action?.(); };
    ctxMenu.appendChild(btn);
  });
  ctxMenu.style.left = x + "px";
  ctxMenu.style.top  = y + "px";
  ctxMenu.classList.remove("hidden");
  if (ctxMenuOutsideCloser) { document.removeEventListener("click", ctxMenuOutsideCloser); }
  ctxMenuOutsideCloser = (e)=>{ if (!ctxMenu.contains(e.target)) closeContextMenu(); };
  setTimeout(()=>document.addEventListener("click", ctxMenuOutsideCloser), 0);
}
function closeContextMenu(){
  ctxMenu.classList.add("hidden");
  if (ctxMenuOutsideCloser) { document.removeEventListener("click", ctxMenuOutsideCloser); ctxMenuOutsideCloser = null; }
}

/* --------------------------- è¦†ç›–æ¸²æŸ“æ–‡ä»¶æ ‘ï¼šä¸ºèŠ‚ç‚¹è¡¥å…… dataset ä¸å³é”®èœå• --------------------------- */
const _renderFileTreeV2 = renderFileTree;
renderFileTree = function(){
  const tree = $("#file-tree");
  tree.innerHTML = "";

  const byFolder = new Map();
  byFolder.set(null, []);
  gFolders.forEach(f => byFolder.set(f._id, []));
  gArticles.forEach(a => {
    const list = byFolder.get(a.folder_id || null) || [];
    list.push(a); byFolder.set(a.folder_id || null, list);
  });

  // æ¸²æŸ“æ–‡ç« è¡Œï¼ˆå¸¦ data-*ï¼‰
  const renderArticleRow = (a) => {
    const row = document.createElement("button");
    row.className = "w-full flex items-center justify-between px-2 py-2 hover:bg-slate-50 rounded-lg node-article";
    row.dataset.type = "article";
    row.dataset.id = a._id;
    row.innerHTML = `
      <div class="flex items-center gap-2">
        <i data-feather="${a.type==='pdf'?'file-text':'file'}" class="shrink-0"></i>
        <div class="text-left">
          <div class="text-[13px] leading-5">${a.title || "(æœªå‘½å)"}</div>
          <div class="text-[11px] text-slate-500">${fmt(a.updated_at || a.created_at)}</div>
        </div>
      </div>
      <span class="badge hidden" data-role="draft-dot">è‰ç¨¿</span>
    `;
    row.addEventListener("click", () => openArticle(a._id));
    row.addEventListener("contextmenu", (e)=>{
      e.preventDefault(); openArticleContextMenu(a, e.clientX, e.clientY);
    });
    return row;
  };

  // æœªåˆ†ç±»
  const uncats = byFolder.get(null) || [];
  if (uncats.length) {
    const h = document.createElement("div");
    h.className = "mt-3 mb-1 text-xs text-slate-500 px-1"; h.textContent = "æœªåˆ†ç±»";
    tree.appendChild(h);
    uncats.forEach(a => tree.appendChild(renderArticleRow(a)));
  }

  // æ–‡ä»¶å¤¹
  gFolders.forEach(f=>{
    const head = document.createElement("div");
    head.className = "flex items-center justify-between mt-4 mb-1 px-1 node-folder";
    head.dataset.type = "folder";
    head.dataset.id = f._id;
    head.innerHTML = `
      <div class="flex items-center gap-2">
        <i data-feather="folder"></i><span class="text-sm font-medium">${f.name}</span>
      </div>`;
    head.addEventListener("contextmenu", (e)=>{
      e.preventDefault(); openFolderContextMenu(f, e.clientX, e.clientY);
    });
    tree.appendChild(head);

    const list = byFolder.get(f._id) || [];
    if (!list.length) {
      const empty = document.createElement("div");
      empty.className = "text-xs text-slate-400 px-2 py-1"; empty.textContent = "ï¼ˆç©ºï¼‰";
      tree.appendChild(empty);
    } else {
      list.forEach(a => tree.appendChild(renderArticleRow(a)));
    }
  });

  iconRefresh();
  markDraftBadges();
}

/* --------------------------- èŠ‚ç‚¹å³é”®èœå•é¡¹ --------------------------- */
function openFolderContextMenu(folder, x, y){
  openContextMenu([
    { label: "åœ¨æ­¤æ–°å»ºæ–‡ç« ", action: async ()=>{
        const user = uid(); if(!user) return;
        const res = await db.collection(COLL.articles).add({
          title: "æœªå‘½åæ–‡ç« ", type:"text", content_html:"<p><br/></p>",
          user_id: user, folder_id: folder._id, created_at: now(), updated_at: now()
        });
        await loadFoldersAndArticles(); showToast("å·²åˆ›å»ºæ–‡ç« ");
      } },
    { label: "é‡å‘½åæ–‡ä»¶å¤¹", action: ()=> openRenameModal(folder.name, async (name)=>{
        await db.collection(COLL.folders).doc(folder._id).update({ name });
        await loadFoldersAndArticles(); showToast("æ–‡ä»¶å¤¹å·²é‡å‘½å");
      }) },
    { label: "åˆ é™¤æ–‡ä»¶å¤¹ï¼ˆè¿å¸¦å…¶ä¸­æ–‡ç« ï¼‰", action: ()=> openConfirm("åˆ é™¤è¯¥æ–‡ä»¶å¤¹å°†çº§è”åˆ é™¤å…¶ä¸­æ–‡ç« ï¼Œä¸” PDF æ–‡ä»¶ä¼šä¸€å¹¶ä» COS åˆ é™¤ã€‚ç»§ç»­ï¼Ÿ", async ()=>{
        await deleteFolderCascade(folder._id);
        await loadFoldersAndArticles(); showToast("æ–‡ä»¶å¤¹åŠå…¶ä¸­æ–‡ç« å·²åˆ é™¤");
      }) }
  ], x, y);
}

function openArticleContextMenu(article, x, y){
  const items = [
    { label: "æ‰“å¼€", action: ()=> openArticle(article._id) },
  ];
  if (article.type === "text") {
    items.push(
      { label: isEditing && currentArticle?._id===article._id ? "ä¿å­˜" : "ç¼–è¾‘",
        action: ()=>{
          if (currentArticle?._id !== article._id) openArticle(article._id);
          if (isEditing) $("#btn-save").click(); else $("#btn-edit").click();
        }
      },
      { label: "å¯¼å‡ºä¸º TXT", action: async ()=>{
          if (currentArticle?._id !== article._id) await openArticle(article._id);
          const html = quill ? quill.root.innerHTML : (article.content_html || "");
          const blob = new Blob([stripHtml(html)], {type: "text/plain;charset=utf-8"});
          const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
          a.download = `${(article.title||"note")}.txt`; a.click(); URL.revokeObjectURL(a.href);
        } },
      { label: "å¯¼å‡ºä¸º PDF", action: async ()=>{
          if (currentArticle?._id !== article._id) await openArticle(article._id);
          const html = quill ? quill.root.innerHTML : (article.content_html || "");
          await exportArticleAsPDF(article.title||"note", html);
        } },
    );
  } else { // pdf
    items.push(
      { label: "ä¸‹è½½åŸ PDF", action: async ()=>{
          const url = await getSignedUrl(article.cos_key, false);
          const a = document.createElement("a"); a.href = url; a.download = `${(article.title||"note")}.pdf`; a.click();
        } }
    );
  }
  items.push(
    { label: "é‡å‘½å", action: ()=> openRenameModal(article.title||"æœªå‘½å", async (name)=>{
        await db.collection(COLL.articles).doc(article._id).update({ title: name, updated_at: now() });
        if (currentArticle && currentArticle._id===article._id) { currentArticle.title = name; $("#current-title").textContent = name; }
        await loadFoldersAndArticles(); showToast("æ–‡ç« å·²é‡å‘½å");
      }) },
    { label: "ç§»åŠ¨åˆ°â€¦", action: ()=> openMoveModal(article.folder_id||"", async (folderId)=>{
        await db.collection(COLL.articles).doc(article._id).update({ folder_id: folderId });
        if (currentArticle && currentArticle._id===article._id) currentArticle.folder_id = folderId;
        await loadFoldersAndArticles(); showToast("å·²ç§»åŠ¨æ–‡ç« ");
      }) },
    { label: "åˆ é™¤", action: ()=> openConfirm("ç¡®å®šåˆ é™¤è¯¥æ–‡ç« ï¼Ÿï¼ˆPDF å°†è¿å¸¦åˆ é™¤ COS æ–‡ä»¶ï¼‰", async ()=>{
        await deleteArticle(article._id);
        if (currentArticle && currentArticle._id===article._id) {
          currentArticle = null; $("#current-title").textContent = "æ¬¢è¿";
          show($("#welcome-view")); hide($("#article-view"));
        }
        await loadFoldersAndArticles(); showToast("æ–‡ç« å·²åˆ é™¤");
      }) }
  );
  openContextMenu(items, x, y);
}

/* --------------------------- åˆ é™¤é€»è¾‘ï¼ˆå« COS å¯¹è±¡ï¼‰ --------------------------- */
async function deleteArticle(articleId){
  try{
    const r = await db.collection(COLL.articles).doc(articleId).get();
    const art = r?.data || gArticles.find(a=>a._id===articleId);
    if (art && art.type==="pdf" && art.cos_key) {
      await new Promise((resolve)=> {
        cos.deleteObject({ Bucket: CONFIG.cosBucket, Region: CONFIG.cosRegion, Key: art.cos_key },
          (err)=>{ if(err){ console.warn("COS åˆ é™¤å¤±è´¥", err); } resolve(); });
      });
    }
    await db.collection(COLL.articles).doc(articleId).remove();
  }catch(e){ console.error(e); throw e; }
}

async function deleteFolderCascade(folderId){
  const arts = await db.collection(COLL.articles).where({ folder_id: folderId }).get();
  const list = arts?.data || [];
  for (const a of list) { await deleteArticle(a._id); }
  await db.collection(COLL.folders).doc(folderId).remove();
}

/* --------------------------- é¡¶éƒ¨â€œæ›´å¤šâ€æŒ‰é’®ï¼ˆå½“å‰æ–‡ç« æ“ä½œï¼‰ --------------------------- */
$("#btn-more").addEventListener("click", (e)=>{
  const rect = e.currentTarget.getBoundingClientRect();
  const x = rect.left, y = rect.bottom+6;
  const items = [];
  if (currentArticle) {
    if (currentArticle.type === "text") {
      items.push(
        { label: isEditing ? "ä¿å­˜" : "ç¼–è¾‘", action: ()=> (isEditing? $("#btn-save").click() : $("#btn-edit").click()) },
        { label: "å¯¼å‡ºä¸º TXT", action: async ()=>{
            const html = quill ? quill.root.innerHTML : (currentArticle.content_html || "");
            const blob = new Blob([stripHtml(html)], {type: "text/plain;charset=utf-8"});
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
            a.download = `${(currentArticle.title||"note")}.txt`; a.click(); URL.revokeObjectURL(a.href);
          } },
        { label: "å¯¼å‡ºä¸º PDF", action: async ()=>{
            const html = quill ? quill.root.innerHTML : (currentArticle.content_html || "");
            await exportArticleAsPDF(currentArticle.title||"note", html);
          } }
      );
    } else {
      items.push({ label: "ä¸‹è½½åŸ PDF", action: async ()=>{
        const url = await getSignedUrl(currentArticle.cos_key, false);
        const a = document.createElement("a"); a.href = url; a.download = `${(currentArticle.title||"note")}.pdf`; a.click();
      }});
    }
    items.push(
      { label: "é‡å‘½å", action: ()=> openRenameModal(currentArticle.title||"æœªå‘½å", async (name)=>{
          await db.collection(COLL.articles).doc(currentArticle._id).update({ title: name, updated_at: now() });
          currentArticle.title = name; $("#current-title").textContent = name;
          await loadFoldersAndArticles(); showToast("æ–‡ç« å·²é‡å‘½å");
        }) },
      { label: "ç§»åŠ¨åˆ°â€¦", action: ()=> openMoveModal(currentArticle.folder_id||"", async (fid)=>{
          await db.collection(COLL.articles).doc(currentArticle._id).update({ folder_id: fid });
          currentArticle.folder_id = fid;
          await loadFoldersAndArticles(); showToast("å·²ç§»åŠ¨æ–‡ç« ");
        }) },
      { label: "åˆ é™¤", action: ()=> openConfirm("ç¡®å®šåˆ é™¤å½“å‰æ–‡ç« ï¼Ÿ", async ()=>{
          await deleteArticle(currentArticle._id);
          currentArticle = null; $("#current-title").textContent = "æ¬¢è¿";
          show($("#welcome-view")); hide($("#article-view"));
          await loadFoldersAndArticles(); showToast("æ–‡ç« å·²åˆ é™¤");
        }) }
    );
  } else {
    items.push({ label: "æ— å¯æ“ä½œçš„æ–‡ç« ", action: ()=>{} });
  }
  openContextMenu(items, x, y);
});

/* --------------------------- è¾…åŠ©ï¼šåœ¨è¿›å…¥åº”ç”¨æ—¶ç¡®ä¿åŠ è½½ä¸€æ¬¡æ•°æ®ï¼ˆä¸ç‰‡æ®µ 2 åä½œï¼‰ --------------------------- */
if (typeof loadFoldersAndArticles === "function") {
  // å·²åœ¨ 2/3 ä¸­æ³¨å…¥ enterApp è¦†ç›–ï¼›è¿™é‡Œåªåœ¨é¦–æ¬¡è¿›å…¥ä¸»è§†å›¾åç‚¹å‡»â€œæ›´å¤šâ€ç­‰ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
}

/* --------------------------- å°çš„ UX è°ƒæ•´ --------------------------- */
// ESC å…³é—­ä»»ä¸€èœå•/å¼¹çª—
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){
    closeContextMenu();
    ["#creation-modal","#rename-modal","#move-modal","#confirm-modal"].forEach(sel=>hide($(sel)));
  }
});
</script>

</body>
</html>
