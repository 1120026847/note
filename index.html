<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æç®€ç¬”è®° Â· äº‘ç«¯ç‰ˆ</title>

  <!-- CloudBase JS SDKï¼ˆå…¨é‡ï¼‰ -->
  <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.21.6/cloudbase.full.js"></script>
  <!-- COS JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>

  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --border:#e5e7eb; --muted:#6b7280; --text:#0f172a; --brand:#0f172a;
      --danger:#b91c1c; --radius:14px;
      --drop:#eef2ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial}
    .app{max-width:1200px;margin:0 auto;height:100%;display:grid;grid-template-rows:auto 1fr}
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;border-bottom:1px solid var(--border);background:var(--card);
      position:sticky;top:0;z-index:5;
    }
    header h1{font-size:18px;margin:0;display:flex;gap:10px;align-items:center}
    header .hint{color:var(--muted);font-size:12px}

    .main{display:grid;grid-template-columns:280px 1fr;gap:16px;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius)}
    .sidebar{padding:12px;display:flex;flex-direction:column;gap:12px;height:calc(100vh - 80px)}
    .sidebar .user{display:flex;align-items:center;justify-content:space-between;border:1px dashed var(--border);border-radius:12px;padding:10px}
    .btn{border:1px solid var(--brand);background:var(--brand);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--text);border-color:var(--border)}
    .btn.ghost{background:transparent;border-color:var(--border)}
    .btn.danger{background:var(--danger);border-color:var(--danger)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,textarea{font:inherit;border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff}
    input[type="search"]{width:100%}
    .muted{color:var(--muted);font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
    .hidden{display:none !important}

    .list{list-style:none;margin:0;padding:0;overflow:auto}
    .list li{display:flex;justify-content:space-between;align-items:center;gap:10px;border-top:1px solid #f1f5f9;padding:10px 6px}
    .list li:first-child{border-top:0}
    .list .meta{display:flex;flex-direction:column}
    .list .meta .name{font-size:13px}
    .list .meta .time{font-size:12px;color:var(--muted)}
    .list .ops{display:flex;gap:6px}

    .editor{padding:14px;display:flex;flex-direction:column;gap:10px;min-height:560px;position:relative}
    .editor .toolbar{display:flex;align-items:center;justify-content:space-between}
    .editor .toolbar .title{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .editor textarea{width:100%;min-height:380px;resize:vertical}
    .placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--muted);gap:8px;height:420px}

    /* æ‹–æ‹½é«˜äº® */
    .drop-mask{
      position:absolute;inset:0;border-radius:var(--radius);
      border:2px dashed #818cf8;background:var(--drop);
      display:none;align-items:center;justify-content:center;
      color:#4338ca;font-weight:600;font-size:16px
    }
    .editor.dragover .drop-mask{display:flex}
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>ğŸ“ æç®€ç¬”è®°</h1>
    <div class="row">
      <button id="btnToggleEdit" class="btn hidden">ç¼–è¾‘</button>
      <button id="btnLogout" class="btn secondary hidden">é€€å‡ºç™»å½•</button>
    </div>
  </header>

  <div class="main">
    <!-- å·¦ä¾§ï¼šè´¦æˆ· / æ–°å»º / æœç´¢ / åˆ—è¡¨ -->
    <aside class="sidebar card">
      <div class="user">
        <div>
          <div class="mono" id="accountEmail">æœªç™»å½•</div>
          <div class="muted" id="accountUid"></div>
        </div>
        <div class="row">
          <button id="btnOpenAuth" class="btn ghost">ç™»å½•/æ³¨å†Œ</button>
        </div>
      </div>

      <div class="card" style="padding:10px">
        <div class="row">
          <button id="btnNew" class="btn">æ–°å»ºæ–‡ç« </button>
          <button id="btnRefresh" class="btn secondary">åˆ·æ–°</button>
        </div>
        <div class="row" style="margin-top:8px">
          <input id="searchInput" type="search" placeholder="æœç´¢æ–‡ä»¶åâ€¦" />
          <button id="btnSearch" class="btn secondary">æœç´¢</button>
          <button id="btnClearSearch" class="btn secondary">æ¸…ç©º</button>
        </div>
      </div>

      <div style="font-weight:600;padding:0 4px">æ•°æ®ç®¡ç†</div>
      <ul class="list card" id="noteList" style="padding:6px"></ul>
      <div class="muted mono" id="listState" style="padding:0 6px"></div>
    </aside>

    <!-- å³ä¾§ï¼šç¼–è¾‘å™¨ï¼ˆæ–°å¢æ‹–æ‹½æç¤ºå±‚ï¼‰ -->
    <section class="editor card" id="editorCard">
      <div class="toolbar">
        <div class="title">
          <input id="noteTitle" placeholder="è¯·è¾“å…¥æ ‡é¢˜â€¦" style="min-width:220px;width:320px" />
          <span class="muted" id="fileHint"></span>
        </div>
        <div class="muted" id="saveState"></div>
      </div>
      <textarea id="noteContent" placeholder="åœ¨è¿™é‡Œè¾“å…¥å†…å®¹â€¦ï¼ˆå¯ç›´æ¥ç²˜è´´/æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ï¼‰"></textarea>

      <div id="emptyHint" class="placeholder">
        <div style="font-size:40px">âœï¸</div>
        <div>è¯·é€‰æ‹©å·¦ä¾§æ–‡ç« ï¼Œæˆ–ç‚¹å‡»ã€Œæ–°å»ºæ–‡ç« ã€</div>
      </div>

      <!-- æ‹–æ‹½é«˜äº®é®ç½© -->
      <div id="dropMask" class="drop-mask">æ¾å¼€å³å¯ä¸Šä¼ å›¾ç‰‡åˆ° COS</div>
    </section>
  </div>
</div>

<!-- ç™»å½•/æ³¨å†Œï¼ˆè½»é‡å¼¹å±‚ï¼‰ -->
<div id="authModal" class="card hidden" style="position:fixed;inset:auto 16px 16px auto;max-width:680px;padding:14px;box-shadow:0 10px 30px rgb(0 0 0 / .1)">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <strong>ç™»å½• / æ³¨å†Œ</strong>
    <button id="btnCloseAuth" class="btn secondary">å…³é—­</button>
  </div>
  <div class="row">
    <input id="email" type="email" placeholder="é‚®ç®±" />
    <input id="password" type="password" placeholder="å¯†ç ï¼ˆ8-32ä½ï¼‰" />
    <input id="emailCode" placeholder="é‚®ç®±éªŒè¯ç ï¼ˆæ³¨å†Œå¿…å¡«ï¼‰" />
  </div>
  <div class="row" style="margin-top:8px">
    <button id="btnSendCode" class="btn secondary">å‘é€éªŒè¯ç ï¼ˆæ³¨å†Œï¼‰</button>
    <button id="btnSignUp" class="btn">æ³¨å†Œ</button>
    <button id="btnSignIn" class="btn secondary">ç™»å½•</button>
  </div>
  <div class="muted" style="margin-top:6px">æµç¨‹ï¼šå‘é€éªŒè¯ç  â†’ é‚®ç®±å–ç  â†’ å›å¡«éªŒè¯ç  â†’ ç‚¹å‡»æ³¨å†Œï¼ˆæˆåŠŸå°†è‡ªåŠ¨ç™»å½•ï¼‰ã€‚</div>
  <div class="mono" id="authState" style="margin-top:6px"></div>
</div>

<script>
/* ========= 0) ç¯å¢ƒé…ç½® ========= */
const CLOUDBASE_ENV = "molijun-0gtahyghc6271173";
const STS_URL       = "https://molijun-0gtahyghc6271173-1317231591.ap-shanghai.app.tcloudbase.com/api/sts";

/* ========= 1) SDK åˆå§‹åŒ– / è®¤è¯ ========= */
const app  = cloudbase.init({ env: CLOUDBASE_ENV });
const auth = app.auth(); // signUp/signIn/signOut/verify ç­‰

// DOM å¿«æ·
const $ = id => document.getElementById(id);
const ui = {
  // é¡¶éƒ¨ä¸å³æ 
  btnToggleEdit:$("btnToggleEdit"),
  btnLogout:$("btnLogout"),
  accountEmail:$("accountEmail"),
  accountUid:$("accountUid"),
  editorCard:$("editorCard"),
  noteTitle:$("noteTitle"),
  noteContent:$("noteContent"),
  fileHint:$("fileHint"),
  saveState:$("saveState"),
  emptyHint:$("emptyHint"),
  dropMask:$("dropMask"),
  // å·¦æ 
  btnOpenAuth:$("btnOpenAuth"),
  btnCloseAuth:$("btnCloseAuth"),
  btnNew:$("btnNew"),
  btnRefresh:$("btnRefresh"),
  searchInput:$("searchInput"),
  btnSearch:$("btnSearch"),
  btnClearSearch:$("btnClearSearch"),
  noteList:$("noteList"),
  listState:$("listState"),
  // å¼¹å±‚ï¼ˆç™»å½•/æ³¨å†Œï¼‰
  authModal:$("authModal"),
  email:$("email"),
  password:$("password"),
  emailCode:$("emailCode"),
  btnSendCode:$("btnSendCode"),
  btnSignUp:$("btnSignUp"),
  btnSignIn:$("btnSignIn"),
  authState:$("authState"),
};

/* ========= 2) UI çŠ¶æ€ ========= */
let currentUID = null;
let currentEmail = null;
let latestObjects = [];   // æœ€è¿‘åˆ—è¡¨ç¼“å­˜ï¼ˆä¾›æœ¬åœ°æœç´¢ï¼‰
let editing = false;      // æ˜¯å¦å¤„äºç¼–è¾‘æ€
let openedKey = null;     // å½“å‰æ‰“å¼€çš„å¯¹è±¡ keyï¼ˆåªè¯»æ€ï¼‰
let openedName = null;

function setAuthUI(uid, email){
  currentUID = uid; currentEmail = email;
  ui.accountEmail.textContent = email || "ï¼ˆæœªå–åˆ°é‚®ç®±ï¼‰";
  ui.accountUid.textContent = uid ? ("UID: " + uid) : "";
  ui.btnLogout.classList.toggle("hidden", !uid);
  ui.btnOpenAuth.classList.toggle("hidden", !!uid);
  ui.btnToggleEdit.classList.add("hidden");
  if(uid){ refreshList().catch(console.error); }
}

function enterReadMode(name, key, content){
  openedKey = key; openedName = name;
  editing = false;
  ui.noteTitle.value = name? name.replace(/\.txt$/i,"") : (ui.noteTitle.value||"");
  ui.noteContent.value = content || "";
  ui.noteContent.readOnly = true;
  ui.fileHint.textContent = key ? ("å½“å‰æ–‡ä»¶ï¼š" + name) : "";
  ui.btnToggleEdit.textContent = "ç¼–è¾‘";
  ui.btnToggleEdit.classList.toggle("hidden", !key);
  ui.emptyHint.classList.add("hidden");
  ui.saveState.textContent = "";
}

function enterEditMode(newDoc=false){
  editing = true;
  ui.noteContent.readOnly = false;
  ui.btnToggleEdit.textContent = "ä¿å­˜";
  ui.btnToggleEdit.classList.remove("hidden");
  if(newDoc){
    openedKey = null; openedName = null;
    ui.fileHint.textContent = "ï¼ˆæ–°å»ºæ–‡æ¡£ï¼Œä¿å­˜åè‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶åï¼‰";
    ui.emptyHint.classList.add("hidden");
  }
}

function clearEditor(){
  openedKey = null; openedName = null;
  ui.noteTitle.value = "";
  ui.noteContent.value = "";
  ui.fileHint.textContent = "";
  ui.btnToggleEdit.classList.add("hidden");
  ui.emptyHint.classList.remove("hidden");
  ui.saveState.textContent = "";
}

/* ========= 3) ç™»å½•ä¸æ³¨å†Œ ========= */
ui.btnOpenAuth.onclick = ()=> ui.authModal.classList.remove("hidden");
ui.btnCloseAuth.onclick = ()=> ui.authModal.classList.add("hidden");

(async ()=>{
  try{
    const st = await auth.getLoginState();
    if(st && st.user){ setAuthUI(st.user.uid, st.user.email); }
    else setAuthUI(null, null);
  }catch(e){ console.warn("getLoginState error", e); setAuthUI(null, null); }
})();

ui.btnSendCode.onclick = async ()=>{
  const email = ui.email.value.trim();
  if(!email) return alert("è¯·è¾“å…¥é‚®ç®±");
  ui.authState.textContent = "æ­£åœ¨å‘é€éªŒè¯ç â€¦";
  try{
    const v = await auth.getVerification({ email });
    ui.email.dataset.verification_id = v.verification_id;
    ui.authState.textContent = "éªŒè¯ç å·²å‘é€ï¼ˆ10åˆ†é’Ÿæœ‰æ•ˆï¼‰";
  }catch(e){ ui.authState.textContent = "å‘é€å¤±è´¥ï¼š" + (e?.message || JSON.stringify(e)); }
};

ui.btnSignUp.onclick = async ()=>{
  const email = ui.email.value.trim();
  const password = ui.password.value.trim();
  const code = ui.emailCode.value.trim();
  const verification_id = ui.email.dataset.verification_id;
  if(!email||!password||!code||!verification_id) return alert("è¯·å…ˆè·å–éªŒè¯ç ï¼Œå¹¶å¡«å†™é‚®ç®±/å¯†ç /éªŒè¯ç ");
  ui.authState.textContent = "æ­£åœ¨æ³¨å†Œâ€¦";
  try{
    const verified = await auth.verify({ verification_id, verification_code: code });
    const loginState = await auth.signUp({
      email, verification_code: code, verification_token: verified.verification_token, password
    });
    setAuthUI(loginState.user.uid, loginState.user.email);
    ui.authState.textContent = "æ³¨å†Œå¹¶ç™»å½•æˆåŠŸ";
    ui.authModal.classList.add("hidden");
  }catch(e){ ui.authState.textContent = "æ³¨å†Œå¤±è´¥ï¼š" + (e?.message || JSON.stringify(e)); }
};

ui.btnSignIn.onclick = async ()=>{
  const email = ui.email.value.trim();
  const password = ui.password.value.trim();
  if(!email||!password) return alert("è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ");
  ui.authState.textContent = "æ­£åœ¨ç™»å½•â€¦";
  try{
    const st = await auth.signIn({ username: email, password });
    setAuthUI(st.user.uid, st.user.email);
    ui.authState.textContent = "ç™»å½•æˆåŠŸ";
    ui.authModal.classList.add("hidden");
  }catch(e){ ui.authState.textContent = "ç™»å½•å¤±è´¥ï¼š" + (e?.message || JSON.stringify(e)); }
};

ui.btnLogout.onclick = async ()=>{
  try{ await auth.signOut(); setAuthUI(null,null); clearEditor(); }
  catch(e){ alert("é€€å‡ºå¤±è´¥ï¼š" + (e?.message || e)); }
};

/* ========= 4) STS & COS ========= */
let stsCache = null;
let cos = null;

async function ensureLogin(){
  const s = await auth.getLoginState();
  if(!s || !s.user) throw new Error("å°šæœªç™»å½•");
  return { uid:s.user.uid, email:s.user.email };
}
async function fetchSTS(uid){
  const res = await fetch(`${STS_URL}?uid=${encodeURIComponent(uid)}`, { headers:{ "x-user-uid": uid } });
  if(!res.ok){ throw new Error("STS è·å–å¤±è´¥ï¼š" + res.status); }
  const data = await res.json();
  if(!data?.credentials?.tmpSecretId || !data?.credentials?.tmpSecretKey || !data?.credentials?.sessionToken)
    throw new Error("STS å“åº”ç¼ºå°‘ credentials");
  if(!data?.bucket || !data?.region) throw new Error("STS å“åº”ç¼ºå°‘ bucket/region");
  return data;
}
async function ensureCOS(){
  const { uid } = await ensureLogin();
  const now = Math.floor(Date.now()/1000);
  const needNew = !stsCache || !stsCache.expiredTime || (now + 60) >= Number(stsCache.expiredTime);
  if(needNew){
    stsCache = await fetchSTS(uid);
    cos = new COS({
      getAuthorization: (_, cb) => {
        const c = stsCache.credentials;
        cb({ TmpSecretId:c.tmpSecretId, TmpSecretKey:c.tmpSecretKey, SecurityToken:c.sessionToken,
             StartTime:Number(stsCache.startTime), ExpiredTime:Number(stsCache.expiredTime) });
      }
    });
  }
  return { cos, bucket: stsCache.bucket, region: stsCache.region, uid };
}

/* ========= 5) åˆ—è¡¨ / æ‰“å¼€ / ä¸‹è½½ / åˆ é™¤ ========= */
function pad2(n){return n<10?("0"+n):""+n}
function ts(){
  const d=new Date();return d.getFullYear()+pad2(d.getMonth()+1)+pad2(d.getDate())+"_"+pad2(d.getHours())+pad2(d.getMinutes())+pad2(d.getSeconds());
}

async function refreshList(){
  ui.listState.textContent = "åŠ è½½ä¸­â€¦";
  ui.noteList.innerHTML = "";
  try{
    const { cos, bucket, region, uid } = await ensureCOS();
    const prefix = `${uid}/`;
    const list = await new Promise((resolve,reject)=>{
      cos.getBucket({ Bucket:bucket, Region:region, Prefix:prefix, MaxKeys:1000 },
        (e,d)=> e?reject(e):resolve(d));
    });
    const objs = (list?.Contents||[]).filter(o=>o.Key.endsWith(".txt"))
                  .sort((a,b)=> new Date(b.LastModified)-new Date(a.LastModified));
    latestObjects = objs;
    renderList(objs, bucket, region, cos);
    ui.listState.textContent = `å…± ${objs.length} æ¡`;
  }catch(e){
    ui.listState.textContent = "åŠ è½½å¤±è´¥ï¼š" + (e?.message || JSON.stringify(e));
  }
}

function renderList(objs, bucket, region, cos){
  ui.noteList.innerHTML = "";
  if(objs.length===0){
    ui.noteList.innerHTML = "<li class='muted' style='padding:12px'>æš‚æ— ç¬”è®°</li>";
    return;
  }
  for(const obj of objs){
    const name = obj.Key.split("/").pop();
    const li = document.createElement("li");

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `<span class="name mono">${name}</span>
                      <span class="time">${new Date(obj.LastModified).toLocaleString()}</span>`;

    const ops = document.createElement("div"); ops.className="ops";

    const btnOpen = document.createElement("button");
    btnOpen.className = "btn secondary"; btnOpen.textContent = "æ‰“å¼€";
    btnOpen.onclick = () => openObject(obj, bucket, region, cos);

    const btnDown = document.createElement("button");
    btnDown.className = "btn secondary"; btnDown.textContent = "ä¸‹è½½";
    btnDown.onclick = async ()=>{
      const url = await new Promise((resolve,reject)=>{
        cos.getObjectUrl({ Bucket:bucket, Region:region, Key:obj.Key, Sign:true },
          (e,r)=> e?reject(e):resolve(r.Url));
      });
      window.open(url, "_blank");
    };

    const btnDel = document.createElement("button");
    btnDel.className = "btn danger"; btnDel.textContent="åˆ é™¤";
    btnDel.onclick = async ()=>{
      if(!confirm(`ç¡®è®¤åˆ é™¤ ${name} å—ï¼Ÿ`)) return;
      try{
        await new Promise((resolve,reject)=>{
          cos.deleteObject({ Bucket:bucket, Region:region, Key:obj.Key },
            (e,r)=> e?reject(e):resolve(r));
        });
        if(openedKey===obj.Key) clearEditor();
        refreshList();
      }catch(e){ alert("åˆ é™¤å¤±è´¥ï¼š" + (e?.message || JSON.stringify(e))); }
    };

    ops.appendChild(btnOpen); ops.appendChild(btnDown); ops.appendChild(btnDel);
    li.appendChild(meta); li.appendChild(ops);
    ui.noteList.appendChild(li);
  }
}

async function openObject(obj, bucket, region, cos){
  try{
    const data = await new Promise((resolve,reject)=>{
      cos.getObject({ Bucket:bucket, Region:region, Key:obj.Key }, (e,r)=> e?reject(e):resolve(r));
    });
    const body = data && (data.Body || data.BodyBuffer || data.Content) || "";
    const text = typeof body === "string" ? body
               : body instanceof Blob ? await body.text()
               : new TextDecoder("utf-8").decode(body);
    const name = obj.Key.split("/").pop();
    enterReadMode(name, obj.Key, text);
  }catch(e){ alert("è¯»å–å¤±è´¥ï¼š" + (e?.message || JSON.stringify(e))); }
}

/* ========= 6) æœç´¢ / æ¸…ç©º ========= */
ui.btnSearch.onclick = ()=>{
  const kw = ui.searchInput.value.trim().toLowerCase();
  const filtered = !kw ? latestObjects :
      latestObjects.filter(o => o.Key.split("/").pop().toLowerCase().includes(kw));
  if(!stsCache) return;
  renderList(filtered, stsCache.bucket, stsCache.region, cos);
  ui.listState.textContent = `è¿‡æ»¤å ${filtered.length} æ¡`;
};
ui.btnClearSearch.onclick = ()=>{
  ui.searchInput.value = "";
  if(stsCache) renderList(latestObjects, stsCache.bucket, stsCache.region, cos);
  ui.listState.textContent = `å…± ${latestObjects.length} æ¡`;
};

/* ========= 7) æ–°å»º / ç¼–è¾‘-ä¿å­˜ ========= */
ui.btnNew.onclick = ()=>{
  ui.noteTitle.value = "";
  ui.noteContent.value = "";
  enterEditMode(true);
};

ui.btnToggleEdit.onclick = async ()=>{
  if(!editing){ enterEditMode(false); return; }
  ui.saveState.textContent = "æ­£åœ¨ä¿å­˜åˆ° COSâ€¦";
  try{
    const { cos, bucket, region, uid } = await ensureCOS();
    let key = openedKey;
    if(!key){
      const safeTitle = (ui.noteTitle.value || "æœªå‘½å").replace(/[\\/:*?"<>|\s]+/g,"_").slice(0,60);
      key = `${uid}/${ts()}_${safeTitle}.txt`;
    }
    const blob = new Blob([ui.noteContent.value || ""], { type:"text/plain;charset=utf-8" });
    await new Promise((resolve,reject)=>{
      cos.putObject({ Bucket:bucket, Region:region, Key:key, Body:blob },
        (e,d)=> e?reject(e):resolve(d));
    });
    const name = key.split("/").pop();
    enterReadMode(name, key, ui.noteContent.value || "");
    ui.saveState.textContent = `å·²ä¿å­˜ï¼šcos://${bucket}/${key}`;
    refreshList();
  }catch(e){
    ui.saveState.textContent = "ä¿å­˜å¤±è´¥ï¼š" + (e?.message || JSON.stringify(e));
  }
};
ui.btnRefresh.onclick = () => refreshList();

/* ========= 8) å›¾ç‰‡ä¸Šä¼ ï¼šç²˜è´´ & æ‹–æ‹½ ========= */
/** å…³é”®ç‚¹ï¼š
 * - pasteï¼šè¯»å– clipboardData.items é‡Œçš„ image/* Blobï¼ˆéœ€ HTTPSã€ç”¨æˆ·è§¦å‘ï¼‰ã€‚å‚è€ƒ MDN Clipboard APIã€‚:contentReference[oaicite:1]{index=1}
 * - drag&dropï¼šé˜»æ­¢é»˜è®¤æ‰“å¼€æ–‡ä»¶è¡Œä¸ºï¼Œä» dataTransfer.files å– File åˆ—è¡¨ã€‚å‚è€ƒ MDN Drag&Dropã€‚:contentReference[oaicite:2]{index=2}
 * - ä¸Šä¼ ï¼šä¼˜å…ˆä½¿ç”¨ SDK çš„ uploadFileï¼ˆè‡ªåŠ¨åˆ†å—/æ–­ç‚¹ç»­ä¼ ï¼‰ï¼Œå°æ–‡ä»¶ä¹Ÿå¯ putObjectã€‚:contentReference[oaicite:3]{index=3}
 * - ç»“æœï¼šè°ƒç”¨ getObjectUrl(Sign:true) å–å¸¦ç­¾åä¸´æ—¶é“¾æ¥ï¼Œæ’å…¥åˆ°ç¼–è¾‘æ¡†å…‰æ ‡å¤„ä¸º `![]()`ã€‚
 */

const IMAGE_MAX = 20 * 1024 * 1024; // 20MB ä¸Šé™ï¼Œå¯æŒ‰éœ€è°ƒæ•´
const ACCEPT = ["image/png","image/jpeg","image/gif","image/webp","image/svg+xml"];

function setDragVisual(on){
  ui.editorCard.classList.toggle("dragover", !!on);
}

ui.noteContent.addEventListener("paste", async (e)=>{
  if(!currentUID) return; // æœªç™»å½•ä¸å¤„ç†
  const items = e.clipboardData && e.clipboardData.items ? Array.from(e.clipboardData.items) : [];
  const imgs = items.filter(it => it.kind === "file" && it.type && it.type.startsWith("image/"));
  if(!imgs.length) return;
  e.preventDefault();
  const files = await Promise.all(imgs.map(it => it.getAsFile()));
  handleFiles(files.filter(Boolean));
});

["dragenter","dragover"].forEach(ev=>{
  ui.editorCard.addEventListener(ev, (e)=>{ e.preventDefault(); setDragVisual(true); });
});
["dragleave","drop"].forEach(ev=>{
  ui.editorCard.addEventListener(ev, (e)=>{ e.preventDefault(); if(ev==="drop") onDrop(e); setDragVisual(false); });
});
async function onDrop(e){
  if(!currentUID) return;
  const files = Array.from(e.dataTransfer?.files || []).filter(f => f && f.type?.startsWith("image/"));
  if(files.length) await handleFiles(files);
}

async function handleFiles(files){
  if(!files || !files.length) return;
  enterEditMode(openedKey==null); // ç¡®ä¿å¯ç¼–è¾‘
  for(const f of files){
    if(!ACCEPT.includes(f.type)) { ui.saveState.textContent = `è·³è¿‡ä¸æ”¯æŒçš„ç±»å‹ï¼š${f.type}`; continue; }
    if(f.size > IMAGE_MAX){ ui.saveState.textContent = `æ–‡ä»¶è¿‡å¤§ï¼ˆ>${(IMAGE_MAX/1024/1024)|0}MBï¼‰ï¼š${f.name}`; continue; }
    try{
      const url = await uploadImageToCOS(f);
      insertAtCursor(ui.noteContent, `\n![](${url})\n`);
      ui.saveState.textContent = `å›¾ç‰‡å·²ä¸Šä¼ å¹¶æ’å…¥ï¼š${f.name}`;
    }catch(err){
      ui.saveState.textContent = `ä¸Šä¼ å¤±è´¥ï¼š${err?.message || err}`;
    }
  }
}

/** ä¸Šä¼ æ–‡ä»¶åˆ° COSï¼Œè¿”å›å¯è®¿é—®çš„ä¸´æ—¶ç­¾å URL */
async function uploadImageToCOS(file){
  const { cos, bucket, region, uid } = await ensureCOS();
  const ext = (file.name.split(".").pop() || "").toLowerCase();
  const safeBase = (ui.noteTitle.value || "æœªå‘½å").replace(/[\\/:*?"<>|\s]+/g,"_").slice(0,40);
  const key = `${uid}/assets/${new Date().getFullYear()}/${pad2(new Date().getMonth()+1)}/${ts()}_${safeBase}.${ext||"png"}`;

  // ä½¿ç”¨é«˜çº§æ¥å£ï¼ˆè‡ªåŠ¨åˆ†ç‰‡/æ–­ç‚¹ç»­ä¼ /è¿›åº¦å›è°ƒï¼‰
  await new Promise((resolve,reject)=>{
    cos.uploadFile({
      Bucket: bucket, Region: region, Key: key, Body: file, SliceSize: 1024*1024,
      onProgress: p => { ui.saveState.textContent = `ä¸Šä¼ ä¸­ ${file.name} ${(p.percent*100).toFixed(1)}%`; }
    }, (err, data) => err ? reject(err) : resolve(data));
  });

  // å–ç­¾å URLï¼ˆé»˜è®¤å¸¦æœ‰æ•ˆæœŸï¼‰ï¼Œç”¨äºåœ¨ç¬”è®°ä¸­ç›´æ¥æ˜¾ç¤º
  const signed = await new Promise((resolve,reject)=>{
    cos.getObjectUrl({ Bucket:bucket, Region:region, Key:key, Sign:true }, (e,r)=> e?reject(e):resolve(r));
  });
  return signed.Url; // è¿”å›ä¸´æ—¶å¯è®¿é—®é“¾æ¥
}

/** åœ¨ textarea å…‰æ ‡å¤„æ’å…¥æ–‡æœ¬ */
function insertAtCursor(el, text){
  const start = el.selectionStart ?? el.value.length;
  const end   = el.selectionEnd ?? el.value.length;
  const before = el.value.slice(0, start);
  const after  = el.value.slice(end);
  el.value = before + text + after;
  const pos = start + text.length;
  el.selectionStart = el.selectionEnd = pos;
  el.focus();
}
</script>
</body>
</html>
