<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的云笔记</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

    <script src="https://web.sdk.qcloud.com/js/sdk/1.3.0/cloudbase.full.js"></script>
    <script src="https://unpkg.com/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>

    <style>
        /* Custom Styles */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .hidden { display: none !important; }

        /* Quill Editor Height */
        #richtext-editor-view .ql-container {
            height: calc(100vh - 12rem);
            font-size: 16px;
        }

        /* File Tree Scrollbar */
        #file-tree {
            scrollbar-width: thin;
            scrollbar-color: #a0aec0 #e2e8f0;
        }
        #file-tree::-webkit-scrollbar { width: 6px; }
        #file-tree::-webkit-scrollbar-track { background: #e2e8f0; }
        #file-tree::-webkit-scrollbar-thumb { background-color: #a0aec0; border-radius: 10px; border: 3px solid #e2e8f0; }

        /* PDF Viewer Canvas */
        #pdf-canvas {
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* Context Menu */
        #context-menu {
            position: fixed;
            z-index: 1000;
            width: 160px;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            padding: 0.5rem 0;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="auth-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
            <div class="flex border-b">
                <button id="show-login-btn" class="flex-1 py-2 text-center font-semibold text-indigo-600 border-b-2 border-indigo-600">登录</button>
                <button id="show-register-btn" class="flex-1 py-2 text-center font-semibold text-gray-500">注册</button>
            </div>
            <form id="login-form" class="mt-6">
                <div class="mb-4">
                    <label for="login-email" class="block text-gray-700 text-sm font-bold mb-2">邮箱</label>
                    <input type="email" id="login-email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2">密码</label>
                    <input type="password" id="login-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">登录</button>
            </form>
            <form id="register-form" class="mt-6 hidden">
                <div class="mb-4">
                    <label for="register-email" class="block text-gray-700 text-sm font-bold mb-2">邮箱</label>
                    <input type="email" id="register-email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-6">
                    <label for="register-password" class="block text-gray-700 text-sm font-bold mb-2">密码</label>
                    <input type="password" id="register-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">注册</button>
            </form>
        </div>
    </div>

    <div id="main-app-view" class="hidden h-screen flex">
        <aside id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col transition-all duration-300">
            <div class="p-4 border-b border-gray-700 flex items-center">
                <div id="user-avatar" class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-xl mr-3"></div>
                <div class="flex-1">
                    <div id="user-email" class="text-sm font-semibold truncate"></div>
                    <button id="logout-btn" class="text-xs text-red-400 hover:text-red-300">退出登录</button>
                </div>
            </div>
            <div class="p-4 grid grid-cols-2 gap-2">
                <button id="new-folder-btn" class="flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded p-2 text-sm"><i data-feather="folder-plus" class="w-4 h-4 mr-1"></i>新建文件夹</button>
                <button id="new-article-btn" class="flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded p-2 text-sm"><i data-feather="file-plus" class="w-4 h-4 mr-1"></i>新建文章</button>
            </div>
            <div id="file-tree" class="flex-1 overflow-y-auto p-2">
                </div>
            <div class="p-2 border-t border-gray-700">
                <details>
                    <summary class="cursor-pointer p-2 rounded hover:bg-gray-700 font-semibold text-sm">数据管理</summary>
                    <div class="mt-2 space-y-2 pl-2">
                        <button id="import-pdf-btn-wrapper" class="w-full text-left flex items-center bg-gray-700 hover:bg-gray-600 rounded p-2 text-sm">
                            <i data-feather="upload-cloud" class="w-4 h-4 mr-2"></i>导入PDF
                            <input type="file" id="import-pdf-input" class="hidden" accept=".pdf">
                        </button>
                        <button id="import-backup-btn-wrapper" class="w-full text-left flex items-center bg-gray-700 hover:bg-gray-600 rounded p-2 text-sm">
                           <i data-feather="database" class="w-4 h-4 mr-2"></i>导入备份
                           <input type="file" id="import-backup-input" class="hidden" accept=".json">
                        </button>
                        <button id="export-backup-btn" class="w-full text-left flex items-center bg-gray-700 hover:bg-gray-600 rounded p-2 text-sm"><i data-feather="download" class="w-4 h-4 mr-2"></i>导出备份</button>
                    </div>
                </details>
            </div>
        </aside>

        <main id="main-content" class="flex-1 flex flex-col">
            <header class="flex items-center justify-between bg-white border-b h-16 p-4 shadow-sm">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="mr-4 lg:hidden"><i data-feather="menu" class="w-6 h-6"></i></button>
                    <h1 id="article-title-header" class="text-xl font-semibold text-gray-800 truncate"></h1>
                </div>
                <div id="pdf-controls" class="hidden items-center space-x-4">
                    <button id="pdf-prev" class="p-1 rounded-full hover:bg-gray-200"><i data-feather="chevron-left" class="w-5 h-5"></i></button>
                    <span id="pdf-page-info"></span>
                    <button id="pdf-next" class="p-1 rounded-full hover:bg-gray-200"><i data-feather="chevron-right" class="w-5 h-5"></i></button>
                </div>
                <div id="article-actions" class="hidden items-center space-x-2">
                    <button id="edit-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded text-sm flex items-center"><i data-feather="edit" class="w-4 h-4 mr-1"></i>编辑</button>
                    <button id="save-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded text-sm flex items-center"><i data-feather="save" class="w-4 h-4 mr-1"></i>保存</button>
                    <button id="export-txt-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded text-sm" title="导出为 TXT"><i data-feather="file-text" class="w-4 h-4"></i></button>
                    <button id="export-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded text-sm" title="导出为 PDF"><i data-feather="file" class="w-4 h-4"></i></button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50">
                <div id="welcome-view" class="flex flex-col items-center justify-center h-full text-center text-gray-500">
                    <i data-feather="book-open" class="w-16 h-16 mb-4"></i>
                    <h2 class="text-2xl font-semibold">欢迎使用云笔记</h2>
                    <p class="mt-2">从左侧选择一篇笔记开始阅读，或新建一篇笔记。</p>
                </div>

                <div id="article-view" class="hidden h-full">
                    <div id="richtext-editor-view" class="hidden bg-white rounded-lg shadow-lg">
                        <div id="quill-toolbar">
                            </div>
                        <div id="quill-editor"></div>
                    </div>

                    <div id="pdf-reader-view" class="hidden h-full flex justify-center">
                        <canvas id="pdf-canvas"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed top-5 right-5 p-4 rounded-md shadow-lg text-white transition-transform translate-x-full duration-300">
        <span id="toast-message"></span>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

    <div id="creation-rename-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-6 w-full max-w-sm z-50 hidden">
        <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
        <input type="text" id="modal-input" class="border rounded w-full p-2 mb-4">
        <div id="modal-folder-select-wrapper" class="mb-4">
            <label for="modal-folder-select" class="text-sm">选择文件夹:</label>
            <select id="modal-folder-select" class="border rounded w-full p-2 mt-1"></select>
        </div>
        <div class="flex justify-end space-x-2">
            <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 rounded">取消</button>
            <button id="modal-confirm-btn" class="px-4 py-2 bg-indigo-600 text-white rounded">确认</button>
        </div>
    </div>

    <div id="move-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-6 w-full max-w-sm z-50 hidden">
        <h3 class="text-lg font-bold mb-4">移动文章到...</h3>
        <select id="move-folder-select" class="border rounded w-full p-2 mb-4"></select>
        <div class="flex justify-end space-x-2">
            <button id="move-cancel-btn" class="px-4 py-2 bg-gray-200 rounded">取消</button>
            <button id="move-confirm-btn" class="px-4 py-2 bg-indigo-600 text-white rounded">移动</button>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-6 w-full max-w-sm z-50 hidden">
        <h3 id="confirm-title" class="text-lg font-bold mb-2"></h3>
        <p id="confirm-message" class="text-gray-600 mb-4"></p>
        <div class="flex justify-end space-x-2">
            <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 rounded">取消</button>
            <button id="confirm-ok-btn" class="px-4 py-2 bg-red-600 text-white rounded">确认</button>
        </div>
    </div>

    <div id="context-menu" class="hidden">
        </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // =================================================================
        // IV. 配置 (Configuration)
        // =================================================================
        const TCB_CONFIG = {
            env: 'molijun-0gtahyghc6271173'
        };
        const COS_CONFIG = {
            bucket: 'notes-1317231591',
            region: 'ap-guangzhou'
        };
        const STS_API_URL = 'https://molijun-0gtahyghc6271173-1317231591.ap-shanghai.app.tcloudbase.com/api/sts';

        // =================================================================
        // V. 应用状态 (App State)
        // =================================================================
        let appState = {
            user: null,
            folders: [],
            articles: [],
            currentArticle: null,
            editingArticle: {
                id: null,
                lastKnownVersion: null, // 用于冲突检测
            },
            localDrafts: {}, // { articleId: { content: '...', timestamp: ... } }
            pdfDoc: null,
            pdfPageNum: 1,
            isEditorDirty: false, // 编辑器内容是否有未保存的修改
        };


        // =================================================================
        // VI. DOM 元素引用
        // =================================================================
        const DOMElements = {
            authView: document.getElementById('auth-view'),
            mainAppView: document.getElementById('main-app-view'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            showLoginBtn: document.getElementById('show-login-btn'),
            showRegisterBtn: document.getElementById('show-register-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            userAvatar: document.getElementById('user-avatar'),
            userEmail: document.getElementById('user-email'),
            sidebar: document.getElementById('sidebar'),
            sidebarToggle: document.getElementById('sidebar-toggle'),
            fileTree: document.getElementById('file-tree'),
            newFolderBtn: document.getElementById('new-folder-btn'),
            newArticleBtn: document.getElementById('new-article-btn'),
            articleTitleHeader: document.getElementById('article-title-header'),
            welcomeView: document.getElementById('welcome-view'),
            articleView: document.getElementById('article-view'),
            richtextEditorView: document.getElementById('richtext-editor-view'),
            pdfReaderView: document.getElementById('pdf-reader-view'),
            pdfControls: document.getElementById('pdf-controls'),
            pdfPrev: document.getElementById('pdf-prev'),
            pdfNext: document.getElementById('pdf-next'),
            pdfPageInfo: document.getElementById('pdf-page-info'),
            pdfCanvas: document.getElementById('pdf-canvas'),
            articleActions: document.getElementById('article-actions'),
            editBtn: document.getElementById('edit-btn'),
            saveBtn: document.getElementById('save-btn'),
            exportTxtBtn: document.getElementById('export-txt-btn'),
            exportPdfBtn: document.getElementById('export-pdf-btn'),
            importPdfWrapper: document.getElementById('import-pdf-btn-wrapper'),
            importPdfInput: document.getElementById('import-pdf-input'),
            importBackupWrapper: document.getElementById('import-backup-btn-wrapper'),
            importBackupInput: document.getElementById('import-backup-input'),
            exportBackupBtn: document.getElementById('export-backup-btn'),
            // Modals
            modalOverlay: document.getElementById('modal-overlay'),
            creationRenameModal: document.getElementById('creation-rename-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalInput: document.getElementById('modal-input'),
            modalFolderSelectWrapper: document.getElementById('modal-folder-select-wrapper'),
            modalFolderSelect: document.getElementById('modal-folder-select'),
            modalCancelBtn: document.getElementById('modal-cancel-btn'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            moveModal: document.getElementById('move-modal'),
            moveFolderSelect: document.getElementById('move-folder-select'),
            moveCancelBtn: document.getElementById('move-cancel-btn'),
            moveConfirmBtn: document.getElementById('move-confirm-btn'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmTitle: document.getElementById('confirm-title'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
            confirmOkBtn: document.getElementById('confirm-ok-btn'),
            // Toast
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            // Context Menu
            contextMenu: document.getElementById('context-menu'),
        };


        // =================================================================
        // VII. 初始化 (Initialization)
        // =================================================================
        
        // --- 7.1 初始化腾讯云 CloudBase ---
        const tcb = cloudbase.init(TCB_CONFIG);
        const auth = tcb.auth();
        const db = tcb.database();
        const _ = db.command;

        // --- 7.2 初始化 Quill 编辑器 ---
        const quillToolbarOptions = [
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            ['blockquote', 'code-block'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'script': 'sub'}, { 'script': 'super' }],
            [{ 'indent': '-1'}, { 'indent': '+1' }],
            [{ 'direction': 'rtl' }],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'font': [] }],
            [{ 'align': [] }],
            ['link', 'image'],
            ['clean']
        ];
        const quill = new Quill('#quill-editor', {
            modules: {
                toolbar: {
                    container: quillToolbarOptions,
                    handlers: {
                        'image': imageHandler
                    }
                }
            },
            theme: 'snow'
        });

        // --- 7.3 初始化 COS SDK 实例 ---
        const cos = new COS({
            getAuthorization: async (options, callback) => {
                try {
                    const response = await fetch(STS_API_URL);
                    if (!response.ok) throw new Error('获取STS凭证失败');
                    const data = await response.json();
                    callback({
                        TmpSecretId: data.credentials.tmpSecretId,
                        TmpSecretKey: data.credentials.tmpSecretKey,
                        SecurityToken: data.credentials.sessionToken,
                        StartTime: data.startTime,
                        ExpiredTime: data.expiredTime,
                    });
                } catch (error) {
                    console.error('STS Error:', error);
                    showToast('获取上传凭证失败', 'error');
                }
            }
        });


        // --- 7.4 主应用启动逻辑 ---
        async function main() {
            feather.replace(); // 渲染图标
            setupEventListeners(); // 绑定所有事件
            checkAuthState(); // 检查登录状态
            loadLocalDrafts(); // 加载本地草稿
        }

        main();


        // =================================================================
        // VIII. 用户认证 (Authentication)
        // =================================================================
        async function checkAuthState() {
            try {
                const loginState = await auth.getLoginState();
                if (loginState) {
                    appState.user = { uid: loginState.user.uid, email: loginState.user.email };
                    await initializeMainApp();
                } else {
                    showAuthView();
                }
            } catch (e) {
                console.error("Auth state check failed:", e);
                showAuthView();
            }
        }

        async function handleLogin(email, password) {
            try {
                await auth.signInWithEmailAndPassword(email, password);
                const loginState = await auth.getLoginState();
                appState.user = { uid: loginState.user.uid, email: loginState.user.email };
                await initializeMainApp();
            } catch (e) {
                showToast('登录失败，请检查邮箱和密码', 'error');
                console.error(e);
            }
        }

        async function handleRegister(email, password) {
            try {
                await auth.signUpWithEmailAndPassword(email, password);
                showToast('注册成功，请登录', 'success');
                toggleAuthForms('login');
            } catch (e) {
                if (e.code === 'auth/email-already-in-use') {
                    showToast('该邮箱已被注册', 'error');
                } else {
                    showToast('注册失败', 'error');
                }
                console.error(e);
            }
        }

        async function handleLogout() {
            await auth.signOut();
            appState.user = null;
            appState.folders = [];
            appState.articles = [];
            appState.currentArticle = null;
            showAuthView();
        }

        async function initializeMainApp() {
            showMainAppView();
            updateUserInfoUI();
            await fetchAllData();
        }

        // =================================================================
        // IX. API (数据库与云存储交互)
        // =================================================================

        // --- 9.1 数据获取 ---
        async function fetchAllData() {
            try {
                const [foldersRes, articlesRes] = await Promise.all([
                    db.collection('folders').where({ _openid: appState.user.uid }).get(),
                    db.collection('articles').where({ _openid: appState.user.uid }).orderBy('updated_at', 'desc').get()
                ]);
                appState.folders = foldersRes.data;
                appState.articles = articlesRes.data;
                renderFileTree();
            } catch (error) {
                console.error('Error fetching data:', error);
                showToast('数据加载失败', 'error');
            }
        }
        
        // --- 9.2 文件夹操作 ---
        async function createFolder(name) {
            try {
                await db.collection('folders').add({
                    name: name,
                    created_at: new Date(),
                });
                showToast('文件夹创建成功', 'success');
                await fetchAllData();
            } catch (e) {
                showToast('创建失败', 'error');
                console.error(e);
            }
        }

        async function renameFolder(folderId, newName) {
            try {
                await db.collection('folders').doc(folderId).update({ name: newName });
                showToast('重命名成功', 'success');
                await fetchAllData();
            } catch (e) {
                showToast('重命名失败', 'error');
                console.error(e);
            }
        }

        async function deleteFolder(folderId) {
            try {
                // NoSQL 不支持级联删除，需要应用层实现
                // 1. 删除文件夹下的所有文章
                await db.collection('articles').where({ folder_id: folderId }).remove();
                
                // 2. 删除文件夹本身
                await db.collection('folders').doc(folderId).remove();
                
                showToast('文件夹及其内容已删除', 'success');
                // 如果当前打开的文章属于被删除的文件夹，则关闭
                if (appState.currentArticle && appState.currentArticle.folder_id === folderId) {
                    showWelcomeView();
                }
                await fetchAllData();
            } catch (e) {
                showToast('删除失败', 'error');
                console.error(e);
            }
        }

        // --- 9.3 文章操作 ---
        async function createArticle(title, folderId, type = 'text', content = '') {
            try {
                const now = new Date();
                const result = await db.collection('articles').add({
                    title,
                    folder_id: folderId || null,
                    type,
                    content,
                    created_at: now,
                    updated_at: now
                });
                showToast('文章创建成功', 'success');
                await fetchAllData();
                selectArticle(result.id); // 创建后立即选中
            } catch (e) {
                showToast('创建失败', 'error');
                console.error(e);
            }
        }
        
        async function updateArticle(articleId, title, content) {
            // 冲突检测
            try {
                 const latestArticleRes = await db.collection('articles').doc(articleId).get();
                 const latestArticle = latestArticleRes.data[0];
                 const serverTimestamp = new Date(latestArticle.updated_at).getTime();
                 
                 if (appState.editingArticle.lastKnownVersion && serverTimestamp > appState.editingArticle.lastKnownVersion) {
                    navigator.clipboard.writeText(JSON.stringify(quill.getContents()));
                    showToast('内容冲突！云端版本较新，您的草稿已复制到剪贴板。', 'warning', 10000);
                    loadArticleContent(latestArticle); // 加载最新内容
                    return;
                 }

                await db.collection('articles').doc(articleId).update({
                    title,
                    content,
                    updated_at: new Date()
                });
                showToast('保存成功', 'success');
                appState.isEditorDirty = false;
                deleteLocalDraft(articleId);
                await fetchAllData();
                document.querySelector(`[data-id='${articleId}'] .draft-indicator`)?.classList.add('hidden');
                document.querySelector(`#save-btn`)?.classList.remove('bg-green-500', 'hover:bg-green-600');
            } catch (e) {
                showToast('保存失败', 'error');
                console.error(e);
            }
        }

        async function deleteArticle(articleId) {
             try {
                await db.collection('articles').doc(articleId).remove();
                showToast('文章已删除', 'success');
                if(appState.currentArticle && appState.currentArticle._id === articleId){
                    showWelcomeView();
                }
                deleteLocalDraft(articleId);
                await fetchAllData();
            } catch (e) {
                showToast('删除失败', 'error');
                console.error(e);
            }
        }
        
        async function renameArticle(articleId, newTitle) {
            try {
                await db.collection('articles').doc(articleId).update({ title: newTitle, updated_at: new Date() });
                showToast('重命名成功', 'success');
                if (appState.currentArticle && appState.currentArticle._id === articleId) {
                    DOMElements.articleTitleHeader.textContent = newTitle;
                }
                await fetchAllData();
            } catch (e) {
                showToast('重命名失败', 'error');
                console.error(e);
            }
        }

        async function moveArticle(articleId, newFolderId) {
            try {
                await db.collection('articles').doc(articleId).update({ folder_id: newFolderId || null });
                showToast('移动成功', 'success');
                await fetchAllData();
            } catch (e) {
                showToast('移动失败', 'error');
                console.error(e);
            }
        }

        // --- 9.4 文件上传 (COS) ---
        function uploadFileToCOS(file, type) {
            return new Promise((resolve, reject) => {
                const fileKey = `${type}/${appState.user.uid}/${Date.now()}-${file.name}`;
                cos.putObject({
                    Bucket: COS_CONFIG.bucket,
                    Region: COS_CONFIG.region,
                    Key: fileKey,
                    Body: file,
                    onProgress: (progressData) => {
                        console.log('Uploading:', JSON.stringify(progressData));
                    }
                }, (err, data) => {
                    if (err) {
                        console.error('COS Upload Error:', err);
                        reject(err);
                    } else {
                        // 返回 HTTPS 访问链接
                        resolve('https://' + data.Location);
                    }
                });
            });
        }
        
        async function handlePDFImport(file) {
            showToast('正在上传PDF...', 'info');
            try {
                const url = await uploadFileToCOS(file, 'pdfs');
                await createArticle(file.name, null, 'pdf', url);
            } catch (error) {
                showToast('PDF上传失败', 'error');
            }
        }

        // --- 9.5 数据导入/导出 ---
        async function handleExportBackup() {
            const backupData = {
                folders: appState.folders,
                articles: appState.articles,
                exportedAt: new Date().toISOString()
            };
            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `notes-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('备份已导出', 'success');
        }

        async function handleImportBackup(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.folders || !data.articles) {
                        throw new Error('无效的备份文件格式');
                    }
                    
                    showConfirmModal(
                        '确认导入备份？',
                        '此操作将首先清空您当前所有的云端笔记和文件夹，然后导入备份文件中的数据。此过程不可逆！',
                        async () => {
                            showToast('正在清空云端数据...', 'info');
                            // 1. 清空数据
                            await Promise.all([
                                db.collection('folders').where({ _openid: appState.user.uid }).remove(),
                                db.collection('articles').where({ _openid: appState.user.uid }).remove()
                            ]);

                            showToast('正在导入数据...', 'info');
                            // 2. 导入数据
                            // 导入文件夹
                            if (data.folders.length > 0) {
                                await db.collection('folders').add(data.folders.map(f => ({ name: f.name, created_at: new Date(f.created_at) })));
                            }
                            // 导入文章
                            if (data.articles.length > 0) {
                                await db.collection('articles').add(data.articles.map(a => ({
                                    title: a.title,
                                    content: a.content,
                                    folder_id: a.folder_id,
                                    type: a.type,
                                    created_at: new Date(a.created_at),
                                    updated_at: new Date(a.updated_at)
                                })));
                            }

                            showToast('数据导入成功！', 'success');
                            await fetchAllData();
                        }
                    );

                } catch (error) {
                    showToast('导入失败，文件解析错误', 'error');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        // =================================================================
        // X. UI 渲染与更新
        // =================================================================

        // --- 10.1 视图切换 ---
        function showAuthView() {
            DOMElements.authView.classList.remove('hidden');
            DOMElements.mainAppView.classList.add('hidden');
        }

        function showMainAppView() {
            DOMElements.authView.classList.add('hidden');
            DOMElements.mainAppView.classList.remove('hidden');
        }

        function toggleAuthForms(formToShow) {
            if (formToShow === 'login') {
                DOMElements.loginForm.classList.remove('hidden');
                DOMElements.registerForm.classList.add('hidden');
                DOMElements.showLoginBtn.classList.add('text-indigo-600', 'border-indigo-600');
                DOMElements.showRegisterBtn.classList.remove('text-indigo-600', 'border-indigo-600');
            } else {
                DOMElements.loginForm.classList.add('hidden');
                DOMElements.registerForm.classList.remove('hidden');
                DOMElements.showLoginBtn.classList.remove('text-indigo-600', 'border-indigo-600');
                DOMElements.showRegisterBtn.classList.add('text-indigo-600', 'border-indigo-600');
            }
        }
        
        function showWelcomeView() {
            appState.currentArticle = null;
            appState.editingArticle.id = null;
            DOMElements.welcomeView.classList.remove('hidden');
            DOMElements.articleView.classList.add('hidden');
            DOMElements.articleTitleHeader.textContent = '';
            DOMElements.articleActions.classList.add('hidden');
            DOMElements.pdfControls.classList.add('hidden');
        }

        function updateUserInfoUI() {
            if (appState.user) {
                DOMElements.userEmail.textContent = appState.user.email;
                DOMElements.userAvatar.textContent = appState.user.email.charAt(0).toUpperCase();
            }
        }

        // --- 10.2 文件树渲染 ---
        function renderFileTree() {
            const tree = DOMElements.fileTree;
            tree.innerHTML = '';

            // 渲染文件夹
            appState.folders.forEach(folder => {
                const articlesInFolder = appState.articles.filter(a => a.folder_id === folder._id);
                const folderEl = document.createElement('div');
                folderEl.innerHTML = `
                    <details class="folder-item" data-id="${folder._id}">
                        <summary class="flex items-center p-2 rounded hover:bg-gray-700 cursor-pointer text-sm">
                            <i data-feather="folder" class="w-4 h-4 mr-2"></i>
                            <span class="font-semibold flex-1 truncate">${folder.name}</span>
                        </summary>
                        <div class="pl-4 article-list">
                            ${articlesInFolder.map(article => createArticleTreeItem(article)).join('')}
                        </div>
                    </details>
                `;
                tree.appendChild(folderEl.firstElementChild);
            });

            // 渲染未分类文章
            const uncategorizedArticles = appState.articles.filter(a => !a.folder_id);
            if(uncategorizedArticles.length > 0) {
                 const uncategorizedEl = document.createElement('div');
                 uncategorizedEl.innerHTML = `
                    <div class="mt-4">
                        <h4 class="px-2 text-xs font-bold text-gray-400 uppercase">未分类</h4>
                        <div class="mt-1">
                             ${uncategorizedArticles.map(article => createArticleTreeItem(article)).join('')}
                        </div>
                    </div>
                 `;
                 tree.appendChild(uncategorizedEl.firstElementChild);
            }
           
            feather.replace(); // 重新渲染图标
        }

        function createArticleTreeItem(article) {
             const icon = article.type === 'pdf' ? 'file' : 'file-text';
             const isDraft = appState.localDrafts[article._id] && new Date(appState.localDrafts[article._id].timestamp) > new Date(article.updated_at);
             return `
                <div class="article-item flex items-center p-2 rounded hover:bg-gray-700 cursor-pointer" data-id="${article._id}">
                    <i data-feather="${icon}" class="w-4 h-4 mr-2 flex-shrink-0"></i>
                    <div class="flex-1 truncate">
                        <span class="text-sm">${article.title}</span>
                        <div class="text-xs text-gray-400">${new Date(article.updated_at).toLocaleDateString()}</div>
                    </div>
                    <i data-feather="alert-circle" class="w-4 h-4 text-orange-400 ml-1 draft-indicator ${isDraft ? '' : 'hidden'}" title="有未保存的草稿"></i>
                </div>
            `;
        }

        // --- 10.3 文章内容渲染 ---
        function selectArticle(articleId) {
            const article = appState.articles.find(a => a._id === articleId);
            if (!article) return;
            
            // 检查当前文章是否有未保存的更改
            if (appState.isEditorDirty) {
                if(!confirm('当前文章有未保存的修改，确定要切换吗？')) {
                    return;
                }
            }

            appState.currentArticle = article;
            appState.editingArticle.id = article._id;
            appState.editingArticle.lastKnownVersion = new Date(article.updated_at).getTime();
            
            DOMElements.welcomeView.classList.add('hidden');
            DOMElements.articleView.classList.remove('hidden');
            DOMElements.articleActions.classList.remove('hidden');
            DOMElements.articleTitleHeader.textContent = article.title;
            
            // 更新文件树选中状态
            document.querySelectorAll('.article-item.bg-gray-600').forEach(el => el.classList.remove('bg-gray-600'));
            document.querySelector(`.article-item[data-id="${articleId}"]`)?.classList.add('bg-gray-600');

            if (article.type === 'text') {
                loadRichTextContent(article);
            } else if (article.type === 'pdf') {
                loadPdfContent(article);
            }
        }
        
        function loadRichTextContent(article) {
            DOMElements.richtextEditorView.classList.remove('hidden');
            DOMElements.pdfReaderView.classList.add('hidden');
            DOMElements.pdfControls.classList.add('hidden');
            DOMElements.editBtn.classList.add('hidden');
            DOMElements.saveBtn.classList.remove('hidden');
            
            // 检查本地草稿
            const draft = appState.localDrafts[article._id];
            if (draft && new Date(draft.timestamp) > new Date(article.updated_at)) {
                quill.setContents(draft.content);
                showToast('已加载本地的未保存草稿', 'info');
                appState.isEditorDirty = true;
                DOMElements.saveBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            } else {
                quill.setContents(article.content ? JSON.parse(article.content) : '');
                appState.isEditorDirty = false;
                DOMElements.saveBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            }
        }

        function loadPdfContent(article) {
            DOMElements.richtextEditorView.classList.add('hidden');
            DOMElements.pdfReaderView.classList.remove('hidden');
            DOMElements.pdfControls.classList.remove('hidden');
            DOMElements.editBtn.classList.add('hidden');
            DOMElements.saveBtn.classList.add('hidden');
            
            const url = article.content;
            const loadingTask = pdfjsLib.getDocument(url);
            loadingTask.promise.then(pdf => {
                appState.pdfDoc = pdf;
                appState.pdfPageNum = 1;
                renderPdfPage(appState.pdfPageNum);
            });
        }
        
        function renderPdfPage(num) {
            appState.pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale: 1.5 });
                const canvas = DOMElements.pdfCanvas;
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                page.render(renderContext);
            });
            DOMElements.pdfPageInfo.textContent = `第 ${num} / ${appState.pdfDoc.numPages} 页`;
        }

        // --- 10.4 弹窗和提示 ---
        function showToast(message, type = 'info', duration = 3000) {
            const toast = DOMElements.toast;
            DOMElements.toastMessage.textContent = message;
            toast.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'bg-blue-500', 'translate-x-full');
            
            switch (type) {
                case 'success': toast.classList.add('bg-green-500'); break;
                case 'error': toast.classList.add('bg-red-500'); break;
                case 'warning': toast.classList.add('bg-yellow-500'); break;
                default: toast.classList.add('bg-blue-500'); break;
            }

            toast.classList.remove('translate-x-full');
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, duration);
        }

        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
            DOMElements.modalOverlay.classList.remove('hidden');
        }

        function hideAllModals() {
            DOMElements.creationRenameModal.classList.add('hidden');
            DOMElements.moveModal.classList.add('hidden');
            DOMElements.confirmModal.classList.add('hidden');
            DOMElements.modalOverlay.classList.add('hidden');
        }

        function showCreationRenameModal(type, targetId = null) {
            const isCreating = !targetId;
            const isFolder = type.includes('folder');
            
            DOMElements.modalTitle.textContent = isCreating ? (isFolder ? '新建文件夹' : '新建文章') : (isFolder ? '重命名文件夹' : '重命名文章');
            
            if (isCreating && !isFolder) { // 新建文章
                DOMElements.modalFolderSelectWrapper.classList.remove('hidden');
                DOMElements.modalFolderSelect.innerHTML = '<option value="">未分类</option>';
                appState.folders.forEach(f => {
                    const option = document.createElement('option');
                    option.value = f._id;
                    option.textContent = f.name;
                    DOMElements.modalFolderSelect.appendChild(option);
                });
            } else {
                DOMElements.modalFolderSelectWrapper.classList.add('hidden');
            }
            
            DOMElements.modalInput.value = isCreating ? '' : (isFolder ? appState.folders.find(f=>f._id===targetId).name : appState.articles.find(a=>a._id===targetId).title);
            
            DOMElements.modalConfirmBtn.onclick = () => {
                const name = DOMElements.modalInput.value.trim();
                if (!name) return;
                
                if (isCreating) {
                    if (isFolder) createFolder(name);
                    else createArticle(name, DOMElements.modalFolderSelect.value);
                } else {
                    if (isFolder) renameFolder(targetId, name);
                    else renameArticle(targetId, name);
                }
                hideAllModals();
            };
            
            showModal(DOMElements.creationRenameModal);
            DOMElements.modalInput.focus();
        }
        
        function showMoveModal(articleId) {
            const select = DOMElements.moveFolderSelect;
            select.innerHTML = '<option value="">未分类</option>';
            appState.folders.forEach(f => {
                const option = document.createElement('option');
                option.value = f._id;
                option.textContent = f.name;
                select.appendChild(option);
            });
            DOMElements.moveConfirmBtn.onclick = () => {
                moveArticle(articleId, select.value);
                hideAllModals();
            };
            showModal(DOMElements.moveModal);
        }
        
        function showConfirmModal(title, message, onConfirm) {
            DOMElements.confirmTitle.textContent = title;
            DOMElements.confirmMessage.textContent = message;
            DOMElements.confirmOkBtn.onclick = () => {
                onConfirm();
                hideAllModals();
            };
            showModal(DOMElements.confirmModal);
        }
        
        function showContextMenu(e, type, id) {
            e.preventDefault();
            const menu = DOMElements.contextMenu;
            menu.innerHTML = '';
            menu.style.top = `${e.clientY}px`;
            menu.style.left = `${e.clientX}px`;

            let items = [];
            if (type === 'folder') {
                items = [
                    { label: '重命名', icon: 'edit', action: () => showCreationRenameModal('rename_folder', id) },
                    { label: '删除', icon: 'trash-2', action: () => showConfirmModal('删除文件夹?', '确定要删除此文件夹及其中的所有文章吗？此操作无法撤销。', () => deleteFolder(id)) },
                ];
            } else if (type === 'article') {
                 items = [
                    { label: '重命名', icon: 'edit', action: () => showCreationRenameModal('rename_article', id) },
                    { label: '移动到...', icon: 'move', action: () => showMoveModal(id) },
                    { label: '删除', icon: 'trash-2', action: () => showConfirmModal('删除文章?', '确定要删除这篇文章吗？此操作无法撤销。', () => deleteArticle(id)) },
                ];
            }

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer';
                el.innerHTML = `<i data-feather="${item.icon}" class="w-4 h-4 mr-2"></i><span>${item.label}</span>`;
                el.onclick = () => {
                    item.action();
                    menu.classList.add('hidden');
                };
                menu.appendChild(el);
            });
            
            feather.replace();
            menu.classList.remove('hidden');
        }

        // =================================================================
        // XI. 高级功能 (Advanced Features)
        // =================================================================

        // --- 11.1 本地草稿 ---
        function saveLocalDraft(articleId, content) {
            appState.localDrafts[articleId] = {
                content,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('localDrafts', JSON.stringify(appState.localDrafts));
            // 更新UI提示
            document.querySelector(`[data-id='${articleId}'] .draft-indicator`)?.classList.remove('hidden');
        }

        function loadLocalDrafts() {
            const drafts = localStorage.getItem('localDrafts');
            if (drafts) {
                appState.localDrafts = JSON.parse(drafts);
            }
        }
        
        function deleteLocalDraft(articleId) {
            delete appState.localDrafts[articleId];
            localStorage.setItem('localDrafts', JSON.stringify(appState.localDrafts));
        }

        // --- 11.2 Quill 图片上传处理 ---
        function imageHandler() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = async () => {
                const file = input.files[0];
                if (file) {
                    showToast('正在上传图片...', 'info');
                    try {
                        const url = await uploadFileToCOS(file, 'images');
                        const range = quill.getSelection(true);
                        quill.insertEmbed(range.index, 'image', url);
                        quill.setSelection(range.index + 1);
                        showToast('图片上传成功', 'success');
                    } catch (error) {
                        showToast('图片上传失败', 'error');
                    }
                }
            };
        }
        
        // --- 11.3 单文章导出 ---
        function exportArticleAsTxt() {
            if (!appState.currentArticle) return;
            const text = quill.getText();
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${appState.currentArticle.title}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportArticleAsPdf() {
            if (!appState.currentArticle) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const editor = document.querySelector('.ql-editor');
            
            showToast('正在生成PDF...', 'info');

            html2canvas(editor, {
                useCORS: true,
                scale: 2 // 提高分辨率
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgProps= doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth() - 20; // 留出边距
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                doc.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
                doc.save(`${appState.currentArticle.title}.pdf`);
                showToast('PDF导出成功', 'success');
            }).catch(err => {
                showToast('PDF导出失败', 'error');
                console.error(err);
            });
        }

        // =================================================================
        // XII. 事件监听器 (Event Listeners)
        // =================================================================
        function setupEventListeners() {
            // --- 认证视图 ---
            DOMElements.showLoginBtn.addEventListener('click', () => toggleAuthForms('login'));
            DOMElements.showRegisterBtn.addEventListener('click', () => toggleAuthForms('register'));
            DOMElements.loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleLogin(e.target['login-email'].value, e.target['login-password'].value);
            });
            DOMElements.registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleRegister(e.target['register-email'].value, e.target['register-password'].value);
            });
            DOMElements.logoutBtn.addEventListener('click', handleLogout);

            // --- 侧边栏 ---
            DOMElements.newFolderBtn.addEventListener('click', () => showCreationRenameModal('create_folder'));
            DOMElements.newArticleBtn.addEventListener('click', () => showCreationRenameModal('create_article'));
            DOMElements.fileTree.addEventListener('click', (e) => {
                const articleItem = e.target.closest('.article-item');
                if (articleItem) {
                    selectArticle(articleItem.dataset.id);
                }
            });
            DOMElements.fileTree.addEventListener('contextmenu', e => {
                const folderItem = e.target.closest('.folder-item');
                const articleItem = e.target.closest('.article-item');
                if (articleItem) showContextMenu(e, 'article', articleItem.dataset.id);
                else if (folderItem) showContextMenu(e, 'folder', folderItem.dataset.id);
            });
            
            // --- 数据管理 ---
            DOMElements.importPdfWrapper.addEventListener('click', () => DOMElements.importPdfInput.click());
            DOMElements.importPdfInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) handlePDFImport(e.target.files[0]);
            });
            DOMElements.importBackupWrapper.addEventListener('click', () => DOMElements.importBackupInput.click());
            DOMElements.importBackupInput.addEventListener('change', e => {
                 if (e.target.files.length > 0) handleImportBackup(e.target.files[0]);
            });
            DOMElements.exportBackupBtn.addEventListener('click', handleExportBackup);
            
            // --- 主内容区头部 ---
            DOMElements.saveBtn.addEventListener('click', () => {
                if (appState.currentArticle) {
                    updateArticle(appState.currentArticle._id, appState.currentArticle.title, JSON.stringify(quill.getContents()));
                }
            });
            DOMElements.exportTxtBtn.addEventListener('click', exportArticleAsTxt);
            DOMElements.exportPdfBtn.addEventListener('click', exportArticleAsPdf);
            DOMElements.sidebarToggle.addEventListener('click', () => {
                 DOMElements.sidebar.classList.toggle('-translate-x-full');
            });
            
            // --- PDF 控制 ---
            DOMElements.pdfPrev.addEventListener('click', () => {
                if (appState.pdfPageNum <= 1) return;
                appState.pdfPageNum--;
                renderPdfPage(appState.pdfPageNum);
            });
             DOMElements.pdfNext.addEventListener('click', () => {
                if (appState.pdfPageNum >= appState.pdfDoc.numPages) return;
                appState.pdfPageNum++;
                renderPdfPage(appState.pdfPageNum);
            });

            // --- 弹窗/菜单关闭 ---
            DOMElements.modalCancelBtn.addEventListener('click', hideAllModals);
            DOMElements.moveCancelBtn.addEventListener('click', hideAllModals);
            DOMElements.confirmCancelBtn.addEventListener('click', hideAllModals);
            DOMElements.modalOverlay.addEventListener('click', hideAllModals);
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#context-menu')) {
                    DOMElements.contextMenu.classList.add('hidden');
                }
            });
            
            // --- Quill 编辑器 ---
            let draftSaveTimeout;
            quill.on('text-change', (delta, oldDelta, source) => {
                if (source === 'user') {
                    appState.isEditorDirty = true;
                    DOMElements.saveBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    
                    // Debounce saving to local storage
                    clearTimeout(draftSaveTimeout);
                    draftSaveTimeout = setTimeout(() => {
                        if (appState.currentArticle) {
                            saveLocalDraft(appState.currentArticle._id, quill.getContents());
                        }
                    }, 1000);
                }
            });
        }
    });
    </script>
</body>
</html>